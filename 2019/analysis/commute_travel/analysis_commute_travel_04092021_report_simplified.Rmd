---
title: 'Household Travel Survey: Commuting Data'
author: "Suzanne Childress & Mary Richards"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_depth: 6
    toc_float: true
  word_document: default
  pdf_document: default
---
```{r global-options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting
```

```{r libraries, include=FALSE}
# source('travel_survey_analysis_functions.R')
library(tidyverse)
library(openxlsx)
library(odbc)
library(DBI)
library(dplyr)
library(ggplot2)

library(table1)
library(knitr)
library(kableExtra)
library(summarytools)
library(formattable)
library(ggpubr) #boxplots
library(car) #Levene's test
```

```{r functions, include=FALSE}
# connecting to Elmer
db.connect <- function() {
  elmer_connection <- dbConnect(odbc(),
                                driver = "SQL Server",
                                server = "AWS-PROD-SQL\\Sockeye",
                                database = "Elmer",
                                trusted_connection = "yes"
  )
}

# a function to read tables and queries from Elmer
read.dt <- function(astring, type =c('table_name', 'sqlquery')) {
  elmer_connection <- db.connect()
  if (type == 'table_name') {
    dtelm <- dbReadTable(elmer_connection, SQL(astring))
  } else {
    dtelm <- dbGetQuery(elmer_connection, SQL(astring))
  }
  dbDisconnect(elmer_connection)
  dtelm
}

# Create a simplified crosstab from one variable, calculate counts, totals, shares, and MOE for categorical data
create_table_one_var_simp= function(var1, table_temp, table_type) {
  #table_temp = recategorize_var_upd(var2,table_temp)
  #print(table_temp)
  if (table_type == "household" | table_type == "person" ) {
    weight_2017 = "hh_wt_revised"
    weight_2019 = "hh_wt_2019"
    weight_comb = "hh_wt_combined"
  } else if (table_type == "trip") {
    weight_2017 = "trip_weight_revised"
    weight_2019 = "trip_wt_2019"
    weight_comb = "trip_wt_combined"  
  } 
  
  temp = table_temp %>% 
    dplyr::select(!!sym(var1), all_of(weight_2019)) %>% 
    filter(!.[[1]] %in% missing_codes, !is.na(.[[1]])) %>% 
    group_by(!!sym(var1)) %>% 
    summarise(SampleSize=n(),
              Weighted_2019 = sum(.data[[weight_2019]],na.rm = TRUE), 
              Weighted_2019 = round(Weighted_2019, 0)) %>% 
    mutate(WeightedPercent = Weighted_2019/sum(Weighted_2019)*100, 
           WeightedPercent = round(WeightedPercent, 2)) %>% 
    ungroup() %>%  
    mutate(MOE=1.65*(0.25/sum(SampleSize))^(1/2)*100, 
           MOE=round(MOE, 2)) %>% 
    arrange(var1)
  return(temp)
}

# Create a crosstab from two variables, calculate counts, totals, and shares for categorical data
cross_tab_categorical <- function(table, var1, var2, wt_field) {
  expanded <- table %>% 
    group_by(.data[[var1]],.data[[var2]]) %>%
    dplyr::summarize(Count= n(),Total=sum(.data[[wt_field]])) %>%
    group_by(.data[[var1]])%>%
    mutate(Percentage=Total/sum(Total)*100)
  
  
  expanded_pivot <-expanded%>%
    pivot_wider(names_from=.data[[var2]], values_from=c(Percentage,Total, Count))
  
  return (expanded_pivot)
  
} 

# Create margins of error for dataset
categorical_moe <- function(sample_size_group){
  sample_w_MOE<-sample_size_group %>%
    mutate(p_col=p_MOE) %>%
    mutate(MOE_calc1= (p_col*(1-p_col))/sample_size) %>%
    mutate(MOE_Percent=z*sqrt(MOE_calc1)*100)
  
  sample_w_MOE<- dplyr::select(sample_w_MOE, -c(p_col, MOE_calc1))
  
  return(sample_w_MOE)
}

# create table with bivariate analysis stats
bivariate_Pvalue <- function(outcome, explanatory){
  model_output <- polr(as.factor(outcome) ~ explanatory, Hess=T)
  ctable <- coef(summary(model_output))
  # calculate and store p values
  p <- pnorm(abs(ctable[,"t value"]), lower.tail = F)*2
  p_round <- round(pnorm(abs(ctable[,"t value"]), lower.tail = F)*2,4)
  #odds ratio
  oddsratio <- round(exp(coef(model_output)),4)
  #combine elements
  ctable <- cbind(round(ctable,4), "p-value"=p, "simp p."=p_round, "odds ratio"=oddsratio)
  return(ctable)
}

# create stargazer table
stargazer_table <- function(outcome, explanatory, table_title){
  stargazer::stargazer(
    polr(as.factor(outcome) ~ explanatory, Hess=T), type = "html",
                      title =  table_title,
                      notes.append =  FALSE, 
                      notes =  c("<sup>&sstarf;</sup>p<0.1; <sup>&sstarf;&sstarf;</sup>p<0.05; <sup>&sstarf;&sstarf;&sstarf;</sup>p<0.01"))

}

# Confidence Interval for mean = sample mean + Z-value for confidence level(sample st. dev/sqrt(number of elements in sample))

Mean.SD_CI <- function(x, cat_var, num_var, weight_var){
  cat_var <- enquo(cat_var)
  num_var <- enquo(num_var)
  weight_var = enquo(weight_var)

  Mean.SD_CI_table <- x %>%
    group_by(!!cat_var) %>%
    summarize(Group_weight = round(sum(!!weight_var),0),
              Weighted_percent = (round(Group_weight/sum(x$hh_wt_2019),4)),
              Weighted_avg = round(weighted.mean(!!num_var, !!weight_var),2),
              sd = round(sd(!!num_var),2),
              se = round(sd/sqrt(n()),2),
              CI_90 = round(z*(sd/sqrt(n())),2),
              CI_95 = round(z_95*(sd/sqrt(n())),2),
              n=n())
    
  # return(Mean.SD_CI_temp)
  Mean.SD_CI_temp<- dplyr::select(Mean.SD_CI_table, -c(n))
  # return(Mean.SD_CI_temp)
  
  # to include sample size column in table
  # return(Mean.SD_CI_table)
  
  # create formatted output table
  table.formattable <<- formattable(Mean.SD_CI_table,
                                   list(area(col=c(2,9))~mycomma(digits=0),
                                        Weighted_percent=percent),
                                   align=c("l", rep("c", NCOL(Mean.SD_CI_table))),
                                   col.names=c("Variable", "2019 Estimate", 
                                               "2019 Percent", "2019 Average", 
                                               "SD", "SE", "CI 90%", "CI 95%", 
                                               "Sample Size"))
}

# adding commas to numbers - thousand separator 
mycomma <- function(digits = 0) {
      formatter("span", x ~ comma(x, digits = digits)
      )
    }

# rounding function applied to categorical columns 
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%.0f%%)", FREQ, PCT))))}


# plot weighted average of numerical variable
plot.weighted_avg <- function(df, cat_var, num_var, weight_var,
                       title_label, x.axis_label, y.axis_label){
  cat_var <- enquo(cat_var)
  num_var <- enquo(num_var)
  weight_var <- enquo(weight_var)
  
  # set up data frame
  temp.df <- df %>%
    select(.data[[cat_var]], .data[[num_var]], .data[[weight_var]]) %>%
    group_by(.data[[cat_var]])
  
  temp2.df <- temp.df %>%
    summarize(n=n(),
              Weighted_avg = round(weighted.mean(.data[[num_var]], .data[[weight_var]]),2),
              sd = round(sd(.data[[num_var]]),3),
              CI_90 = round(z*(sd/sqrt(n)),3),
              CI_95 = round(z_95*(sd/sqrt(n)),3))
  
  # return(temp2.df)
  
  # plot
  ggplot(temp2.df, aes(x=!!cat_var, y=Weighted_avg)) + 
  geom_col() +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1)) +
  labs(title=title_label,
       x =x.axis_label, 
       y =y.axis_label) +
  geom_errorbar(aes(ymin=Weighted_avg-CI_95, 
                    ymax=Weighted_avg+CI_95), 
                width=.2,
                position=position_dodge(.9))
}

# Statistical assumptions for margins of error
p_MOE <- 0.5
z <- 1.645 #90% CI
z_95 <- 1.96 #95% CI
missing_codes <- c('Missing: Technical Error', 'Missing: Non-response', 
                   'Missing: Skip logic', 'Children or missing', 'Prefer not to answer',
                   'Missing')
```

```{r read in and set up data}
#### Read in Data ####
#where you are running your R code
wrkdir <- "C:/Users/mrichards/Documents/GitHub/travel-studies/2019/analysis"


#where you want to output tables
file_loc <- 'C:/Users/mrichards/Documents/GitHub/travel-studies/2019/analysis/commute_travel/outputs'

sql.trip.query <- paste("SELECT hhincome_detailed, race_category, person_dim_id, mode_simple,
                        survey_year, o_purpose, d_purpose, trip_wt_2019 
                        FROM HHSurvey.v_trips_2017_2019")

trips <- read.dt(sql.trip.query, 'sqlquery')
trips_2019 <- trips %>% filter(survey_year==2019)

sql.person.query <- paste("SELECT employment, hhincome_detailed, hhincome_broad, hhsize, race_category, person_dim_id, gender, age, age_category, education, vehicle_count, rent_own, commute_auto_time,commute_auto_Distance, mode_freq_1,  mode_freq_2,  mode_freq_3, mode_freq_4, mode_freq_5, workplace, survey_year, sample_county, work_county,telecommute_freq, hh_wt_2019 FROM HHSurvey.v_persons_2017_2019")

persons<-read.dt(sql.person.query, 'sqlquery')
persons_2019 <- persons  %>% filter(survey_year==2019)
```

This report presents preliminary findings for commuting trends based on the 2019 Household Travel Survey (HTS), a survey conducted every other year to determine travel patterns for individuals living within PSRC's four-county jurisdiction.
\
\
The main area of focus for this report:  
<span style="color:#91268F">**How does the distance or commute time from home to your primary workplace vary by income and race?**</span> 
\
\


## Defining the Variables
### *Commuting Trips*
This analysis will focus on the commute trips of people who usually work outside the home. 

Commute trips will be defined as those where one of the trip ends is a regular workplace - based on the survey logic, the origin or destination purpose is 'Went to primary workplace'
```{r, include=FALSE}
## SURVEY
survey_trips <- nrow(trips_2019) # 72,855

# filter to commute trips made by people who work outside the home usually
commute_trips <- trips_2019 %>%
  filter(o_purpose=='Went to primary workplace' | d_purpose=='Went to primary workplace')

survey_commute_trips <- nrow(commute_trips) # 14,501

survey_commute_trips/survey_trips #0.199

## WEIGHTED
trips_total <- sum(trips_2019$trip_wt_2019) #17,813,956

trips_commute <- trips_2019 %>% 
  filter(o_purpose=='Went to primary workplace' | d_purpose=='Went to primary workplace') %>%
  summarize(commute_trips=sum(trip_wt_2019)) 

trips_commute <- commute_trips %>% 
  summarize(weighted_commute_trips=sum(trip_wt_2019))
# 4,189,078	

trips_commute/trips_total # 24%
```
Based on the total number of trips (72,855) documented as part of the 2019 survey results, 20% (14,501) were recorded as being commute trips. When trip weights are taken into consideration, <span style="color:#F05A28">**24% of the trips in the region are for commuting**</span>. 
\
\
<span style="color:#999999">*Compared to national data:*  
This value reflects a slightly different finding compared to the 2017 National Household Travel Survey (NHTS). In ["Summary of Travel Trends"](https://nhts.ornl.gov/assets/2017_nhts_summary_travel_trends.pdf) Based on Table 5c (p. 18), approximately 17% of average annual person trips are to travel to or from work (546 out of 3,140). These trips include those taken on the weekends, defined by the [2009 NHTS documentation](https://nhts.ornl.gov/2009/pub/Weekday%20Travel%20FAQ.pdf) as "travel began at 6pm on Friday and ran through Saturday and all day Sunday." 
\
\
For trips made on weekdays, 23% of trips are related to work (trip purpose = to/from work and work-related, based on 1990 NPTS design, *WHYTRP90*) or 15% (based on trip destination purpose, *WHYTO*, or trip purpose summary, *WHYTRP1S*). This disparity may be due to survey design - these latter variables include "home" as a destination purpose and these "home" trips are approximately 35% of all weekday trips. 
\
\
Based on Table 6c (p. 22), households annually make an average of 450 vehicle trips to/from work out of a total of 1,865 trips for all purposes, or 24%.</span>
\
\

### *Commuters*
This subset of the respondents are based on the following survey questions: 

* **"Primary type of employment?"** 
* **"Please answer for your primary jobs where you work the most hours per week"**
    + "Usual work location?"
\

For this analysis, commuters are those with: 

1. full-time or part-time paid employment or those who identified as self-employed with workplaces.  
2. workplaces that are not at home  
3. commute distances less than 200 miles
\
\

```{r}
workers <- persons_2019 %>% 
  filter(employment=='Employed full time (35+ hours/week, paid)'|
           employment=='Employed part time (fewer than 35 hours/week, paid)'|
           employment=='Self-employed')

not_home_workers <- workers %>% 
  filter(workplace!='At home (telecommute or self-employed with home office)') %>%
  filter(commute_auto_Distance<200)

table_employment <- not_home_workers %>%
  group_by(employment) %>%
  summarize(n=n(),
            Weighted_2019=round(sum(hh_wt_2019))) %>%
  mutate(Weighted_Percent=(round(Weighted_2019/sum(not_home_workers$hh_wt_2019),4)))

formattable(table_employment,
            list(area(col=c(2:NCOL(table_employment)))~mycomma(digits=0),
                 Weighted_Percent=percent),
            align=c("l", "c", "c", "c"),
            col.names=c("Employment", "Sample Size", "2019 Estimate", "2019 Percent"))

table_workplace <- not_home_workers %>%
  group_by(workplace) %>%
  summarize(n=n(),
            Weighted_2019=round(sum(hh_wt_2019))) %>%
  mutate(Weighted_Percent=(round(Weighted_2019/sum(not_home_workers$hh_wt_2019),4)))

formattable(table_workplace,
            list(area(col=c(2:NCOL(table_employment)))~mycomma(digits=0),
                 Weighted_Percent=percent),
            align=c("l", "c", "c", "c"),
            col.names=c("Workplace", "Sample Size", "2019 Estimate", "2019 Percent"))
```
\
Out of a total 5,711 people who responded to the 2019 travel survey, there were **2,704** individuals employed outside of the home who commute by automobile less than 200 miles (more information about the full range of employment/workplace responses is located at the end of the report in <a href="##Background: Sample">Background: Sample</a>). The commute distance limit was intended to remove outliers.
\
\
<span style="color:#F05A28">**These individuals represent approximately 39% of the people in the region.**</span>
\
\

## General commute statistics
### Methodology
Commute travel times and distances were found using the [Google Distance Matrix API](https://developers.google.com/maps/documentation/distance-matrix/overview).  Survey respondents reported home locations and work locations for all household workers. Google travel time and distance data were pulled from the API given these locations, assuming an 8am travel time in April of 2019.
\
\

### **Commute distance**
```{r}
mean_dist<-weighted.mean(not_home_workers$commute_auto_Distance,
                         w=not_home_workers$hh_wt_2019,na.rm=TRUE)

ggplot(not_home_workers, aes(x=commute_auto_Distance, weight=hh_wt_2019)) + 
  geom_histogram(fill="#00A7A0", binwidth=2)+xlim(c(0, 50)) +
  geom_vline(xintercept=mean_dist) +
  labs(title="Distribution of 2019 Commute Distances (from the HTS)",
      x ="Commute Distance (miles)", y = "Number of Workers (Region)")
```
\
<span style="color:#A9D46E">_The vertical line at x=**13.97 miles** represents the average distance traveled by workers_</span>
\
\

*Share of workers in the region with auto commutes*
```{r}
not_home_workers <- not_home_workers %>%
  mutate(dist_bins = case_when(commute_auto_Distance<3 ~ "<3 miles (very short)",
                               commute_auto_Distance>=3 &
                                 commute_auto_Distance<10 ~ "3-10 miles (short)",
                               commute_auto_Distance>=10 &
                                 commute_auto_Distance<20 ~ "10-20 miles (average)",
                               commute_auto_Distance>=20 &
                                 commute_auto_Distance<50 ~ "20-50 miles (long)",
                               commute_auto_Distance>=50 ~ "50+ miles (very long)"))

not_home_workers$dist_bins <- factor(not_home_workers$dist_bins,
                               levels=c("<3 miles (very short)","3-10 miles (short)","10-20 miles (average)",
                                        "20-50 miles (long)","50+ miles (very long)"))

distance_workers <- not_home_workers %>%
  group_by(dist_bins) %>%
  summarise(HouseholdWeight=round(sum(hh_wt_2019)),
            WeightedPercent=round(HouseholdWeight/sum(not_home_workers$hh_wt_2019),4),
            WeightedAvg=round(weighted.mean(commute_auto_Distance,
                         w=hh_wt_2019,na.rm=TRUE),2),
            min=min(commute_auto_Distance), 
            max=max(commute_auto_Distance),
            SampleSize=n(),
            SamplePercent=round(SampleSize/nrow(not_home_workers),4))

formattable(distance_workers,
            list(area(col=c(2, 5:6))~mycomma(digits=0),
                 WeightedPercent=percent,
                 SamplePercent=percent),
            align=c("l", rep("c", NCOL(distance_workers))),
            col.names=c("Distance", "2019 Estimate", "2019 Percent", "2019 Average", "Minimum", "Maximum", "Sample Size", "Sample Percent"))
```
\
\

#### 1. Income
```{r}
# reorder detailed income categories
not_home_workers$hhincome_detailed <- factor(not_home_workers$hhincome_detailed,
                                             levels=c("Under $10,000",
                                                      "$10,000-$24,999",
                                                      "$25,000-$34,999",
                                                      "$35,000-$49,999",
                                                      "$50,000-$74,999",
                                                      "$75,000-$99,999",
                                                      "$100,000-$149,999",
                                                      "$150,000-$199,999",
                                                      "$200,000-$249,999",
                                                      "$250,000 or more",
                                                      "Prefer not to answer"))
```
Lower income workers tend to have shorter commutes.  For example, workers with incomes between $10,000 and $24,999 have commutes that are about 7 miles, while workers with incomes between $75,000 and $99,999 have commutes that are about 15 miles. The average travel distance to work is highest for workers in the $150,000-$199,999 income bracket - about 18 miles - with those in higher income brackets having shorter commutes about 15 miles.
\
\

```{r distance income with sample CI}
dist_income_stats <- Mean.SD_CI(not_home_workers, hhincome_detailed, commute_auto_Distance, hh_wt_2019)

plot.weighted_avg(not_home_workers, hhincome_detailed, commute_auto_Distance, hh_wt_2019,
                  "Average Auto Commute Distance by Income",
                  "Income Categories", "Average Commute Distance (miles)")
```
\
\
*The average commuting distance (miles) by income*
```{r}
table.formattable
```
\
\

#### 2. Race
```{r}
# reorder race categories
not_home_workers$race_category <- 
  factor(not_home_workers$race_category,
         levels=c("African American",
                  "Asian",
                  "Hispanic",
                  "White Only",
                  "Other",
                  "Missing"))
```
People who identify as White Only have the farthest commutes (15 miles). The margins of error for African American and Hispanic groups are relatively large due to the small sample sizes. 
\
\

```{r dist race with sample CI}
dist_race_stats <- Mean.SD_CI(not_home_workers, race_category, commute_auto_Distance, hh_wt_2019)

plot.weighted_avg(not_home_workers, race_category, commute_auto_Distance, hh_wt_2019,
                  "Average Auto Commute Distance by Race",
                  "Race Categories",
                  "Average Weighted Distance (miles)")
```
\
\
*The average commuting distance by race*
```{r}
table.formattable
```
\
\

##### Aggregated Race
Because of small sample sizes, some of the respondents have been aggregated. For this analysis, respondents who identified as African American, Hispanic, and Other were aggregated.
\
\

<span style="color:#91268F">**African American, Hispanic, and Other**</span>  
```{r}
# reorder race categories
not_home_workers$race_category <- as.character(not_home_workers$race_category)
not_home_workers <- not_home_workers %>%
  mutate(race_agg_2 = case_when(race_category=="African American" |
                                  race_category=="Hispanic" |
                                  race_category=="Other" ~ "Other POC",
                                race_category=="Asian" ~ "Asian POC",
                                TRUE~.$race_category))

not_home_workers$race_agg_2 <- factor(not_home_workers$race_agg_2,
                                      levels=c("Asian POC",
                                               "Other POC",
                                               "White Only",
                                               "Missing"))
```
People who identify as African American, Hispanic, or Other have shorter commutes (11 miles), while White Only individuals have longer commutes (15 minutes).

The margin of error for the Other POC group is distinct from respondents identifying as Asian or White Only.
\
\

```{r dist race_2 with sample CI}
dist_race_stats <- Mean.SD_CI(not_home_workers, race_agg_2, commute_auto_Distance, hh_wt_2019)

plot.weighted_avg(not_home_workers, race_agg_2, commute_auto_Distance, hh_wt_2019,
                  "Average Auto Commute Distance by Race",
                  "Race Categories",
                  "Average Weighted Distance (miles)")
```
\
\
*The average commuting distance by race*
```{r}
table.formattable
```
\
\


#### 3. Gender
```{r, include=FALSE}
# reorder gender categories
not_home_workers$gender <- 
  factor(not_home_workers$gender,
         levels=c("Female",
                  "Male",
                  "Another",
                  "Prefer not to answer"))
```
People who identify as male have the farthest commute (15 miles). Females have shorter commutes (13 miles), and people of another gender or who prefer not to answer do not have enough samples to draw a statistical conclusion. 
\
\

Because of the small sample sizes for respondents identifying as Another or choosing not to answer, these respondents were removed from the graph:   
```{r dist gender with sample CI}
dist_gender_stats <- Mean.SD_CI(not_home_workers, gender, commute_auto_Distance, hh_wt_2019)

temp <- not_home_workers %>%
  filter(gender=="Female" | gender=="Male")

plot.weighted_avg(temp, gender, commute_auto_Distance, hh_wt_2019,
                  "Average Auto Commute Distance by Gender",
                  "Gender Categories",
                  "Average Weighted Distance (miles)")
```
\
\
*The average commuting distance by gender*  
```{r}
table.formattable
```
\
\

#### 4. Housing Tenure  
Although respondents were provided with five housing tenure options, they were simplified based on sample sizes. Those who responded by choosing *Other*, *Prefer not to answer*, *Provided by job or military* were recategorized as "Other."
\
```{r, include=FALSE}
# simplify tenure categories
not_home_workers <- not_home_workers %>% 
  mutate(rent_own_simp = case_when(rent_own == "Prefer not to answer" | 
                                    rent_own == "Other" |
                                    rent_own == "Provided by job or military" ~ "Other",
                                  TRUE~.$rent_own))

not_home_workers$rent_own_simp <- factor(not_home_workers$rent_own_simp, 
                                            levels=c("Own/paying mortgage",
                                                     "Rent",
                                                     "Other"))
```
People who own their homes have a farther commute (15 miles) than those who rent their homes (11 miles). 
\
\

Because of the small sample sizes for respondents categorized as "Other" these respondents were removed from the graph:   
```{r dist tenure with sample CI}
dist_tenure_stats <- Mean.SD_CI(not_home_workers, rent_own_simp, commute_auto_Distance, hh_wt_2019)

temp <- not_home_workers %>%
  filter(rent_own_simp=="Own/paying mortgage" | rent_own_simp=="Rent")

plot.weighted_avg(temp, rent_own_simp, commute_auto_Distance, hh_wt_2019,
                  "Average Auto Commute Distance by Housing Tenure",
                  "Simplified Tenure Categories",
                  "Average Weighted Distance (miles)")
```
\
\
*The average commuting distance by housing tenure*  
```{r}
table.formattable
```
\
\

#### 5. Household Size
Respondents had the option to indicate that their household size includes up to 9 people but because there are so few people with more than 5 people, these households have been combined together into one category for analysis. 
```{r, include=FALSE}
# simplify hh size variable
not_home_workers <- not_home_workers %>%
  mutate(hhsize_simp = case_when(hhsize =="1 person"~ 1,
                                 hhsize =="2 people"~ 2,
                                 hhsize =="3 people"~ 3,
                                 hhsize =="4 people"~ 4,
                                 hhsize =="5 people" |
                                   hhsize =="6 people" |
                                   hhsize =="7 people" |
                                   hhsize =="8 people" |
                                   hhsize =="9 people" ~ 5))
```
There seems to be a slight trend with households of 2 people having slightly farther commute distances, however, the margins of error are large enough that it is difficult to draw statistical conclusions, especially for the larger households (4 and 5+ people). 
\
\

```{r dist hh size with sample CI}
dist_hhsize_stats <- Mean.SD_CI(not_home_workers, hhsize_simp, commute_auto_Distance, hh_wt_2019)

plot.weighted_avg(not_home_workers, hhsize_simp, commute_auto_Distance, hh_wt_2019,
                  "Average Auto Commute Distance by Household Size",
                  "Household Size",
                  "Average Weighted Distance (miles)")
```
\
\
*The average commuting distance by household income per capita*  
```{r}
table.formattable
```
\
\

#### 6. Household Income per capita
##### *A. Income/Household Size*
This measure will be calculated by diving household income (broad) by household size. This requires some data manipulation:

+ Respondents had the option to indicate that their household size includes up to 9 people but because there are so few people with more than 5 people, these households have been combined together into one category for analysis. 
+ Because household income is not a continuous variable but categorical, these different income categories will be assigned an income value in the middle of the range. 
```{r, include=FALSE}
# convert categorical income categories into numeric
not_home_workers <- not_home_workers %>%
  mutate(hhincome_broad_mid = case_when(hhincome_broad == "Under $25,000" ~ "25000",
                                        hhincome_broad == "$25,000-$49,999" ~ "37500",
                                        hhincome_broad == "$50,000-$74,999" ~ "62500",
                                        hhincome_broad == "$75,000-$99,999" ~ "87500",
                                        hhincome_broad == "$100,000 or more" ~ "100000",
                                        hhincome_broad == "Prefer not to answer" ~ "NA"))
not_home_workers$hhincome_broad_mid <- as.numeric(not_home_workers$hhincome_broad_mid)

# calculate household income per capita with simplified variables
not_home_workers <- not_home_workers %>%
  mutate(hhincome_capita= round((hhincome_broad_mid/hhsize_simp),0))
```
It is difficult to draw statistical conclusions based on this calculated variable.  
 
\
\

```{r dist hh income per capita with sample CI}
dist_incomecapita_stats <- Mean.SD_CI(not_home_workers, hhincome_capita, commute_auto_Distance, hh_wt_2019)

plot.weighted_avg(not_home_workers, hhincome_capita, commute_auto_Distance, hh_wt_2019,
                  "Average Auto Commute Distance by Household Income per Capita",
                  "Household Income per Capita",
                  "Average Weighted Distance (miles)")
```
\
\
*The average commuting distance by household income per capita*  
```{r}
table.formattable
```
\
\

##### *B. Income, Households = 1 person*
```{r, include=FALSE}
# reorder household income broad
# not_home_workers$hhincome_broad <- factor(not_home_workers$hhincome_broad,
#                                              levels=c("Under $25,000",
#                                                       "$25,000-$49,999",
#                                                       "$50,000-$74,999",
#                                                       "$75,000-$99,999",
#                                                       "$100,000 or more",
#                                                       "Prefer not to answer"))

# reorder household income detailed
not_home_workers$hhincome_detailed <- factor(not_home_workers$hhincome_detailed,
                                             levels=c("Under $10,000",
                                                      "$10,000-$24,999",
                                                      "$25,000-$34,999",
                                                      "$35,000-$49,999",
                                                      "$50,000-$74,999",
                                                      "$75,000-$99,999",
                                                      "$100,000-$149,999",
                                                      "$150,000-$199,999",
                                                      "$200,000-$249,999",
                                                      "$250,000 or more",
                                                      "Prefer not to answer"))

# isolate group
hh_size_1 <- not_home_workers %>%
  filter(hhsize=="1 person")
```
For households with one person, there is little relationship between income and commute distance.   
 
\
\

```{r dist hh income hhsize1 sample CI}
dist_incomehhsize1_stats <- Mean.SD_CI(hh_size_1, hhincome_detailed, commute_auto_Distance, hh_wt_2019)

plot.weighted_avg(hh_size_1, hhincome_detailed, commute_auto_Distance, hh_wt_2019,
                  "Average Auto Commute Distance by Household Income for Households (1 person)",
                  "Household Income",
                  "Average Weighted Distance (miles)")
```
\
\
*The average commuting distance by household income (household size = 1 person)*  
```{r}
table.formattable
```
\
\

##### *C. Income, Households = 2+ people*
```{r, include=FALSE}
# isolate group
hh_size_2more <- not_home_workers %>%
  filter(hhsize!="1 person")
```
For households with 2 or more people, higher incomes seem to correlate with farther commute distances up to 200K, after which it decreases slightly.
 
\
\

```{r dist hh income hhsize2+ sample CI}
dist_incomehhsize2_stats <- Mean.SD_CI(hh_size_2more, hhincome_detailed, commute_auto_Distance, hh_wt_2019)

plot.weighted_avg(hh_size_2more, hhincome_detailed, commute_auto_Distance, hh_wt_2019,
                  "Average Auto Commute Distance by Household Income for Households (2+ people)",
                  "Household Income",
                  "Average Weighted Distance (miles)")
```
\
\
*The average commuting distance by household income (household size = 2+ people)*  
```{r}
table.formattable
```
\
\



### **Commute duration**
```{r}
mean_time<-weighted.mean(not_home_workers$commute_auto_time,
                         w=not_home_workers$hh_wt_2019,na.rm=TRUE)

ggplot(not_home_workers, aes(x=commute_auto_time, weight=hh_wt_2019)) + 
  geom_histogram(fill="#00A7A0", binwidth=5)+xlim(c(0, 200))+
  scale_x_continuous(breaks=seq(0,200,5))+
  geom_vline(xintercept=mean_time)+
  labs(title="Distribution of 2019 Commute Times (from the HTS)",
       x ="Commute Times (minutes)", y = "Number of Workers (Region)")
```
\
<span style="color:#A9D46E">_The vertical line at x=**29.30 minutes** represents the average commute duration for workers_</span>
\
\

*Share of workers with auto commutes*
```{r}
not_home_workers <- not_home_workers %>%
  mutate(time_bins = case_when(commute_auto_time<10 ~ "<10 minutes",
                               commute_auto_time>=10 &
                                 commute_auto_time<20 ~ "10-20 minutes",
                               commute_auto_time>=20 &
                                 commute_auto_time<30 ~ "20-30 minutes",
                               commute_auto_time>=30 &
                                 commute_auto_time<45 ~ "30-45 minutes",
                               commute_auto_time>=45 &
                                 commute_auto_time<60 ~ "45-60 minutes",
                               commute_auto_time>=60 ~ "60+ minutes"))

time_table <- not_home_workers %>%
  group_by(time_bins) %>%
  summarise(HouseholdWeight=round(sum(hh_wt_2019)),
            WeightedPercent=(round(HouseholdWeight/sum(not_home_workers$hh_wt_2019),4)),
            WeightedAvg=round(weighted.mean(commute_auto_time,
                         w=hh_wt_2019,na.rm=TRUE),2),
            min=min(commute_auto_time), 
            max=max(commute_auto_time),
            SampleSize=n(),
            SamplePercent=round(SampleSize/nrow(not_home_workers),4))

formattable(time_table,
            list(area(col=c(2, 5:6))~mycomma(digits=0),
                 WeightedPercent=percent,
                 SamplePercent=percent),
            align=c("l", rep("c", NCOL(time_table))),
            col.names=c("Time", "2019 Estimate", "2019 Percent", "2019 Average", "Minimum", "Maximum", "Sample Size", "Sample Percent"))
```
\
\

#### 1. Income
The time spent commuting to work increases with income until $75,000, when it stays relatively consistent at aroudn 33 minutes. The average commuting time to work for people in households with incomes between $10,000 and $24,999 is 20 minutes. The average time to work for people in households with incomes between $75,000-$99,999 is approximately 65% longer.
\
\

```{r time income with sample CI}
time_income_stats <- Mean.SD_CI(not_home_workers, hhincome_detailed, commute_auto_time, hh_wt_2019)

plot.weighted_avg(not_home_workers, hhincome_detailed, commute_auto_time, hh_wt_2019,
                  "Average Auto Commute Travel Time by Income",
                  "Income Categories",
                  "Average Commute Time (minutes)")
```
\
\
*The average commuting duration by income*
```{r}
table.formattable
```
\
\

#### 2. Race
African American, Asian, Hispanic, and White Only workers all have commutes around 30 minutes long. Although African Americans appear to have slightly shorter commutes, the margin of error is larger because of the small sample size. People who identify as Other have the shortest commutes at about 18 minutes.  
\
```{r time race with sample CI}
not_home_workers$race_category <- factor(not_home_workers$race_category,
                                        levels = c("African American",
                                                   "Asian",
                                                   "Hispanic",
                                                   "White Only",
                                                   "Other",
                                                   "Missing"))
```

```{r}
time_race_stats <- Mean.SD_CI(not_home_workers, race_category, commute_auto_time, hh_wt_2019)

plot.weighted_avg(not_home_workers, race_category, commute_auto_time, hh_wt_2019,
                  "Average Auto Commute Travel Time by Race",
                  "Race Categories",
                  "Average Commute Time (minutes)")
```
\
\
*The average commuting duration by race*
```{r}
table.formattable
```
\
\

##### Aggregated Race
Because of small sample sizes, some of the respondents have been aggregated. For this analysis, respondents who identified as African American, Hispanic, and Other were aggregated.
\
\

<span style="color:#486CAB">**African American, Hispanic, and Other**</span>  
People who are categorized as Other POC (African American, Hispanic, or Other) have shorter commutes (24 minutes), while Asian POC and White Only individuals have longer commutes (around 30 minutes).

The margin of error for the Other POC group is distinct from respondents identifying as Asian or White Only.
\
\

```{r time race_2 with sample CI}
time_race_stats <- Mean.SD_CI(not_home_workers, race_agg_2, commute_auto_time, hh_wt_2019)

plot.weighted_avg(not_home_workers, race_agg_2, commute_auto_time, hh_wt_2019,
                  "Average Auto Commute Travel Time by Race",
                  "Race Categories",
                  "Average Commute Time (minutes)")
```
\
\
*The average commuting distance by race*  
```{r}
table.formattable
```
\
\


#### 3. Gender
```{r, include=FALSE, eval=FALSE}
# reorder gender categories
not_home_workers$gender <- 
  factor(not_home_workers$gender,
         levels=c("Female",
                  "Male",
                  "Another",
                  "Prefer not to answer")
```
People who identify as male have the longest commutes (31 minutes). Females have shorter commutes (27 minutes), and people of another gender or who prefer not answer do not have enough samples to draw a statistical conclusion. 
\
\

Because of the small sample sizes for respondents identifying as Another or choosing not to answer, these respondents were removed from the graph:  
```{r time gender with sample CI}
time_gender_stats <- Mean.SD_CI(not_home_workers, gender, commute_auto_time, hh_wt_2019)

temp <- not_home_workers %>%
  filter(gender=="Female" | gender=="Male")

plot.weighted_avg(temp, gender, commute_auto_time, hh_wt_2019,
                  "Average Auto Commute Travel Time by Gender",
                  "Gender Categories",
                  "Average Commute Time (minutes)")
```
\
\
*The average commuting distance by gender*
```{r}
table.formattable
```
\
\

### Summary: Commute Trends
```{r, results='asis'}
c1 <- as.data.frame(c(
  "Income",
  "Race",
  "Gender"))
colnames(c1)[1] <- "Socioeconomic Variables"
c2 <- as.data.frame(c(
  "Individuals from lower income households commute fewer miles and their commute times are shorter",
  "Individuals identiying as African American, Hispanic, or Other commute fewer miles and their commute times are shorter; those identifying as White Only travel the farthest and travel time is longest for those identifying as Asian and White Only",
  "Individuals identifying as female commute fewer miles and their commute times are shorter"))
colnames(c2)[1] <- "Commute Distance and Duration"



group_cat <- cbind(c1,c2)

# print table using kable()
kable(group_cat, format = "html",escape = FALSE, align = c('l','l','l')) %>% 
  kable_styling("bordered",full_width = F, position = "left") %>%
  column_spec(1, italic = T)
```
\
\


## Travel Time Trends
Travel time to work has increased in the region since 1980 from about 23 minutes to 32 minutes in 2018. Those living in King County have consistently experienced shorter (or equal) commute times compared to the region. Pierce County residents have experienced the largest increase over time (a change of over 10 minutes).
\
\
```{r}
# Data components
Counties <- c("King", "Kitsap", "Pierce", "Snohomish", "Region")
years <- c(1980,1990,2000,2010,2018)
c <- rep(Counties,5)
y <- rep(years, each=5)
y_1980 <- c(23.0,25.0,21.4,23.5,22.9)
y_1990 <- c(24.2,25.1,24.0,25.4,24.4)
y_2000 <- c(25.3,31.0,27.4,28.5,26.7)
y_2010 <- c(26.1,29.2,27.7,28.2,27.0)
y_2018 <- c(30.2,30.0,33.7,33.3,31.5)

# Create table
trend_table <- cbind(Counties, y_1980, y_1990, y_2000, y_2010, y_2018)

# Set up data frame
trend_data <- data.frame ( 
   County = c,
   time_m = c(y_1980, y_1990, y_2000, y_2010, y_2018),
   year = y)

# Reorder legend counties
trend_data$County <- factor(trend_data$County, levels=Counties)

# Plot
trend_data %>%
  ggplot(aes(x=year, y=time_m, group=County, color=County)) +
  geom_point() +
  geom_line() +
  labs(x = "Year",
       y = "Travel Time to Work (minutes)",
       group="Counties",
       title = "Average Commute Travel Time by Year") +
  scale_x_continuous(limits = c(1975, 2020),breaks=years) +
  scale_y_continuous(limits=c(0,35), minor_breaks = 5)
```
\
\
**Average commute time (minutes) by county and region over time.**  
The data is from the American Community Survey (ACS). 
```{r}
# Format table
kable(trend_table,
      col.names=c("Counties","1980","1990","2000","2010","2018"),
      align="lccccc",
      digits=2) %>%
  kable_styling("bordered",full_width = F, position = "left") %>%
  column_spec(1, bold=TRUE) %>%
  row_spec(5, italic=TRUE, color="#AD5CAB")
```
\
\


## Background: Sample
5,711 people responded to the 2019 survey and provided their employment status and workplace. These tables include all the possible survey responses for employment status and workplace.
\
\

### Employment Status
The following table shows the distribution of respondents' employment status.
```{r}
persons_2019$employment <- factor(persons_2019$employment,
                                 levels=c("Employed full time (35+ hours/week, paid)",
                                          "Employed part time (fewer than 35 hours/week, paid)", 
                                          "Self-employed",
                                          "Unpaid volunteer or intern",
                                          "Homemaker",
                                          "Retired",
                                          "Not currently employed",
                                          "Missing: Skip logic"))


table_employment <- persons_2019 %>%
  filter(employment!="Missing: Skip logic") %>%
  group_by(employment) %>%
  summarize(n=n(),
            Weighted_2019=round(sum(hh_wt_2019))) %>%
  mutate(Weighted_Percent=(round(Weighted_2019/sum(persons_2019$hh_wt_2019),4)))

formattable(table_employment,
            list(area(col=c(2:NCOL(table_employment)))~mycomma(digits=0),
                 Weighted_Percent=percent),
            align=c("l", "c", "c", "c"),
            col.names=c("Employment", "Sample Size", "2019 Estimate", "2019 Percent"))
```
\

### Workplace
The following table shows where workers go for work.
```{r}
persons_2019$workplace <- factor(persons_2019$workplace,
                                 levels=c("At home (telecommute or self-employed with home office)",
                                          "Drives for a living (e.g., bus driver, salesperson)", 
                                          "Usually the same location (outside home)",
                                          "Workplace regularly varies (different offices or jobsites)",
                                          "Missing: Skip logic"))

table_workplace <- persons_2019 %>%
  filter(workplace!="Missing: Skip logic") %>%
  group_by(workplace) %>%
  summarize(n=n(),
            Weighted_2019=round(sum(hh_wt_2019))) %>%
  mutate(Weighted_Percent=(round(Weighted_2019/sum(persons_2019$hh_wt_2019),4)))

formattable(table_workplace,
            list(area(col=c(2:NCOL(table_employment)))~mycomma(digits=0),
                 Weighted_Percent=percent),
            align=c("l", "c", "c", "c"),
            col.names=c("Workplace", "Sample Size", "2019 Estimate", "2019 Percent"))
```
\
\

 <a href="#top">Back to top</a>