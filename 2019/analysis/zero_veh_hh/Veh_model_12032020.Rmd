---
title: "Household Travel Survey: Vehicle Ownership"
author: "Mary Richards"
date: "`r format(Sys.time(), '%B %d %Y')`"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_depth: 5
    toc_float: true
  word_document: default
  pdf_document: default
---

This report presents preliminary findings for household vehicle ownership trends based on the Household Travel Survey (2017 and 2019), a survey conducted every other year to determine travel patterns for individuals living within PSRC's four-county jurisdiction. :blue_car: :red_car:

\
\
```{r include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting
```

```{r Libraries, include=FALSE}
library(nnet)
library(data.table)
library(tidyverse)
library(DT)
library(openxlsx)
library(odbc)
library(DBI)
library(dplyr)
library(summarytools)
library(stargazer)
library(MASS)
library(caret) #requires lattice and ggplot2
library(ggplot2)
library(lattice)
library(interactions)

library(tidyr)
library(reshape2)
library(table1)
library(knitr)
library(kableExtra) 
```

## 1. Background Information
This section describes the different explanatory and outcome variables.
\
```{r Data setup, include = FALSE}
# Load Data
parent_folder <- "C:/Users/mrichards/Documents/GitHub/travel-studies/2019/analysis/zero_veh_hh/model_outputs/"

#read in the household table
elmer_connection <- dbConnect(odbc::odbc(),
                              driver = "SQL Server",
                              server = "AWS-PROD-SQL\\Sockeye",
                              database = "Elmer",
                              trusted_connection = "yes")
h <- dbGetQuery(elmer_connection,
                "SELECT * FROM HHSurvey.v_households_2017_2019_in_house")
p <- dbGetQuery(elmer_connection,
                "SELECT * FROM HHSurvey.v_persons_2017_2019_in_house")

dbDisconnect(elmer_connection)


household <- data.table(h)
person <- data.table(p)

# Statistical assumptions for margins of error
p_MOE <- 0.5
z<-1.645
missing_codes <- c('Missing: Technical Error', 'Missing: Non-response', 
                   'Missing: Skip logic', 'Children or missing', 'Prefer not to answer',
                   'Missing')
```

```{r Functions}
# Create a simplified crosstab from one variable, calculate counts, totals, shares, and MOE
# for categorical data
create_table_one_var_simp= function(var1, table_temp, table_type) {
  #table_temp = recategorize_var_upd(var2,table_temp)
  #print(table_temp)
  if (table_type == "household" | table_type == "person" ) {
    weight_2017 = "hh_wt_revised"
    weight_2019 = "hh_wt_2019"
    weight_comb = "hh_wt_combined"
  } else if (table_type == "trip") {
    weight_2017 = "trip_weight_revised"
    weight_2019 = "trip_wt_2019"
    weight_comb = "trip_wt_combined"  
  } 
  
  temp = table_temp %>% dplyr::select(!!sym(var1), all_of(weight_2017), all_of(weight_2019),
                                      all_of(weight_comb)) %>% 
    filter(!.[[1]] %in% missing_codes, !is.na(.[[1]])) %>% 
    group_by(!!sym(var1)) %>% 
    summarise(n=n(),sum_wt_comb = sum(.data[[weight_comb]],na.rm = TRUE), 
              sum_wt_comb = round(sum_wt_comb, 0)) %>% 
    mutate(perc_comb = sum_wt_comb/sum(sum_wt_comb)*100, perc_comb = round(perc_comb, 2)) %>% 
    ungroup() %>%  
    mutate(MOE=1.65*(0.25/sum(n))^(1/2)*100, MOE = round(MOE, 2)) %>% arrange(var1)
  return(temp)
}

#Create a crosstab from two variables, calculate counts, totals, and shares,
# for categorical data
cross_tab_categorical <- function(table, var1, var2, wt_field) {
  expanded <- table %>% 
    group_by(.data[[var1]],.data[[var2]]) %>%
    summarize(Count= n(),Total=sum(.data[[wt_field]])) %>%
    group_by(.data[[var1]])%>%
    mutate(Percentage=Total/sum(Total)*100)
  
  
  expanded_pivot <-expanded%>%
    pivot_wider(names_from=.data[[var2]], values_from=c(Percentage,Total, Count))
  
  return (expanded_pivot)
  
} 

# Create margins of error for dataset
categorical_moe <- function(sample_size_group){
  sample_w_MOE<-sample_size_group %>%
    mutate(p_col=p_MOE) %>%
    mutate(MOE_calc1= (p_col*(1-p_col))/sample_size) %>%
    mutate(MOE_Percent=z*sqrt(MOE_calc1)*100)
  
  sample_w_MOE<- dplyr::select(sample_w_MOE, -c(p_col, MOE_calc1))
  
  return(sample_w_MOE)
}


# create table with bivariate analysis stats
bivariate_Pvalue <- function(outcome, explanatory){
  model_output <- polr(as.factor(outcome) ~ explanatory, Hess=T)
  ctable <- coef(summary(model_output))
  # calculate and store p values
  p <- pnorm(abs(ctable[,"t value"]), lower.tail = F)*2
  p_round <- round(pnorm(abs(ctable[,"t value"]), lower.tail = F)*2,4)
  ctable <- cbind(ctable, "p-value"=p, "simp p-value"=p_round)
  return(ctable)
}


# create stargazer table
stargazer_table <- function(outcome, explanatory, table_title){
  stargazer::stargazer(
    polr(as.factor(outcome) ~ explanatory, Hess=T), type = "html",
                      title =  table_title,
                      notes.append =  FALSE, 
                      notes =  c("<sup>&sstarf;</sup>p<0.1; <sup>&sstarf;&sstarf;</sup>p<0.05; <sup>&sstarf;&sstarf;&sstarf;</sup>p<0.01"))

}

# rounding function applied to categorical columns 
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%.0f%%)", FREQ, PCT))))}
```

## 2. Outcome Variables
The two outcome variables from these models are at the household level (by household id):
\
1) Vehicle count - the number of vehicles owned reported by survey respondents
\
2) Vehicle access - the number of household vehicles owned in relation to the number of workers in each household


### a.Household Vehicle Count
Survey Responses:  
*"How many motor vehicles (in working order) are there in your household?"*
```{r Vehicle Count: Original Data}
household$vehcount_ordered <- factor(household$vehicle_count,
                                                levels=c("0 (no vehicles)","1","2","3","4","5",
                                                         "6","7","8","9","10 or more vehicles"))

table1(~vehcount_ordered, data=household, render.categorical=my.render.cat)
```
\
```{r Vehicle Count: MOE}
x <- create_table_one_var_simp("vehcount_ordered",household, "household")
print(as_tibble(x), n = 12)
```

Based on survey responses, there is a very small number of households with more than 3 vehicles, so these households are grouped together.

*Number of workers by household id*
```{r Grouping vehicle count}
household <- household %>% 
  mutate(vehicle_group = case_when(vehicle_count== "0 (no vehicles)" ~ 0,
                                   vehicle_count == "1" ~ 1,
                                   vehicle_count == "2" ~ 2,
                                   TRUE ~ 3))

household$vehicle_group <- as_factor(household$vehicle_group)
table1(~vehicle_group, data=household, render.categorical=my.render.cat)
```

```{r Vehicle Count regrouped: MOE}
x <- create_table_one_var_simp("vehicle_group",household, "household")
print(as_tibble(x))
```

### b. Household Vehicle Access
This variable is based on the number of household vehicles (explained above) and the number of workers within the household. 
```{r Number of household workers}
# # look at vehicle access by number of workers in a household
# unique(person_and_household$numworkers)
household$numworkers <- as_factor(household$numworkers)
table1(~numworkers, data=household, render.categorical=my.render.cat)
```

```{r Number of household workers: MOE}
x <- create_table_one_var_simp("numworkers",household, "household")
print(as_tibble(x))
```
\
Based on survey responses, there is a very small number of households with more than 3 workers, so these households are grouped together
```{r Grouping household workers}
household <- household %>% 
  mutate(numworkers_group = case_when(numworkers== "0" ~ 0,
                                   numworkers == "1" ~ 1,
                                   numworkers == "2" ~ 2,
                                   TRUE ~ 3))
household$numworkers_group <- as.factor(household$numworkers_group)
table1(~numworkers_group, data=household, render.categorical=my.render.cat)
```

```{r Grouping household workers: MOE}
x <- create_table_one_var_simp("numworkers_group",household, "household")
print(as_tibble(x))
```
\
**Vehicle Access is calculated by comparing the number of vehicles and the number of workers per household**

* *limited access*:  vehicles < workers
* *equal access*:  vehicles = workers
* *good access*: vehicles > workers

```{r calculating vehicle access}
# compare veh count and numworkers to get vehicle access
# convert "vehicle_group" and "numworkers_group" from factor to numeric
household$vehicle_group <- as.numeric(as.character(household$vehicle_group))
household$numworkers_group <- as.numeric(household$numworkers_group)

household <- household %>%
  mutate(hh_veh_access = case_when(vehicle_group < numworkers_group ~ 'Reduced access',
                                   vehicle_group == numworkers_group ~ 'Equal access',
                                   vehicle_group > numworkers_group ~ 'Good access'))

household$hh_veh_access <- factor(household$hh_veh_access, 
                                  levels=c("Reduced access", "Equal access","Good access"))
table1(~hh_veh_access, data=household, render.categorical=my.render.cat)
```
\

## 3. Explanatory or predictor variables
There are many personal and household characteristics that can contribute to vehicle ownership at the household level. 
Based on these considerations and the data available through survey responses, the following table will attempt to match the person-level and household-level characteristics with responses provided by the survey participants. The data listed in the right column are from the in-house person (p) and household (h) views, available through Elmer, or describe an externally-sourced dataset (e).  

```{r characteristics and corresponding survey questions}
c1 <- as.data.frame(c(
  "1. Income",
  "2. Gender",
  "3. Age",
  "4. Household size",
  "5. Number of licensed (or licensed age) individuals",
  "6. Occupation",
  "7. Educational Attainment",
  "8. Number of workers",
  "9. Household lifecycle or age composition of household members",
  "10. Race or ethnicity",
  "11. Physical disabilities",
  "12. Housing type",
  "13. Housing or work location and proximity to transit",
  "14. Commuting patterns",
  "15. Quality of transit options available",
  "16. Housing proximity to services",
  "17. Environmental consciousness"))
colnames(c1)[1] <- "Vehicle-ownership Considerations"
c2 <- as.data.frame(c(
  "*hhincome_broad (p/h), hhincome_detailed (p/h)*",
  "*gender (p)*",
  "*age (p), age_category (p)*",
  "*hhsize (p/h)*",
  "*license (p)*",
  "*employment (p), jobs_count (p)*",
  "*education (p)*",
  "*numworkers (h)*",
  "*lifecycle (p/h)*",
  "*race_category (p)*",
  "*?*",
  "*rent_own (h), res_type (h)*",
  "*final_home_rgcnum (h), seattle_home (h)*",
  "*commute_freq (p), commute_mode (p), commute_dur (p), telecommute_freq (p)*",
  "*transit score by block group (e)*",
  "*displacement risk index (e)*",
  "*?*"))
colnames(c2)[1] <- "Survey Variables"

corresponding <- cbind(c1,c2)

# print table using kable()
kable(corresponding, format = "html",escape = FALSE, align = c('l','l','l')) %>% kable_styling("bordered",full_width = F, position = "left") #%>% column_spec(2, color = "red")#%>% column_spec(2, bold = T)
```
\

```{r HOUSEHOLD TABLE, include = FALSE}
# this has some information on the Census Tract level that could be useful
displ_index_data<- 'C:/Users/mrichards/Documents/GitHub/travel-studies/2019/analysis/zero_veh_hh/displacement_risk_estimation.csv'
displ_risk_df <- read.csv(displ_index_data)
transit_score_data <- 'C:/Users/mrichards/Documents/GitHub/travel-studies/2019/analysis/zero_veh_hh/bg_transit_score2018_2_sf_10302020.csv'
transit_sc_df <- read.csv(transit_score_data)

# merge the households to info about the tracts/blocks they live in - displacement risk/transit score (Stefan)
household$final_home_tract<- as.character(household$final_home_tract)
household$final_home_bg<- as.character(household$final_home_bg)
# displacement risk - by tract
displ_risk_df$GEOID<-as.character(displ_risk_df$GEOID)
household <- merge(household,displ_risk_df, by.x='final_home_tract', by.y='GEOID', all.x=TRUE)
# glimpse(household)
# transit score - by block
transit_sc_df$geoid10<-as.character(transit_sc_df$geoid10)
# glimpse(transit_sc_df$geoid10)
# glimpse(household$final_home_bg)
household <- merge(household, transit_sc_df, by.x='final_home_bg', by.y='geoid10', all.x=TRUE )
# glimpse(household)
# nrow(household)
household$household_id <- as.character(household$household_id)
```

```{r PERSON TABLE description, include=FALSE}
# need to summarise the variables of interest so that they can be representative at the household level
# to prepare the variables for aggregation: 
    # licenses, employment, educational attainment, commuting patterns
```

```{r license}
# freq(person$license)
table(person$license)

# simplify license status
person <- person %>% 
  mutate(license_simp = case_when(
    license == "No, does not have a license or permit" ~ "Non-driver",
    license == "Missing: Skip logic" ~ "Missing",
    TRUE ~ "Driver"))
table(person$license_simp)

# assign those categorized as drivers with number, so that the total can be determined by household
person <- person %>%
  mutate(driver = case_when(license_simp=="Driver"~ 1,
                            license_simp=="Non-driver"~ 0,
                            TRUE~ as.numeric(NA))) 
person$household_id <- as.character(person$household_id)
```

```{r employment, include=FALSE}
# EMPLOYMENT (jobs count) ----
# freq(person$employment)
freq(person$jobs_count)

# convert jobs count to numeric to allow for aggregation
person <- person %>%
  mutate(jobs_count_num = case_when(jobs_count=="0 jobs"~0,
                                    jobs_count=="1 job"~1,
                                    jobs_count=="2 jobs"~2,
                                    jobs_count=="3 jobs"~3,
                                    jobs_count=="4 jobs"~4,
                                    jobs_count=="5 or more jobs"~5,
                                    TRUE~ as.numeric(NA)))
freq(person$jobs_count_num)
```

```{r education, include=FALSE}
# EDUCATION ATTAINMENT ----
freq(person$education)
table(person$education)

# convert to numbers to allow for aggregation
person <- person %>%
  mutate(education_num = case_when(education=="Associates degree"~ 5,
                                   education=="High school graduate"~ 2,
                                   education=="Some college" ~ 4,
                                   education=="Bachelor degree" ~ 6,
                                   education=="Less than high school" ~ 1,
                                   education=="Vocational/technical training" ~ 3,
                                   education=="Graduate/post-graduate degree" ~ 7, 
                                   TRUE~ as.numeric(NA))) 

# to check if "some college" is only for younger respondents (under 25yo: 107/1154; <10%)
# xtabs(~education+age, data=person) 

```

```{r commuting patterns, include=FALSE}
# RELATED VARIABLES ----
summary(person$commute_auto_distance) #very high MAX values
summary(person$commute_auto_time) #very high MAX values
freq(person$commute_freq)
# freq(person$commute_dur) # ? not very helpful
# freq(person$commute_mode) # indirectly related
# freq(person$simp_commute) # indirectly related
# freq(person$work_park_type) # indirectly related

# filter out outliers from auto commute distance and time
# person <- person %>%
#   mutate(com_auto_dist_cleaned =) %>%
#   mutate(com_auto_time_cleaneed =)

# convert to numbers to allow for aggregation
person <- person %>%
  mutate(commute_freq_num = case_when(commute_freq=="1 day a week"~ 1,
                                       commute_freq=="2 days a week"~ 2,
                                       commute_freq=="3 days a week"~ 3,
                                       commute_freq=="4 days a week"~ 4,
                                       commute_freq=="5 days a week"~ 5,
                                       commute_freq=="6-7 days a week"~ 6,
                                      TRUE~ as.numeric(NA))) 
# simplify categories
person <- person %>%
  mutate(commute_freq_simpnum = case_when(commute_freq=="Less than monthly" |
                                        commute_freq== "A few times per month"~ 1,
                                      commute_freq=="1 day a week" |
                                        commute_freq=="2 days a week" |
                                        commute_freq=="3 days a week"~ 2,
                                      commute_freq=="4 days a week" |
                                        commute_freq=="5 days a week" |
                                        commute_freq=="6-7 days a week"~ 3,
                                      TRUE~ as.numeric(NA))) 
freq(person$commute_freq_num)
freq(person$commute_freq_simpnum)
```

```{r aggregating person table, include=FALSE}
person_hh <- person %>%
  #dplyr::select(household_id, driver, hh_wt_combined) %>%
  group_by(household_id) %>%
  summarise(hh_driver = sum(driver, na.rm=T),
            hh_jobs = sum(jobs_count_num, na.rm=T),
            hh_edu_min = min(education_num, na.rm=T), 
            hh_edu_max = max(education_num, na.rm=T),
            # but use 'education' for stats to keep text, simplify to fewer categories?
            hh_commute_freq_min = min(commute_freq_simpnum, na.rm=T),
            hh_commute_freq_max = max(commute_freq_simpnum, na.rm=T),
            hh_commute_freq_sum = sum(commute_freq_num, na.rm=T),
            hh_com_auto_time_avg = mean(commute_auto_time, na.rm=T),
            hh_com_auto_dist_avg = mean(commute_auto_distance, na.rm=T))
nrow(person_hh) # check number of rows after grouping by household_id

# recategorize education to text
person <- person %>%
  mutate(education_min = case_when(hh_edu_min==5~"Associates degree",
                                   hh_edu_min==2~"High school graduate",
                                   hh_edu_min==4~"Some college",
                                   hh_edu_min==6~"Bachelor degree",
                                   hh_edu_min==1~"Less than high school",
                                   hh_edu_min==3~"Vocational/technical training",
                                   hh_edu_min==7~"Graduate/post-graduate degree", 
                                   TRUE~ as.numeric(NA))) %>%
  mutate(education_max = case_when(hh_edu_max==5~"Associates degree",
                                   hh_edu_max==2~"High school graduate",
                                   hh_edu_max==4~"Some college",
                                   hh_edu_max==6~"Bachelor degree",
                                   hh_edu_max==1~"Less than high school",
                                   hh_edu_max==3~"Vocational/technical training",
                                   hh_edu_max==7~"Graduate/post-graduate degree", 
                                   TRUE~ as.numeric(NA)))

# simplify the number of drivers - grouping households with 4+ licenses
person_hh <- person_hh %>%
  mutate(driver_simp = case_when(hh_driver== 5 ~ 4,
                                 hh_driver== 6 ~ 4,
                                 hh_driver== 7 ~ 4,
                                 hh_driver== 9 ~ 4,
                                 TRUE~.$hh_driver)) 
person_hh$driver_simp <- as.factor(person_hh$driver_simp)
freq(person_hh$driver_simp)

# recategorize commute frequency to text
person_hh <- person_hh %>%
  mutate(commute_freq_simp_min = case_when(hh_commute_freq_min==1~ "Less than once a week",
                                           hh_commute_freq_min==2~ "3 or fewer days a week",
                                           hh_commute_freq_min==3~ "4 or more days a week",
                                           TRUE~ as.character(NA))) %>%
  mutate(commute_freq_simp_max = case_when(hh_commute_freq_max==1~ "Less than once a week",
                                           hh_commute_freq_max==2~ "3 or fewer days a week",
                                           hh_commute_freq_max==3~ "4 or more days a week",
                                           TRUE~ as.character(NA)))
freq(person_hh$commute_freq_simp_min)
freq(person_hh$commute_freq_simp_max)
summary(person_hh$hh_commute_freq_sum)


glimpse(person_hh)
```
  
```{r JOIN household and person tables, include=FALSE}
person_and_household <- left_join(person_hh, household,
                                  by=c("household_id"="household_id"))

# add variables using both tables
person_and_household <- person_and_household %>%
  mutate(jobs_numworkers = hh_jobs/numworkers, na.rm=T) %>% # if 1: every worker has 1 job
  mutate(hh_commutetrips = hh_commute_freq_sum/(numworkers*5), na.rm=T) # if 1: all workers commuting every weekday

nrow(person_and_household) # check numner of rows: 6319
glimpse(person_and_household)
```
\

### a. Univariate analysis
The dependent variable or outcome will be vehicle ownership (*"vehicle_group"*: 0, 1, 2, 3+) and the independent or explanatory variables will be from the list above. Because the vehicle ownership is ordinal, an ordered logit model will be applied.

The following section will introduce descriptive statistics for each of the explanatory variables, followed by analysis. For an overview of the results from these individual analyses, please skip to section 3b.
  

#### <span style="color:#FF6633">*1. Income*</span>  
The survey variable "hhincome_broad" is divided into 5 categories, while the survey variable "hhincome_detailed" is divided into 10 categories. Although the broader categories do not provide as much detail, the sample sizes within each category are larger and there are fewer households who chose "Prefer not to answer" (broad: 829, detailed: 1,309). 
```{r income : stats}
# freq(person_and_household$hhincome_broad)

person_and_household$hhincomeb_reordered <- factor(person_and_household$hhincome_broad, 
                                                   levels=c("Under $25,000","$25,000-$49,999",
                                                            "$50,000-$74,999","$75,000-$99,999",
                                                            "$100,000 or more","Prefer not to answer"))
table(person_and_household$hhincomeb_reordered)
```

```{r income : MOE setup, include=FALSE}
# User defined variables on each analysis:
# this is the weight for summing in your analysis
hh_wt_field<- 'hh_wt_combined'
# # this is a field to count the number of records
# person_count_field<-'person_dim_id'
# this is how you want to group the data in the first dimension,
# this is how you will get the n for your sub group
group_cat <- 'hhincomeb_reordered'
# this is the second variable you want to summarize by
var <-  'vehicle_group'
# filter data missing weights
hh_no_na<-person_and_household %>% drop_na(all_of(hh_wt_field))
#filter data missing values
#before you filter out the data, you have to investigate if there are any NAs or missing values in your variables and why they are there.
sum(is.na(person_and_household$household_id))
#if you think you need to filter out NAs and missing categories, please use the code below
# hh_no_na = hh_no_na %>%
#   filter(!hhincomeb_reordered %in% missing_codes,
#          !is.na(hhincomeb_reordered))
# now find the sample size of your subgroup
sample_size_group<- hh_no_na %>%
  group_by(hhincomeb_reordered) %>%
  summarize(sample_size = n())
sample_size_group
# get the margins of error for your groups
sample_size_MOE<- categorical_moe(sample_size_group)
# calculate totals and shares
cross_table<-cross_tab_categorical(hh_no_na,group_cat,var, hh_wt_field)
# merge the cross tab with the margin of error
cross_table_w_MOE<-merge(cross_table, sample_size_MOE, by=group_cat)
```

```{r income : vehicle ownership MOE}
cross_table_w_MOE
```

```{r income : vehicle ownership plot}
# xtabs(~vehicle_group + hhincomeb_reordered, data = person_and_household)
hh_vehcount_income <- person_and_household %>%
  filter(!is.na(hhincomeb_reordered)) %>%
  group_by(hhincomeb_reordered,vehicle_group) %>%
  summarise(n=n(), HouseholdWeight = sum(hh_wt_combined))
# hh_vehcount_income 

ggplot(data=hh_vehcount_income, aes(x=hhincomeb_reordered, y=n, fill= vehicle_group)) +
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) +
  labs(x = "Income (broad)", 
       y = "Survey Responses", 
       fill = "Vehicle Ownership",
       title = "Vehicle Ownership by Income")
```


Reference group: Under $25,000
```{r income : bivariate analysis}
bivariate_Pvalue(person_and_household$vehicle_group, 
                 person_and_household$hhincomeb_reordered)
```

```{r income : stargazer table, results='asis'}
stargazer_table(person_and_household$vehicle_group,
                person_and_household$hhincomeb_reordered,
                'Vehicle Ownership by Income')
```
\
<span style="color:#20b2aa">In reference to the households making under $25k, households in higher income categories are more likely to own more vehicles. This positive association between household income and household vehicle ownership is statistically significant.</span>
\

#### <span style="color:#FF6633">*3. Age/Lifecycle*</span>  
Person-level ages are likely to influence vehicle ownership, but because the variable of interest is vehicle ownership, the household age composition or household lifecycle will be evaluated.

Households were organized into four categories based on the composition and age of people in the household:  

* *Households with children:* any household with at least one member under age 18  
* *Households with younger adults:* any household without children where all adults are age 18-34  
* *Households with older adults:* any household without children where all adults are age 18-64 and at least one adult is age 35-64  
* *Households with seniors:* any household with at one adult age 65 and older
```{r age/Lifecycle : stats}
# freq(person_and_household$lifecycle)
table(person_and_household$lifecycle)
person_and_household$lifecycle <- as_factor(person_and_household$lifecycle)
```
\
Because of the large number of categories - accounting for both size and age, they are reduced to reflect only age ranges
```{r age/Lifecycle : setup}
person_and_household <- person_and_household %>%
  mutate(hh_lifecycle = case_when(lifecycle == "Household size = 1, Householder under age 35" |
                                    lifecycle == "Household size > 1, Householder under age 35" ~
                                    "Under age 35",
                                  lifecycle == "Household size = 1, Householder age 35 - 64" |
                                    lifecycle == "Household size > 1, Householder age 35 - 64" ~ 
                                    "Age 35-64",
                                  lifecycle == "Household size = 1, Householder age 65+" |
                                    lifecycle == "Household size > 1, Householder age 65+" ~
                                    "Age 65+",
                                  lifecycle == "Household includes children under 5" ~
                                    "With children under 5",
                                  lifecycle == "Household includes children age 5-17" ~
                                    "With children age 5-17"))

person_and_household$hh_lifecycle <- factor(person_and_household$hh_lifecycle, 
                                            levels=c("Under age 35","Age 35-64",
                                                     "Age 65+","With children under 5",
                                                     "With children age 5-17"))
# freq(person_and_household$hh_lifecycle)
table(person_and_household$hh_lifecycle)
```

```{r age/Lifecycle : MOE setup, include=FALSE}
# User defined variables on each analysis:
# this is the weight for summing in your analysis
hh_wt_field<- 'hh_wt_combined'
# # this is a field to count the number of records
# person_count_field<-'person_dim_id'
# this is how you want to group the data in the first dimension,
# this is how you will get the n for your sub group
group_cat <- 'hh_lifecycle'
# this is the second variable you want to summarize by
var <- 'vehicle_group'
# filter data missing weights
hh_no_na<-person_and_household %>% drop_na(all_of(hh_wt_field))
#filter data missing values
#before you filter out the data, you have to investigate if there are any NAs or missing values in your variables and why they are there.
sum(is.na(household$household_id))
#if you think you need to filter out NAs and missing categories, please use the code below
# hh_no_na = hh_no_na %>%
#   filter(!hh_lifecycle %in% missing_codes,
#          !is.na(hh_lifecycle))
# now find the sample size of your subgroup
sample_size_group<- hh_no_na %>%
  group_by(hh_lifecycle) %>%
  summarize(sample_size = n())
sample_size_group
# get the margins of error for your groups
sample_size_MOE<- categorical_moe(sample_size_group)
# calculate totals and shares
cross_table<-cross_tab_categorical(hh_no_na,group_cat,var, hh_wt_field)
# merge the cross tab with the margin of error
cross_table_w_MOE<-merge(cross_table, sample_size_MOE, by=group_cat)
```

```{r age/Lifecycle : vehicle ownership MOE}
cross_table_w_MOE
```

```{r age/Lifecycle : vehicle ownership plot}
# xtabs(~vehicle_group + hhincomeb_reordered, data = person_and_household)
hh_vehcount_lifecycle <- person_and_household %>%
  filter(!is.na(hh_lifecycle)) %>%
  group_by(hh_lifecycle,vehicle_group) %>%
  summarise(n=n(), HouseholdWeight = sum(hh_wt_combined))
# hh_vehcount_lifecycle 

ggplot(data = hh_vehcount_lifecycle, aes(x=hh_lifecycle, y=n, fill= vehicle_group)) +
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) +
  labs(x = "Household Lifecycle", 
       y = "Survey Responses", 
       fill = "Vehicle Ownership",
       title = "Vehicle Ownership by Household age composition")
```

Reference group: Under age 35
```{r age/Lifecycle : bivariate analysis}
bivariate_Pvalue(person_and_household$vehicle_group, 
                 person_and_household$hh_lifecycle)
```

```{r age/Lifecycle : stargazer table, results='asis'}
stargazer_table(person_and_household$vehicle_group, 
                 person_and_household$hh_lifecycle,
                "Vehicle Ownership by Household Lifecycle")
```
\
<span style="color:#20b2aa">The relationship between household lifecycle and household vehicle ownership is  statistically significant, with households with children owning more vehicles, especially those with children ages 5-17, likely because of lifestyle requirements and housing patterns. Households with individuals 65+ are more likely to own more vehicles than households ages 35-64, likely because of mobility considerations and housing patterns. All of the household lifecycle categories included in the table above are more likely to own more vehicles than households under age 35.</span>
\

#### <span style="color:#FF6633">*4. Household size*</span>  
The survey question provides respondents with 9 options for household size. 

Original Data
```{r household size}
# unique(person_and_household$hhsize)
# freq(person_and_household$hhsize)

table(person_and_household$hhsize)
```
Because there are so few people with more than 5 people, these households have been grouped together into one category for analysis.
```{r household size : simplified}
person_and_household$hhsize_simp <- recode(person_and_household$hhsize,
                                           "5 people" = "5 or more people",
                                           "6 people" = "5 or more people",
                                           "7 people" = "5 or more people",
                                           "8 people" = "5 or more people",
                                           "9 people" = "5 or more people")
table(person_and_household$hhsize_simp)
```

```{r household size : MOE setup, include=FALSE}
# User defined variables on each analysis:
# this is the weight for summing in your analysis
hh_wt_field<- 'hh_wt_combined'
# # this is a field to count the number of records
# person_count_field<-'person_dim_id'
# this is how you want to group the data in the first dimension,
# this is how you will get the n for your sub group
group_cat <- 'hhsize_simp'
# this is the second variable you want to summarize by
var <- 'vehicle_group'
# filter data missing weights
hh_no_na<-person_and_household %>% drop_na(all_of(hh_wt_field))
#filter data missing values
#before you filter out the data, you have to investigate if there are any NAs or missing values in your variables and why they are there.
sum(is.na(household$household_id))
#if you think you need to filter out NAs and missing categories, please use the code below
# hh_no_na = hh_no_na %>%
#   filter(!hhincomeb_reordered %in% missing_codes,
#          !is.na(hhsize_simp))
# now find the sample size of your subgroup
sample_size_group<- hh_no_na %>%
  group_by(hhsize_simp) %>%
  summarize(sample_size = n())
sample_size_group
# get the margins of error for your groups
sample_size_MOE<- categorical_moe(sample_size_group)
# calculate totals and shares
cross_table<-cross_tab_categorical(hh_no_na,group_cat,var, hh_wt_field)
# merge the cross tab with the margin of error
cross_table_w_MOE<-merge(cross_table, sample_size_MOE, by=group_cat)
```

```{r household size : vehicle ownership MOE}
cross_table_w_MOE
```

```{r household size : vehicle ownership plot}
# xtabs(~vehicle_group + hhincomeb_reordered, data = person_and_household)
hh_vehcount_hhsize <- person_and_household %>%
  filter(!is.na(hhsize_simp)) %>%
  group_by(hhsize_simp,vehicle_group) %>%
  summarise(n=n(), HouseholdWeight = sum(hh_wt_combined))
# hh_vehcount_hhsize 

ggplot(data =hh_vehcount_hhsize, aes(x=hhsize_simp, y=n, fill= vehicle_group)) +
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) +
  labs(x = "Household size", 
       y = "Survey Responses", 
       fill = "Vehicle Ownership",
       title = "Vehicle Ownership by Household size")
```


Reference group: 1 person
```{r household size : stats}
bivariate_Pvalue(person_and_household$vehicle_group, 
                 person_and_household$hhsize_simp)
```

```{r household size : bivariate analysis, results='asis'}
stargazer_table(person_and_household$vehicle_group,
                person_and_household$hhsize_simp,
                'Vehicle Ownership by Household size')
```
\
<span style="color:#20b2aa">In reference to the households with one person, households with more people are more likely to own more vehicles. This positive association between household income and household vehicle ownership is statistically significant.</span>
\

#### <span style="color:#FF6633">*5. Number of household licenses*</span>   

Original Data at a person level
```{r license}
# freq(person_and_household$license)

table(person_and_household$license)
```
These categories have been simplified to drivers or non-drivers. Those with a permit are considered to be drivers as they are in the pursuit of a license. Despite this recategorization, there is a large disparity between these groups, with over 10 times as many people reporting that they have a license.  
```{r license : simplified}
table(person_and_household$license_simp)
```

```{r number license}
freq(person_and_household$hh_driver)
```
Because there are so few households with more than 4 drivers, these categories have been simplified.  
```{r number license : simplified}
freq(person_and_household$driver_simp)
```

```{r number license : MOE setup, include=FALSE}
# User defined variables on each analysis:
# this is the weight for summing in your analysis
hh_wt_field<- 'hh_wt_combined'
# # this is a field to count the number of records
# person_count_field<-'person_dim_id'
# this is how you want to group the data in the first dimension,
# this is how you will get the n for your sub group
group_cat <- 'driver_simp'
# this is the second variable you want to summarize by
var <- 'vehicle_group'
# filter data missing weights
hh_no_na<-person_and_household %>% drop_na(all_of(hh_wt_field))
#filter data missing values
#before you filter out the data, you have to investigate if there are any NAs or missing values in your variables and why they are there.
sum(is.na(person_and_household$household_id)) #0
# now find the sample size of your subgroup
sample_size_group<- person_and_household %>%
  dplyr::group_by(driver_simp) %>%
  summarize(sample_size = n())
sample_size_group
# get the margins of error for your groups
sample_size_MOE<- categorical_moe(sample_size_group)
# calculate totals and shares
cross_table<-cross_tab_categorical(hh_no_na,group_cat,var, hh_wt_field)
# merge the cross tab with the margin of error
cross_table_w_MOE<-merge(cross_table, sample_size_MOE, by=group_cat)
```

```{r number license : vehicle ownership MOE}
cross_table_w_MOE
```

```{r number license : vehicle ownership plot}
# xtabs(~vehicle_group + hhincomeb_reordered, data = person_and_household)
hh_vehcount_licensecount <- person_and_household %>%
  filter(!is.na(driver_simp)) %>%
  group_by(driver_simp,vehicle_group) %>%
  summarise(n=n(), hh_wt_combined)
# hh_vehcount_license 

ggplot(data =hh_vehcount_licensecount, aes(x=driver_simp, y=n, fill= vehicle_group)) +
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) +
  labs(x = "Number of Household Licenses", 
       y = "Survey Responses", 
       fill = "Vehicle Ownership",
       title = "Vehicle Ownership by Number of Household Licenses")
```


Reference group: 0 licenses in the household
```{r number license : stats}
bivariate_Pvalue(person_and_household$vehicle_group, 
                 person_and_household$driver_simp)
```

```{r number license : bivariate analysis, results='asis'}
stargazer_table(person_and_household$vehicle_group,
                person_and_household$driver_simp,
                'Vehicle Ownership by Number of Household Licenses')
```
\
<span style="color:#20b2aa">In reference to the households with no licensed members, households with more licensed drivers are more likely to own more vehicles. This positive association between number of household licenses and household vehicle ownership is statistically significant.</span>
\

#### <span style="color:#FF6633">*6. Number of workers*</span>
The survey question provides respondents with 5 options for number of household workers 

Original Data at a household level
```{r numworkers : stats}
# unique(household$numworkers)
# freq(household$numworkers)

freq(household$numworkers)
```
Because there are so few people with more than 4 people, these households have been grouped together into one category for analysis.
```{r numworkers : simplified}
household$numworkers <- as.numeric(household$numworkers)
household <- household %>% 
  mutate(numworkers_simp = case_when(numworkers == 5~4,
                                     numworkers == 6~4,
                                     TRUE~.$numworkers))
household$numworkers_simp <- as.factor(household$numworkers_simp)
table(household$numworkers_simp)
```

```{r numworkers : MOE setup, include=FALSE}
# User defined variables on each analysis:
# this is the weight for summing in your analysis
hh_wt_field<- 'hh_wt_combined'
# # this is a field to count the number of records
# person_count_field<-'person_dim_id'
# this is how you want to group the data in the first dimension,
# this is how you will get the n for your sub group
group_cat <- 'numworkers_simp'
# this is the second variable you want to summarize by
var <- 'vehicle_group'
# filter data missing weights
hh_no_na<-household %>% drop_na(all_of(hh_wt_field))
#filter data missing values
#before you filter out the data, you have to investigate if there are any NAs or missing values in your variables and why they are there.
sum(is.na(household$household_id))
#if you think you need to filter out NAs and missing categories, please use the code below
# hh_no_na = hh_no_na %>%
#   filter(!vehicle_group %in% missing_codes,
#          !is.na(vehicle_group))
# now find the sample size of your subgroup
sample_size_group<- hh_no_na %>%
  dplyr::group_by(numworkers_simp) %>%
  summarize(sample_size = n())
sample_size_group
# get the margins of error for your groups
sample_size_MOE<- categorical_moe(sample_size_group)
# calculate totals and shares
cross_table<-cross_tab_categorical(hh_no_na,group_cat,var, hh_wt_field)
# merge the cross tab with the margin of error
cross_table_w_MOE<-merge(cross_table, sample_size_MOE, by=group_cat)
```

```{r numworkers : vehicle ownership MOE}
cross_table_w_MOE
```

```{r numworkers : vehicle ownership plot}
# xtabs(~vehicle_group + hhincomeb_reordered, data = person_and_household)
hh_vehcount_numworkers <- household %>%
  filter(!is.na(numworkers_simp)) %>%
  group_by(numworkers_simp,vehicle_group) %>%
  summarise(n=n(), HouseholdWeight = sum(hh_wt_combined))
# hh_vehcount_numworkers 

ggplot(data =hh_vehcount_numworkers, aes(x=numworkers_simp, y=n, fill= vehicle_group)) +
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) +
  labs(x = "Household size", 
       y = "Survey Responses", 
       fill = "Vehicle Ownership",
       title = "Vehicle Ownership by Household size")
```


Reference group: 1 person
```{r numworkers : bivariate analysis}
bivariate_Pvalue(household$vehicle_group, 
                 household$numworkers_simp)
```

```{r numworkers : stargazer table, results='asis'}
stargazer_table(household$vehicle_group,
                household$numworkers_simp,
                'Vehicle Ownership by Number of Workers')
```
\
<span style="color:#20b2aa">In reference to the households with one person, households with more people are more likely to own more vehicles. This positive association between household income and household vehicle ownership is statistically significant.</span>
\

#### <span style="color:#FF6633">*7. Employment*</span>
```{r employment : stats}
table(person_and_household$hh_jobs)
```

Reference group: Employed full time (35+ hours/week, paid)
```{r employment : bivariate analysis}
bivariate_Pvalue(person_and_household$vehicle_group, 
                 person_and_household$hh_jobs)
```

```{r employment : stargazer table, results='asis'}
stargazer_table(person_and_household$vehicle_group,
                person_and_household$hh_jobs,
                'Vehicle Ownership by Employment')
```
\

#### <span style="color:#FF6633">*8. Educational attainment*</span>
```{r education stats}
table(person_and_household$education_min)
```

Reference group: Associates degree
```{r education : bivariate analysis}
bivariate_Pvalue(person_and_household$vehicle_group, 
                 person_and_household$education_min)
```

```{r education : stargazer table, results='asis'}
stargazer_table(person_and_household$vehicle_group,
                person_and_household$education_min,
                'Vehicle Ownership by Minimum Household Education')
```
\
\

#### <span style="color:#FF6633">*9. Race*</span>
```{r race : stats}
table(person_and_household$hh_race_category)
```
Because of the small numbers of respondents identifying as non-white, these groups have been grouped together as "POC". The "Missing/Other" group includes households categorized as "Missing" or "Other."
```{r race : setup, include=FALSE}
# simplify race category 
person_and_household <- person_and_household %>% 
  mutate(hh_race_2 = case_when(hh_race_category == "White Only" ~ 'White Only',
                               hh_race_category == "Missing" | hh_race_category == "Other" ~ "Missing/Other",
                               TRUE ~ "People of Color")) 
#POC = African American, Asian, Hispanic
freq(person_and_household$hh_race_2) #requries summarytools

# # remove missing/other category
# person_and_household <- person_and_household %>%
#   filter(hh_race_2 != "Missing/Other")
# freq(person_and_household$hh_race_2)

person_and_household$hh_race_2 <- factor(person_and_household$hh_race_2,
                                         levels = c("White Only", "People of Color", "Missing/Other"))

```

```{r race : descriptive stats table}
# person_and_household %>%
#   group_by(hh_race_category, hh_race_2) %>%
#   tally()
table(person_and_household$hh_race_2)

```

```{r race : MOE setup, include=FALSE}
# User defined variables on each analysis:
# this is the weight for summing in your analysis
hh_wt_field<- 'hh_wt_combined'
# # this is a field to count the number of records
# person_count_field<-'person_dim_id'
# this is how you want to group the data in the first dimension,
# this is how you will get the n for your sub group
group_cat <- 'hh_race_2'
# this is the second variable you want to summarize by
var <- 'vehicle_group'
# filter data missing weights
hh_no_na<-person_and_household %>% drop_na(all_of(hh_wt_field))
#filter data missing values
#before you filter out the data, you have to investigate if there are any NAs or missing values in your variables and why they are there.
sum(is.na(household$household_id))
#if you think you need to filter out NAs and missing categories, please use the code below
# hh_no_na = hh_no_na %>%
#   filter(!hh_race_2 %in% missing_codes,
#          !is.na(hh_race_2))
# now find the sample size of your subgroup
sample_size_group<- hh_no_na %>%
  group_by(hh_race_2) %>%
  summarize(sample_size = n())
sample_size_group
# get the margins of error for your groups
sample_size_MOE<- categorical_moe(sample_size_group)
# calculate totals and shares
cross_table<-cross_tab_categorical(hh_no_na,group_cat,var, hh_wt_field)
# merge the cross tab with the margin of error
cross_table_w_MOE<-merge(cross_table, sample_size_MOE, by=group_cat)
```

```{r race : vehicle ownership MOE}
cross_table_w_MOE
```

```{r race : vehicle ownership plot}
# xtabs(~vehicle_group + hh_race_2, data = person_and_household)
hh_vehcount_race <- person_and_household %>%
  filter(!is.na(hh_race_2)) %>%
  group_by(hh_race_2,vehicle_group) %>%
  summarise(n=n(), HouseholdWeight = sum(hh_wt_combined))
# hh_vehcount_race

ggplot(data = hh_vehcount_race, aes(x=hh_race_2, y=n, fill= vehicle_group)) +
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) +
  labs(x = "Race",
       y = "Survey Responses",
       fill = "Vehicle Ownership",
       title = "Vehicle Ownership by Race")
```

Reference group: White Only
```{r race : bivariate analysis}
bivariate_Pvalue(person_and_household$vehicle_group, 
                 person_and_household$hh_race_2)
```

```{r race : stargazer table, results='asis'}
stargazer_table(person_and_household$vehicle_group, 
                 person_and_household$hh_race_2,
                "Vehicle Ownership by Race")
```
\
<span style="color:#20b2aa">The relationship between race and household vehicle ownership is statistically significant with POC households owning fewer vehicles.</span>

An alternative way to categorize race: White only (7,147), Asian (2,141), other POC (935), and missing/other (1,717).
```{r race expanded categories : setup, include = FALSE}
person_and_household <- person_and_household %>%
  mutate(hh_race_3 = case_when(hh_race_category == "White Only" ~ "White Only",
                               hh_race_category == "Missing" | hh_race_category == "Other" ~ "Missing/Other",
                               hh_race_category == "Asian" ~ "Asian",
                               TRUE ~ "People of Color"))
table(person_and_household$hh_race_3)
person_and_household$hh_race_3 <- factor(person_and_household$hh_race_3,
                                         levels = c("White Only", "People of Color", "Asian", "Missing/Other"))
``` 

```{r race expanded : MOE setup, include=FALSE}
# User defined variables on each analysis:
# this is the weight for summing in your analysis
hh_wt_field<- 'hh_wt_combined'
# # this is a field to count the number of records
# person_count_field<-'person_dim_id'
# this is how you want to group the data in the first dimension,
# this is how you will get the n for your sub group
group_cat <- 'hh_race_3' 
# this is the second variable you want to summarize by
var <- 'vehicle_group'
# filter data missing weights
hh_no_na<-person_and_household %>% drop_na(all_of(hh_wt_field))
# filter data missing values
# before you filter out the data, you have to investigate if there are any NAs or missing values in your variables and why they are there.
sum(is.na(household$household_id))
# if you think you need to filter out NAs and missing categories, please use the code below
# hh_no_na = hh_no_na %>%
#   filter(!hh_race_2 %in% missing_codes,
#          !is.na(hh_race_2))
# now find the sample size of your subgroup
sample_size_group<- hh_no_na %>%
  group_by(hh_race_3) %>%
  summarize(sample_size = n())
sample_size_group
# get the margins of error for your groups
sample_size_MOE<- categorical_moe(sample_size_group)
# calculate totals and shares
cross_table<-cross_tab_categorical(hh_no_na,group_cat,var, hh_wt_field)
# merge the cross tab with the margin of error
cross_table_w_MOE<-merge(cross_table, sample_size_MOE, by=group_cat)
```

```{r race expanded : vehicle ownership MOE}
cross_table_w_MOE
```

Reference group: White Only
```{r race expanded: bivariate analysis}
bivariate_Pvalue(person_and_household$vehicle_group, 
                 person_and_household$hh_race_3)
```

```{r race expanded : stargazer table, results='asis'}
stargazer_table(person_and_household$vehicle_group, 
                person_and_household$hh_race_3,
                "Vehicle Ownership by Race")
```
\
<span style="color:#20b2aa">The relationship between race and household vehicle ownership is statistically significant with Asian and other POC households owning fewer vehicles.</span>


#### <span style="color:#FF6633">*10. Housing*</span>
This category can be analyzed at two different levels: 

* housing tenure (rent vs. own)  
* residential type  

##### <span style="color:#6AA84F">*10a. Housing tenure*</span>
```{r tenure : stats}
# freq(person_and_household$rent_own)
table(person_and_household$rent_own)
```
\
Because the majority of respondents identify as renters or owners, the other categories with fewer responses were grouped together. 
```{r tenure : setup}
person_and_household <- person_and_household %>% 
  mutate(rent_own_simp = case_when(rent_own == "Prefer not to answer" | 
                                    rent_own == "Other" |
                                    rent_own == "Provided by job or military" ~ "Other",
                                  TRUE~.$rent_own))

person_and_household$rent_own_simp <- factor(person_and_household$rent_own_simp, 
                                            levels=c("Own/paying mortgage",
                                                     "Rent",
                                                     "Other"))
# freq(person_and_household$rent_own_simp)
table(person_and_household$rent_own_simp)
```

```{r tenure : MOE setup, include=FALSE}
# User defined variables on each analysis:
# this is the weight for summing in your analysis
hh_wt_field<- 'hh_wt_combined'
# # this is a field to count the number of records
# person_count_field<-'person_dim_id'
# this is how you want to group the data in the first dimension,
# this is how you will get the n for your sub group
group_cat <- 'rent_own_simp'
# this is the second variable you want to summarize by
var <- 'vehicle_group'
# filter data missing weights
hh_no_na<-person_and_household %>% drop_na(all_of(hh_wt_field))
#filter data missing values
#before you filter out the data, you have to investigate if there are any NAs or missing values in your variables and why they are there.
sum(is.na(household$household_id))
#if you think you need to filter out NAs and missing categories, please use the code below
# hh_no_na = hh_no_na %>%
#   filter(!hh_lifecycle %in% missing_codes,
#          !is.na(hh_lifecycle))
# now find the sample size of your subgroup
sample_size_group<- hh_no_na %>%
  group_by(rent_own_simp) %>%
  summarize(sample_size = n())
sample_size_group
# get the margins of error for your groups
sample_size_MOE<- categorical_moe(sample_size_group)
# calculate totals and shares
cross_table<-cross_tab_categorical(hh_no_na,group_cat,var, hh_wt_field)
# merge the cross tab with the margin of error
cross_table_w_MOE<-merge(cross_table, sample_size_MOE, by=group_cat)
```

```{r tenure : vehicle ownership MOE}
cross_table_w_MOE
```

```{r tenure : vehicle ownership plot}
# xtabs(~vehicle_group + hh_vehcount_rentown, data = person_and_household)
hh_vehcount_rentown <- person_and_household %>%
  filter(!is.na(rent_own_simp)) %>%
  group_by(rent_own_simp,vehicle_group) %>%
  summarise(n=n(), HouseholdWeight = sum(hh_wt_combined))
# hh_vehcount_rentown 

ggplot(data = hh_vehcount_rentown, aes(x=rent_own_simp, y=n, fill= vehicle_group)) +
  geom_bar(stat="identity") +
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5)) +
  labs(x = "Household Tenure", 
       y = "Survey Responses", 
       fill = "Vehicle Ownership",
       title = "Vehicle Ownership by Household Tenure")
```

Reference group: Own/paying mortgage
```{r tenure : bivariate analysis}
bivariate_Pvalue(person_and_household$vehicle_group, 
                 person_and_household$rent_own_simp)
```

```{r tenure : stargazer table, results='asis'}
stargazer_table(person_and_household$vehicle_group, 
                 person_and_household$rent_own_simp,
                "Vehicle Ownership by Household Tenure")
```
\
<span style="color:#20b2aa">The relationship between household tenure and household vehicle ownership is  statistically significant, with renting individuals reporting that they are part of households that own fewer vehicles.</span>
\

##### <span style="color:#6AA84F">*10b. Housing type*</span>

\

#### <span style="color:#FF6633">*11. Housing / work location*</span>

\

#### <span style="color:#FF6633">*12. Commuting patterns*</span>

\

#### <span style="color:#FF6633">*13. Transit accessibility*</span>

\

#### <span style="color:#FF6633">*14. Proximity to services*</span>

\

```{r, include=FALSE}
# get transit score by block group from Stefan
# glimpse(hh_df_veh$scaled_score)
# try other geographic variables on the household table and the tract table
person_and_household <- person_and_household %>%
  mutate(RGC_binary = case_when(final_home_rgcnum == "Not RCG" ~ "Not RGC",
                                TRUE ~ "RGC"))
freq(person_and_household$RGC_binary)
```
\

### b. Overview: univariate analysis results  
The table below shows which explanatory variables were statistically significant when analyzed against household vehicle ownership. Significance: &ast;p<0.1; &ast;&ast;&ast;p<0.05; &ast;&ast;&ast;p<0.01

```{r univariate analysis results}
c1 <- as.data.frame(c(
  "1. Income",
  "2. Gender",
  "3. Age/Household Lifecycle",
  "4. Household size",
  "5. Number of licensed (or licensed age) individuals",
  "6. Number of workers",
  "7. Employment",
  "8. Educational Attainment",
  "9. Race or ethnicity",
  "10. Housing type",
  "11. Housing or work location and proximity to transit",
  "12. Commuting patterns",
  "13. Transit accessibility",
  "14. Housing proximity to services"))
colnames(c1)[1] <- "Explanatory variables"
c2 <- as.data.frame(c(
  "***",
  " ",
  "***",
  "***",
  "***",
  "***",
  "*employment*",
  "education",
  "***",
  "***",
  "*final_home_rgcnum (h), seattle_home (h)*",
  "*commute_freq (p), commute_mode (p), commute_dur (p), telecommute_freq (p)*",
  "*transit score by block group (e)*",
  "*displacement risk index (e)*"))
colnames(c2)[1] <- "Significance"
c3 <- as.data.frame(c(
  "higher income",
  "N/A",
  "households with children and older individuals",
  "larger households",
  "higher number of household licenses",
  "higher number of workers",
  "*employment*",
  "*education*",
  "white only households",
  "owning households",
  "*final_home_rgcnum (h), seattle_home (h)*",
  "*commute_freq (p), commute_mode (p), commute_dur (p), telecommute_freq (p)*",
  "*transit score by block group (e)*",
  "*displacement risk index (e)*"))
colnames(c3)[1] <- "Trend (higher household vehicle ownership)"

corresponding <- cbind(c1,c2, c3)

# print table using kable()
kable(corresponding, format = "html",escape = FALSE, align = c('l','l','l')) %>% kable_styling("bordered",full_width = F, position = "left") #%>% column_spec(2, color = "red")#%>% column_spec(2, bold = T)
```
\

## 4. Correlation matrix with all variables
The outcome variable will be vehicle ownership (*"vehicle_group"*: 0, 1, 2, 3+)  
<span style="color:#FF6633">*Reference variables*</span>  
```{r reference variables, eval=FALSE, include=FALSE}
table(person_and_household$vehicle_group) # 0 vehicles is reference
table(person_and_household$numworkers) # 0 workers is reference
table(person_and_household$hhincomeb_reordered) # Under $25k is reference
table(person_and_household$hh_race_2) # People of Color is reference
table(person_and_household$hh_license_cat) # 0 is reference
table(person_and_household$tenure_binary_reordered) # Own is reference
table(person_and_household$hh_size_cat) # 1 person is reference
table(person_and_household$hh_lifecycle) # Under age 35 is reference
```

```{r eval=FALSE, include=FALSE}
# documentation about function: https://www.rdocumentation.org/packages/MASS/versions/7.3-52/topics/polr
correl_matrix <-polr(as.factor(vehicle_group) ~
           RGC_binary + scaled_score + seattle_home,
         data=person_and_household, Hess = T)
# adding coefficients and p-values store table
ctable <- coef(summary(correl_matrix))
# calculate and store p values
p <- round(pnorm(abs(ctable[,"t value"]), lower.tail = F)*2,2)
# combined table
ctable <-cbind(ctable, "p value"=p)
ctable

stargazer::stargazer(polr(correl_matrix, 
                          type = "html", 
                          title = Correlation Matrix,
                          notes.append =  FALSE, 
                          notes =  c("<sup>&sstarf;</sup>p<0.1; <sup>&sstarf;&sstarf;</sup>p<0.05; <sup>&sstarf;&sstarf;&sstarf;</sup>p<0.01"))
```