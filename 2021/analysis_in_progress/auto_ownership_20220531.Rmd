---
title: "HHTS: auto ownership (2017, 2019, 2021)"
author: "Mary Richards"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting
```

```{r library setup}
devtools::install_github("psrc/psrc.travelsurvey")

library(tidyverse)
library(psrccensus)
library(psrc.travelsurvey)
# library(rlang) #required for psrccensus
# library(emmeans) #required for rlang
library(magrittr)
library(knitr)
library(stringr)
library(kableExtra)
library(ggplot2)

# library(survey)
library(summarytools) #freq
library(table1)  #nice descriptive summary table
library(scales) #number formatting
library(ggpubr) #graphing - ggarrange fx
library(forcats) #for factor releveling
```

```{r functions}
# rounding function applied to categorical columns 
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%.0f%%)", FREQ, PCT))))}

# side-by-side count and proportion graphs
count_and_share_plot <- function(dt, grp_var, num_var, legend_name, tbl_name){
  
  fill_group <- dt[[grp_var]]
  x_axis_grp <- dt[[num_var]]
  
  count_plot <- ggplot(dt,
                       aes(x=x_axis_grp,
                           y=count,
                           fill=fill_group)) +
  geom_bar(stat="identity",
           position="dodge2") +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
        axis.title.x = element_blank()) +
  labs(y = "Number of Households",
       fill = legend_name) +
  scale_y_continuous(labels = scales::comma) +
  geom_errorbar(aes(ymin=count-count_moe, ymax=count+count_moe),
                size=.5,width=.2,
                position=position_dodge(.9))
  
  
  share_plot <- ggplot(dt,
                       aes(x=x_axis_grp,
                           y=share,
                           fill=fill_group)) +
  geom_bar(stat="identity",
           position="dodge2") +
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
        axis.title.x = element_blank()) +
  labs(y = "Share of Households",
       fill = legend_name) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                size=.5, width=.2,
                position=position_dodge(0.9))
  
  
  autos <- ggarrange(count_plot, share_plot, ncol = 2, nrow = 1,
                   common.legend = TRUE,
                   legend = "bottom")
  annotate_figure(autos, top = text_grob(tbl_name, 
               color = "blue", face = "bold", size = 14))
}
```

# Introduction

The work presented in this document continues analysis that began last year. This newer version includes 2021 data and incorporates the use of PSRC's R package, [psrc.travelsurvey](https://psrc.github.io/psrc.travelsurvey/index.html).


# Descriptive Stats
Based on analysis of 2017 and 2019 data, the following variables were found to be significant explanatory factors: 

* **Number of household licenses** [household members with license or permit]
* **Income** [5 broad income categories]
* **Household lifecycle** [age of household members, presence of children]
* **Number of workers** [household members with 1+ jobs]
* **Total commuting time** [minutes by automobile]
* **Transit accessibility** [transit score, scaled to region]
* **Housing in/out of RGC** [housing location within a Regional Growth Center]
    + *Note: variable likely related to transit accessibility*
* **Housing tenure**
\

The following are additional four variables were found to impact automobile ownership with some variation depending on the model and the aggregation techniques:

* Residential type
* Commute frequency
* Race
* Education
\

These 12 variables will be analyzed with automobile ownership. 
\

# Analysis
### Household Auto Ownership
```{r}
# retrieve data
# hh_autos_all <- get_hhts(dyear=c(2017,2019,2021),
#                          level="h",
#                          vars=c("hh_race_category",
#                                 "hhsize",
#                                 "vehicle_count",
#                                 "survey_year"))



# Household-level data
hh_autos <- c(2017, 2019, 2021) %>%
  lapply(FUN=function(x) get_hhts(x, "h", 
                                  c("survey_year",
                                    "vehicle_count",
                                    "hh_race_category",
                                    "hhsize",
                                    "numworkers", #to be able to calculate ratio
                                    "hhincome_broad",
                                    "lifecycle",
                                    "numworkers", #to be able to calculate ratio
                                    # "final_home_rgcnum",
                                    "res_type")))

hh_autos_simp <- lapply(c(2017, 2019, 2021), FUN=function(x) get_hhts(x, "h", 
                                  c("hh_race_category",
                                    "hhsize",
                                    "vehicle_count",
                                    "survey_year",
                                    "numworkers", #to be able to calculate ratio
                                    "hhincome_broad",
                                    "hhincome_detailed",
                                    "lifecycle",
                                    "final_home_rgcnum")) %>% 
                          mutate(vehicle_count_simp=case_when(vehicle_count== "0 (no vehicles)" ~ 0,
                                      vehicle_count == "1" ~ 1,
                                      vehicle_count == "2" ~ 2,
                                      is.na(vehicle_count) ~ NA_real_,
                                      TRUE ~ 3)))

# Person-level data
#education, license 

```

```{r example from Michael 4/15}
pums_1yr <- list()
pums_1yr <- lapply(2015:2019, FUN=function(x) get_psrc_pums(1, x, "p", c("PRACE", "SCHL", "AGEP")) %>%
               mutate(data_year=as.factor(x)) %>%
               mutate(POCYN=case_when(
                   PRACE=="White alone" ~ "Non-POC", 
                   !is.na(PRACE) ~ "POC")) %>%
               mutate(edu_simp=case_when(
                   grepl("(Bach|Mast|Prof|Doct)", SCHL) ~ "Bachelor's degree or higher",
                                           !is.na(SCHL) ~ "Less than a Bachelor's degree")))
poc_edu_pums <- function(dt){
                  temp <- filter(dt, AGEP > 24)
                  counties <- c("King","Kitsap","Pierce","Snohomish")
                  rs <- list()
                  rs <- lapply(counties, FUN=function(x){
                     ctytmp <- filter(temp, COUNTY==x)
                     rs1 <- psrc_pums_count(ctytmp, 
                                            group_var=c("edu_simp","POCYN"), 
                                            incl_counties=FALSE) %>%
                            mutate(County=unique(pull(ctytmp,COUNTY)))}) %>% rbindlist() %>%
                            mutate(data_year=unique(pull(temp, data_year))) %>% 
                            relocate(c("data_year", "County"))
return(rs)
}
poc_edu <- lapply(pums_1yr, poc_edu_pums) %>% rbindlist()
```

#### By Race
```{r}
# stat function
# race_auto <- hhts_count(df=hh_autos_all,
#                         group_vars=c("hh_race_category", 
#                                      "vehicle_count"))

cnt_fx <- function(x){
  hhts_count(x, group_vars=c("hh_race_category","vehicle_count"))
}

race_auto <- lapply(hh_autos, cnt_fx) %>% data.table::rbindlist()

# re-order number of vehicles in numerical order
race_auto$vehicle_count <- factor(race_auto$vehicle_count,
                                  levels=c("0 (no vehicles)", "1", 
                                           "2", "3", "4", "5",
                                           "6", "7", "8", "9", 
                                           "10 or more vehicles"))
# freq(race_auto$vehicle_count)
```

##### Survey Numbers
```{r}
race_auto_total_nototal <- race_auto %>% 
  filter(vehicle_count!="Total")

count_and_share_plot(race_auto_total_nototal,
                     "hh_race_category",
                     "vehicle_count",
                     "Household race category",
                     "Number of Household Automobiles by Race")
```

```{r workspace, include=FALSE, eval=FALSE, echo=FALSE}
# race_auto_plot_count <- ggplot(race_auto_total_nototal, 
#                                aes(x=vehicle_count,
#                                    y=count,
#                                    fill=hh_race_category)) +
#   geom_bar(stat="identity",
#            position="dodge2") +
#   theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
#         axis.title.x = element_blank()) +
#   labs(y = "Number of Households",
#        # x = "Number of vehicles",
#        # title = "Count in Region",
#        fill = "Household race category") +
#   scale_y_continuous(labels = scales::comma) +
#   geom_errorbar(aes(ymin=count-count_moe, ymax=count+count_moe),
#                 size=.5,width=.2,
#                 position=position_dodge(.9))
# 
# # print(race_auto_plot_count)
# 
# race_auto_plot_share <- ggplot(race_auto_total_nototal,
#                                aes(x=vehicle_count,
#                                    y=share,
#                                    fill=hh_race_category)) +
#   geom_bar(stat="identity",
#            position="dodge2") +
#   theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
#         axis.title.x = element_blank()) +
#   labs(y = "Share of Households",
#        # x = "Number of vehicles",
#        # title = "Proportion in Region",
#        fill = "Household race category") +
#   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
#   geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
#                 size=.5, width=.2,
#                 position=position_dodge(0.9))
# 
# # print(race_auto_plot_nototal)
# 
# 
# autos <- ggarrange(race_auto_plot_count, race_auto_plot_share, ncol = 2, nrow = 1,
#                    common.legend = TRUE,
#                    legend = "bottom")
# annotate_figure(autos, top = text_grob("Number of Household Automobiles by Race", 
#                color = "blue", face = "bold", size = 14))
```
\
\

##### Simplified Vehicle Numbers
Because the survey provides the option for people to respond with the number of household vehicles up to 10, these categories have been simplified to 4 categories: 1, 2, 3+. 
```{r}
# hh_autos_simp <- race_auto %>%
#   filter(vehicle_count!="Missing") %>% 
#   mutate(vehicle_count_simp=case_when(grepl("0", vehicle_count) ~ "0",
#                                       grepl("1", vehicle_count) ~ "1",
#                                       grepl("2", vehicle_count) ~ "2",
#                                       grepl("(3|4|5|6|7|8|9|10)", vehicle_count) ~ "3+",
#                                       TRUE~ vehicle_count))

hh_autos_simp <- race_auto %>%
  # filter(vehicle_count!="Missing") %>% 
  mutate(vehicle_count_simp=case_when(vehicle_count== "0 (no vehicles)" ~ 0,
                                      vehicle_count == "1" ~ 1,
                                      vehicle_count == "2" ~ 2,
                                      is.na(vehicle_count) ~ NA_real_,
                                      TRUE ~ 3))

table1(~vehicle_count |hh_race_category,
       data=race_auto,
       render.categorical=my.render.cat)

```

```{r}
# unable to group by survey_year because of issue with variable, so requires additional steps - after retrieving the data, need to filter out by the year, then can perform the summary statistic, then rbind the tables together
hh_autos_simp_17 <- hh_autos_simp %>% 
  filter(survey_year==as.factor(2017))
hh_autos_simp_19 <- hh_autos_simp %>% 
  filter(survey_year==as.factor(2019))
hh_autos_simp_21 <- hh_autos_simp %>% 
  filter(survey_year==as.factor(2021))

auto_num_17 <- hhts_count(hh_autos_simp_17,
                          group_vars = c("vehicle_count_simp",
                                         "hh_race_category")) %>% 
  mutate(Year=2017)
auto_num_19 <- hhts_count(hh_autos_simp_19,
                          group_vars = c("vehicle_count_simp",
                                         "hh_race_category")) %>% 
  mutate(Year=2019)
auto_num_21 <- hhts_count(hh_autos_simp_21,
                          group_vars = c("vehicle_count_simp",
                                         "hh_race_category")) %>% 
  mutate(Year=2021)


auto_num_17_21 <- rbind(auto_num_17,
                        auto_num_19,
                        auto_num_21)


prop_tbl_by_auto <- auto_num_17_21 %>% 
  filter(vehicle_count_simp != "Total") %>% 
  filter(hh_race_category == "Total")

prop_tbl_by_auto_race <- auto_num_17_21 %>% 
  filter(vehicle_count_simp != "Total") %>% 
  filter(hh_race_category != "Total")


g1 <- ggplot(data=prop_tbl_by_auto, 
             aes(x=vehicle_count_simp,
                 y=share,
                 fill=Year))+
  geom_bar(stat="identity",
             position = "dodge2") +
    labs(x = "Number of Vehicles",
         y = "Percent of Households",
         fill = "Year",
         title = paste0("Auto Ownership by Household: Year")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                       breaks = seq(0, 1, by = .2))

print(g1)

g2 <- ggplot(data=prop_tbl_by_auto_race, 
             aes(x=vehicle_count_simp,
                 y=share,
                 fill=hh_race_category))+
  geom_bar(stat="identity",
             position = "dodge2") +
    labs(x = "Number of Vehicles",
         y = "Percent of Households",
         fill = "Race/ethnicity",
         title = paste0("Auto Ownership by Household: Race/ethnicity")) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                       breaks = seq(0, 1, by = .2))

print(g2)



ggarrange(g1, g2, ncol = 2, nrow = 1,
          common.legend = TRUE,
          legend = "bottom")
```

<a href="#top">Back to top of the page</a>