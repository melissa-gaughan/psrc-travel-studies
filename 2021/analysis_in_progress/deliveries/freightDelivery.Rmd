---
title: "freightdelivery_rmd"
author: "suzanne"
date: "2022-09-14"
output: html_document
---

```{r setup, include=FALSE}

# how many days did people receive deliveries?
# did the number of deliveries change by year? by race? by income?

# .libPaths()
# .libloc <- "C:/Users/MGrzybowski/AppData/Local/R/win-library/4.2"
# remove.packages("rlang")
# install.packages("rlang")

# r start

library(tidyverse)
library(data.table)
library(leaflet)
library(shiny)
library(tidytext)
library(dplyr)
library(readr)
library(ggplot2)
library(ggiraph)
library(magrittr)

# additional packages

library(usethis)
library(devtools)
library(installr)
library(sf)
library(forcats)
library(tidyr)
library(summarytools)
library(sp)
library(gridExtra)
library(ggpubr)

# packages that are from github that host functions for pulling data (do the install in R, not RStudio)

#devtools::install_github("psrc/psrc.travelsurvey", force = TRUE)
#devtools::install_github("psrc/psrccensus", force = TRUE)
#devtools::install_github("psrc/psrcplot", force = TRUE)
#devtools::install_github("psrc/psrctrends", force = TRUE)

# run these in R Studio

library(psrc.travelsurvey)
library(psrccensus)
library(psrcplot)
library(psrctrends)

install_psrc_fonts()

# for Elmer connection

library(odbc)
library(DBI)

elmer_connect <- function(){
  DBI::dbConnect(odbc::odbc(),
                 driver = "ODBC Driver 17 for SQL Server",
                 server = "AWS-PROD-SQL\\Sockeye",
                 database = "Elmer",
                 trusted_connection = "yes",
                 port = 1433)
}

elmer_connection <- elmer_connect()

# views and global variables for deliveries

deliveries <- dbReadTable(elmer_connection, SQL("HHSurvey.v_days"))
household_info <- dbReadTable(elmer_connection, SQL("HHSurvey.v_households"))

survey_a <- list(survey = '2017_2019', label = '2017/2019')
survey_b <- list(survey = '2021', label = '2021')
survey_c <- list(survey = '2017', label = '2017')
survey_d <- list(survey = '2019', label = '2019')

# create variables that would like to group

hhts_varsearch("delivery")
hhts_varsearch("traveldate")
hhts_varsearch("race")
hhts_varsearch('income')
hhts_varsearch('age')
hhts_varsearch('county')
hhts_varsearch('home')
hhts_varsearch('race')

names(deliveries)
head(household_info)

unique(household_info$lifecycle)
unique(deliveries$delivery_work_freq)

delivery_type <- c("household_id", "delivery_food_freq", "delivery_grocery_freq", "delivery_pkgs_freq","delivery_work_freq", "deliver_package", 'deliver_work', 'deliver_grocery', 'deliver_food')
days <- c("dayofweek", "typical_day")
hh_data <- c('lifecycle', 'hhincome_broad', 'hhincome_detailed', 'race_category_alone_multi', 'race_eth_broad', 'race_eth_poc', 'race_eth_apoc', 'hh_race_category', 'seattle_home', 'final_home_rgcnum', 'final_home_uvnum', 'final_home_is_rgc')

# getting variables from tables for 2017, 2019, 2017/2019, 2021

#


```

```{r}
smp_delivery_fx <- function(data, year) {
  ## rewriting labels of responses to be more concise
  temp_table <- data %>%
    mutate(delivery_food_all= case_when((is.na(delivery_food_freq) & is.na(deliver_food)) ~ 'No Response',
                                        delivery_food_freq == "0 (none)"  ~ 'No Delivery',
                                        deliver_food=='No' ~ 'No Delivery',
                                        TRUE ~ 'Delivery Received'))%>%
    mutate(delivery_pkgs_all= case_when((is.na(delivery_pkgs_freq) & is.na(deliver_package)) ~ 'No Response',
                                        delivery_pkgs_freq == "0 (none)"  ~ 'No Delivery',
                                        deliver_package=='No' ~ 'No Delivery',
                                        TRUE ~ 'Delivery Received'))%>%
    mutate(delivery_grocery_all= case_when((is.na(delivery_grocery_freq) & is.na(deliver_grocery)) ~ 'No Response',
                                        delivery_grocery_freq == "0 (none)"  ~ 'No Delivery',
                                        deliver_grocery=='No' ~ 'No Delivery',
                                        TRUE ~ 'Delivery Received'))%>%
    mutate(delivery_work_all= case_when((is.na(delivery_work_freq) & is.na(deliver_work)) ~ 'No Response',
                                        delivery_work_freq == "0 (none)"  ~ 'No Delivery',
                                        deliver_work =='No' ~ 'No Delivery',
                                        TRUE ~ 'Delivery Received'))
  temp_table 
}

smp_delivery_fx_hh <- function(data, year) {
  ## rewriting labels of responses to be more concise
  temp_table <- data %>%
    mutate(hhincome_broad= case_when(hhincome_broad=='$100,000-$199,000' ~ '$100,000 or more',
                                     hhincome_broad=='$200,000 or more' ~ '$100,000 or more',
                                     TRUE~hhincome_broad))%>%
    mutate(lifecycle= case_when(lifecycle == "Household size > 1, Householder age 65+" | 
                                  lifecycle == "Household size = 1, Householder age 65+"  ~ '65 years or older', 
                                lifecycle == "Household size > 1, Householder age 35 - 64" |
                                  lifecycle == "Household size = 1, Householder age 35 - 64" ~ '35-64 years',
                                lifecycle == "Household size > 1, Householder under age 35" |
                                  lifecycle == "Household size = 1, Householder under age 35" ~ 'Under 35 years, no kids',
                                lifecycle == "Household includes children age 5-17" ~ 'Household has ages 5-17',
                                lifecycle == "Household includes children under 5" ~ 'Household has ages under 5'))
  temp_table
}

# new function combining the delivery and household functions into one and ordering income by levels

smp_delivery_combo <- function(data, year) {
  ## rewriting labels of responses to be more concise
  temp_table <- data %>%
    mutate(delivery_food_all= case_when((is.na(delivery_food_freq) & is.na(deliver_food)) ~ 'No Response',
                                        delivery_food_freq == "0 (none)"  ~ 'No Delivery',
                                        deliver_food=='No' ~ 'No Delivery',
                                        TRUE ~ 'Delivery Received'))%>%
    mutate(delivery_pkgs_all= case_when((is.na(delivery_pkgs_freq) & is.na(deliver_package)) ~ 'No Response',
                                        delivery_pkgs_freq == "0 (none)"  ~ 'No Delivery',
                                        deliver_package=='No' ~ 'No Delivery',
                                        TRUE ~ 'Delivery Received'))%>%
    mutate(delivery_grocery_all= case_when((is.na(delivery_grocery_freq) & is.na(deliver_grocery)) ~ 'No Response',
                                        delivery_grocery_freq == "0 (none)"  ~ 'No Delivery',
                                        deliver_grocery=='No' ~ 'No Delivery',
                                        TRUE ~ 'Delivery Received'))%>%
    mutate(delivery_work_all= case_when((is.na(delivery_work_freq) & is.na(deliver_work)) ~ 'No Response',
                                        delivery_work_freq == "0 (none)"  ~ 'No Delivery',
                                        deliver_work =='No' ~ 'No Delivery',
                                        TRUE ~ 'Delivery Received'))%>%
    mutate(hhincome_broad = factor(case_when(as.character(hhincome_broad) %in% c("$100,000-$199,000","$200,000 or more") ~ 
                                             "$100,000 or more", !is.na(hhincome_broad) ~ as.character(hhincome_broad)),
                                 levels=c("Under $25,000", 
                                          "$25,000-$49,999", 
                                          "$50,000-$74,999", 
                                          "$75,000-$99,999", 
                                          "$100,000 or more", 
                                          "Prefer not to answer")))%>%
    mutate(lifecycle= case_when(lifecycle == "Household size > 1, Householder age 65+" | 
                                  lifecycle == "Household size = 1, Householder age 65+"  ~ '65 years or older', 
                                  lifecycle == "Household size > 1, Householder age 35 - 64" |
                                  lifecycle == "Household size = 1, Householder age 35 - 64" ~ '35-64 years',
                                  lifecycle == "Household size > 1, Householder under age 35" |
                                  lifecycle == "Household size = 1, Householder under age 35" ~ 'Under 35 years, no kids',
                                  lifecycle == "Household includes children age 5-17" ~ 'Household has ages 5-17',
                                  lifecycle == "Household includes children under 5" ~ 'Household has ages under 5'))
  temp_table
}
```

```{r}


# -- How frequently is someone having a delivery made?? 
# -- 2017, 2019, 2017/2019, 2021

# pull datasets from two separate dataframes per year

dsurvey_17 <- get_hhts(survey = survey_c$survey, 
                        level = "d", 
                        vars = c(delivery_type, days, hh_data)) 



dsurvey_19 <- get_hhts(survey = survey_d$survey, 
                       level = "d", 
                       vars = c(delivery_type, days, hh_data)) 



dsurvey_1719 <- get_hhts(survey = survey_a$survey, 
                       level = "d", 
                       vars = c(delivery_type, days, hh_data)) 



dsurvey_21 <- get_hhts(survey = survey_b$survey, 
                       level = "d", 
                       vars = c(delivery_type, days, hh_data)) 



```

```{r}

# transform data

delivery_17 <- smp_delivery_combo(dsurvey_17, '2017')


delivery_19 <- smp_delivery_combo(dsurvey_19, '2019')


delivery_1719 <- smp_delivery_combo(dsurvey_1719, '2017/2019')


delivery_21 <- smp_delivery_combo(dsurvey_21, '2021')


```

```{r}
# merge the two datasets
# using dplyr and readr to join based on common variable name

joined_df_deliveries_17 <-delivery_17

joined_df_deliveries_19 <- delivery_19

joined_df_deliveries_1719 <- delivery_1719

joined_df_deliveries_21 <- delivery_21

```


#some checks
# These sums should match the number of people in the region.
# In 2021, this represents the number of adults because we did not observe children's days.
```{r}
sum(joined_df_deliveries_17$day_weight_2017_v2021)
sum(joined_df_deliveries_19$day_weight_2019_v2021)
sum(joined_df_deliveries_1719$day_weight_2017_2019_v2021)
sum(joined_df_deliveries_21$person_weight_2021_ABS_panel_adult)

```
It looks like the day weight for 2017_2019 should be halved. That may have been an oversight.


```{r}
joined_df_deliveries_1719$day_weight_2017_2019_v2021<-joined_df_deliveries_1719$day_weight_2017_2019_v2021/2
sum(joined_df_deliveries_1719$day_weight_2017_2019_v2021)


```


# These sums should match the number of households in the region, if every household had a person respond.  They did not. There was a bit of non-response. We should look into this more later by grouping the results by hhid and seeing which hhid do not have any responses.
```{r}
hh_rep_2017<-joined_df_deliveries_17%>%group_by(delivery_food_all)%>%summarise(hh_days=sum(day_weight_2017_v2021))
hh_rep_2019<-joined_df_deliveries_19%>%group_by(delivery_food_all)%>%summarise(hh_days=sum(day_weight_2019_v2021))
hh_rep_2021<-joined_df_deliveries_21%>%group_by(delivery_food_all)%>%summarise(hh_days=sum(person_weight_2021_ABS_panel_adult))


hh_rep_2017
hh_rep_2019
hh_rep_2021

```
```{r}
joined_df_deliveries_17<-joined_df_deliveries_17%>%filter(delivery_food_all !='No Response')
joined_df_deliveries_19<-joined_df_deliveries_19%>%filter(delivery_food_all !='No Response')
joined_df_deliveries_21<-joined_df_deliveries_21%>%filter(delivery_food_all !='No Response')
```

```{r}

count_food_17 <- hhts_count(joined_df_deliveries_17, group_vars = "delivery_food_all",
                                     spec_wgt = "day_weight_2017_v2021")%>%
  filter(delivery_food_all== "Delivery Received")

# have tried the double variable // crosstab with day weight and not recognized, so automatically applies household weight

count_food_19 <- hhts_count(joined_df_deliveries_19, group_vars = "delivery_food_all",
                               spec_wgt = "day_weight_2019_v2021")%>%
  filter(delivery_food_all == "Delivery Received")




count_food_21 <- hhts_count(joined_df_deliveries_21, group_vars = "delivery_food_all",
                               spec_wgt = "person_weight_2021_ABS_panel_adult") %>%
  filter(delivery_food_all == "Delivery Received")


# merge data frames for combined 2017/2019 and 2021
# write csv and plot

food_freq_separate <- rbind(count_food_17, count_food_19, count_food_21)


write.csv(food_freq_separate, 'delivery_by_freq_food2.csv')



food_c<-create_column_chart(t=food_freq_separate, w.x='delivery_food_all', w.y='share', f='survey', w.moe='share_moe', 
                          est.type='percent', w.color = 'psrc_light')+
  xlab(as.character('Number of Food Deliveries Per Day')) + ylab('Share of Households Receiving These Types of Deliveries')+
  theme(axis.text.x = element_text(size=14,color="#4C4C4C"))+ 
  theme(axis.title.x = element_text(size=20,color="#4C4C4C"))+
  theme(axis.title.y = element_text(size=8,color="#4C4C4C"))



print(food_c)






```
```{r}

count_pkgs_17 <- hhts_count(joined_df_deliveries_17, group_vars = "delivery_pkgs_all",
                                     spec_wgt = "day_weight_2017_v2021")%>%
  filter(delivery_pkgs_all== "Delivery Received")

# have tried the double variable // crosstab with day weight and not recognized, so automatically applies household weight

count_pkgs_19 <- hhts_count(joined_df_deliveries_19, group_vars = "delivery_pkgs_all",
                               spec_wgt = "day_weight_2019_v2021")%>%
  filter(delivery_pkgs_all == "Delivery Received")




count_pkgs_21 <- hhts_count(joined_df_deliveries_21, group_vars = "delivery_pkgs_all",
                               spec_wgt = "person_weight_2021_ABS_panel_adult") %>%
  filter(delivery_pkgs_all == "Delivery Received")


# merge data frames for combined 2017/2019 and 2021
# write csv and plot

pkgs_freq_separate <- rbind(count_pkgs_17, count_pkgs_19, count_pkgs_21)


write.csv(pkgs_freq_separate, 'delivery_by_freq_pkgs2.csv')



pkgs_c<-create_column_chart(t=pkgs_freq_separate, w.x='delivery_pkgs_all', w.y='share', f='survey', w.moe='share_moe', 
                          est.type='percent', w.color = 'psrc_light')+
  xlab(as.character('Number of pkgs Deliveries Per Day')) + ylab('Share of Households Receiving These Types of Deliveries')+
  theme(axis.text.x = element_text(size=14,color="#4C4C4C"))+ 
  theme(axis.title.x = element_text(size=20,color="#4C4C4C"))+
  theme(axis.title.y = element_text(size=8,color="#4C4C4C"))



print(pkgs_c)






```
```{r}

count_grocery_17 <- hhts_count(joined_df_deliveries_17, group_vars = "delivery_grocery_all",
                                     spec_wgt = "day_weight_2017_v2021")%>%
  filter(delivery_grocery_all== "Delivery Received")

# have tried the double variable // crosstab with day weight and not recognized, so automatically applies household weight

count_grocery_19 <- hhts_count(joined_df_deliveries_19, group_vars = "delivery_grocery_all",
                               spec_wgt = "day_weight_2019_v2021")%>%
  filter(delivery_grocery_all == "Delivery Received")




count_grocery_21 <- hhts_count(joined_df_deliveries_21, group_vars = "delivery_grocery_all",
                               spec_wgt = "person_weight_2021_ABS_panel_adult") %>%
  filter(delivery_grocery_all == "Delivery Received")


# merge data frames for combined 2017/2019 and 2021
# write csv and plot

grocery_freq_separate <- rbind(count_grocery_17, count_grocery_19, count_grocery_21)


write.csv(grocery_freq_separate, 'delivery_by_freq_grocery2.csv')



grocery_c<-create_column_chart(t=grocery_freq_separate, w.x='delivery_grocery_all', w.y='share', f='survey', w.moe='share_moe', 
                          est.type='percent', w.color = 'psrc_light')+
  xlab(as.character('Number of grocery Deliveries Per Day')) + ylab('Share of Households Receiving These Types of Deliveries')+
  theme(axis.text.x = element_text(size=14,color="#4C4C4C"))+ 
  theme(axis.title.x = element_text(size=20,color="#4C4C4C"))+
  theme(axis.title.y = element_text(size=8,color="#4C4C4C"))



print(grocery_c)






```
```{r}
count_work_17 <- hhts_count(joined_df_deliveries_17, group_vars = "delivery_work_all",
                                     spec_wgt = "day_weight_2017_v2021")%>%
  filter(delivery_work_all== "Delivery Received")

# have tried the double variable // crosstab with day weight and not recognized, so automatically applies household weight

count_work_19 <- hhts_count(joined_df_deliveries_19, group_vars = "delivery_work_all",
                               spec_wgt = "day_weight_2019_v2021")%>%
  filter(delivery_work_all == "Delivery Received")




count_work_21 <- hhts_count(joined_df_deliveries_21, group_vars = "delivery_work_all",
                               spec_wgt = "person_weight_2021_ABS_panel_adult") %>%
  filter(delivery_work_all == "Delivery Received")


# merge data frames for combined 2017/2019 and 2021
# write csv and plot

work_freq_separate <- rbind(count_work_17, count_work_19, count_work_21)


write.csv(work_freq_separate, 'delivery_by_freq_work2.csv')



work_c<-create_column_chart(t=work_freq_separate, w.x='delivery_work_all', w.y='share', f='survey', w.moe='share_moe', 
                          est.type='percent', w.color = 'psrc_light')+
  xlab(as.character('Number of service Deliveries Per Day')) + ylab('Share of Households Receiving These Types of Deliveries')+
  theme(axis.text.x = element_text(size=14,color="#4C4C4C"))+ 
  theme(axis.title.x = element_text(size=20,color="#4C4C4C"))+
  theme(axis.title.y = element_text(size=8,color="#4C4C4C"))



print(work_c)
```

```{r, eval = FALSE}
## this chunk is essentially what was performed above so not necessary, see eval = FALSE


# crosstabs for income and food delivery by share and count (across years)
test2 <- hhts_count(joined_df_deliveries_17, spec_wgt = 'day_weight_2017_v2021', 
                    group_vars = c('delivery_food_all', 'hhincome_broad')) %>% 
  filter(hhincome_broad != 'Total')

# merge dfs for 2017, 2017/2019, and 2021 - alternate approach for crosstabs
all_food_freq_17_21 <- bind_rows(count_food_17, count_food_19, count_food_21) %>%
  mutate(period = as.factor(survey))

table(all_food_freq_17_21$delivery_food_all, all_food_freq_17_21$period)


# plotting count and share

count_and_share_plot <- function(dt, grp_var, num_var, legend_name, tbl_name){
 
   fill_group <- dt[[grp_var]]
   x_axis_grp <- dt[[num_var]]
  
  count_plot <- ggplot(dt,
                       aes(x=x_axis_grp,
                           y=count,
                           fill = survey)) +
    geom_bar(stat="identity",
             position="dodge2") +
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Number") +
    scale_y_continuous(labels = scales::comma) +
    geom_errorbar(aes(ymin=count-count_moe, ymax=count+count_moe),
                  position = position_dodge2(width = 0.9, preserve = "single", padding = .5))
         
  share_plot <- ggplot(dt,
                       aes(x=x_axis_grp,
                           y=share,
                           fill = survey)) +
    geom_bar(stat="identity",
             position="dodge2") +
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  position = position_dodge2(width = 0.9, preserve = "single", padding = .5))
  
  trips <- ggarrange(count_plot, share_plot, 
                     # ncol = 2, nrow = 1,
                     common.legend = TRUE,
                     legend = "right")
  
  annotate_figure(trips, top = text_grob(tbl_name, 
                                         color = "blue", face = "bold", size = 14))
}

count_and_share_plot(all_food_freq_17_21,
                     "survey",
                     "delivery_food_all",
                     "Number of Deliveries per Household",
                     "Number vs Share of Trips by Destination")
```

```{r}
# crosstabs for income and food delivery by share and count (across years)

food_income_17 <- hhts_count(joined_df_deliveries_17, spec_wgt = 'day_weight_2017_v2021', 
                    group_vars = c('hhincome_broad', 'delivery_food_all')) %>% 
  filter(hhincome_broad != 'Total')%>%
  filter(delivery_food_all != 'Total')%>%
  filter(delivery_food_all != 'No Delivery')

food_income_19 <- hhts_count(joined_df_deliveries_19, spec_wgt = 'day_weight_2019_v2021', 
                    group_vars = c('hhincome_broad', 'delivery_food_all')) %>% 
  filter(hhincome_broad != 'Total')%>%
  filter(delivery_food_all != 'Total')%>%
  filter(delivery_food_all != 'No Delivery')

food_income_21 <- hhts_count(joined_df_deliveries_21, spec_wgt = 'person_weight_2021_ABS_panel_adult', 
                    group_vars = c('hhincome_broad', 'delivery_food_all')) %>% 
  filter(hhincome_broad != 'Total')%>%
  filter(delivery_food_all != 'Total')%>%
  filter(delivery_food_all != 'No Delivery')

# merge dfs for 2017, 2017/2019, and 2021 - alternate approach for crosstabs
all_food_freq_17_21 <- bind_rows(food_income_17, food_income_19, food_income_21) %>%
  mutate(period = as.factor(survey))

table(all_food_freq_17_21$delivery_food_all, all_food_freq_17_21$period)

# plot by year and by category

share_plot_by_year <- function(dt1, dt2, dt3, grp_var, grp_var2, legend_name){
  
  fill_group <- all_food_freq_17_21[[grp_var]]
  x_axis_grp <- all_food_freq_17_21[[grp_var2]]
  
  ggplot(all_food_freq_17_21, aes(x=x_axis_grp,
                                       y=share,
                                       fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~period)+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
  
}

share_plot_by_year2 <- function(dt1, dt2, dt3, grp_var, grp_var2, legend_name){
  
  fill_group <- all_food_freq_17_21[[grp_var]]
  x_axis_grp <- all_food_freq_17_21[[grp_var2]]
  
  ggplot(all_food_freq_17_21, aes(x=x_axis_grp,
                                       y=share,
                                       fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~delivery_food_all)+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
  
}

share_plot_by_cat <- function(dt1, dt2, dt3, grp_var, grp_var2, legend_name){
  
  fill_group <- all_food_freq_17_21[[grp_var]]
  # facet_group <- all_commute_17_21[[grp_var2]]
  
  ggplot(all_food_freq_17_21, aes(x=period,
                                       y=share,
                                       fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~all_food_freq_17_21[[grp_var2]])+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
}

count_plot_by_cat <- function(dt1, dt2, dt3, grp_var, grp_var2, legend_name){
  
  fill_group <- all_food_freq_17_21[[grp_var]]
  # facet_group <- all_commute_17_21[[grp_var2]]
  
  ggplot(all_food_freq_17_21, aes(x=period,
                                       y=count,
                                       fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~all_food_freq_17_21[[grp_var2]])+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Count",
         fill = legend_name) +
    scale_y_continuous(labels = scales::comma) +
    geom_errorbar(aes(ymin=count-count_moe, ymax=count+count_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
}

# comparative charts/plots
# share_plot_by_year <- function(dt1, dt2, dt3, grp_var, grp_var2, legend_name)
share_plot_by_year(food_income_17, food_income_19, food_income_21,
                   'hhincome_broad', 'delivery_food_all', 
                   'Food Deliveries to Households by Income')

share_plot_by_year2(food_income_17, food_income_19, food_income_21,
                   'survey', 'hhincome_broad',  
                    'Food Deliveries by Year')

share_plot_by_cat(food_income_17, food_income_19, food_income_21, 
                  'hhincome_broad', 'delivery_food_all',
                  'Income Categories')+
  psrc_style()+
  scale_fill_discrete_psrc("psrc_light")

count_plot_by_cat(food_income_17, food_income_19, food_income_21, 
                  'hhincome_broad', 'delivery_food_all',
                  'Income Categories')+
  psrc_style()+
  scale_fill_discrete_psrc("psrc_light")

```

```{r}
# crosstabs for lifecycle and food delivery by share and count (across years)

food_lifecycle_17 <- hhts_count(joined_df_deliveries_17, spec_wgt = 'day_weight_2017_v2021', 
                    group_vars = c('delivery_food_all', 'lifecycle')) %>% 
  filter(lifecycle != 'Total')

food_lifecycle_19 <- hhts_count(joined_df_deliveries_19, spec_wgt = 'day_weight_2019_v2021', 
                    group_vars = c('delivery_food_all', 'lifecycle')) %>% 
  filter(lifecycle != 'Total')

food_lifecycle_21 <- hhts_count(joined_df_deliveries_21, spec_wgt = 'person_weight_2021_ABS_panel_adult', 
                    group_vars = c('delivery_food_all', 'lifecycle')) %>% 
  filter(lifecycle != 'Total')

## STOPPED HERE 

# merge dfs for 2017, 2017/2019, and 2021 - alternate approach for crosstabs
all_food_freq_17_21 <- bind_rows(table_food_17, table_food_19, table_food_21) %>%
  mutate(period = as.factor(survey))

table(all_food_freq_17_21$delivery_food_all, all_food_freq_17_21$period)

# plot by year and by category

share_plot_by_year <- function(dt1, dt2, dt3, grp_var, grp_var2, legend_name){
  
  fill_group <- all_food_freq_17_21[[grp_var]]
  x_axis_grp <- all_food_freq_17_21[[grp_var2]]
  
  ggplot(all_food_freq_17_21, aes(x=x_axis_grp,
                                       y=share,
                                       fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~period)+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
  
}

share_plot_by_year2 <- function(dt1, dt2, dt3, grp_var, grp_var2, legend_name){
  
  fill_group <- all_food_freq_17_21[[grp_var]]
  x_axis_grp <- all_food_freq_17_21[[grp_var2]]
  
  ggplot(all_food_freq_17_21, aes(x=x_axis_grp,
                                       y=share,
                                       fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~delivery_food_all)+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
  
}

share_plot_by_cat <- function(dt1, dt2, dt3, grp_var, grp_var2, legend_name){
  
  fill_group <- all_food_freq_17_21[[grp_var]]
  # facet_group <- all_commute_17_21[[grp_var2]]
  
  ggplot(all_food_freq_17_21, aes(x=period,
                                       y=share,
                                       fill=fill_group)) +
    geom_bar(stat="identity",
             position="dodge2") +
    facet_wrap(~all_food_freq_17_21[[grp_var2]])+
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
          axis.title.x = element_blank()) +
    labs(y = "Share",
         fill = legend_name) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe),
                  size=.5, width=.2,
                  position=position_dodge(0.9))
}

# comparative charts/plots
# share_plot_by_year <- function(dt1, dt2, dt3, grp_var, grp_var2, legend_name)
share_plot_by_year(table_food_17, table_food_19, table_food_21,
                   'hhincome_broad', 'delivery_food_all', 
                   'Food Deliveries to Households by Income')

share_plot_by_year2(table_food_17, table_food_19, table_food_21,
                   'survey', 'hhincome_broad',  
                    'Food Deliveries by Year')

share_plot_by_cat(table_food_17, table_food_19, table_food_21, 
                  'hhincome_broad', 'delivery_food_all',
                  'Income Categories')+
  psrc_style()+
  scale_fill_discrete_psrc("psrc_light")

```

```

