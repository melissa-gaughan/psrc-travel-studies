---
title: "Regional Growth Center Analysis using 2017, 2019, and 2021 travel surveys"
author: "Joanne Lin"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
---


```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE,
                      fig.align = "center"
                      # out.width = '50%'
                      ) # formatting
setwd("C:/Joanne_PSRC/data_science/travel-studies/2021/analysis_in_progress/rgcs_vehicle_ownership")

# connect to script with functions
source("rgcs_functions.R")

```

```{r library setup, include=FALSE}
# psrc packages
library(psrc.travelsurvey)
library(psrcplot)
library(psrctrends)

library(tidyverse)
# library(stringr)
# library(tidycensus)
# library(htmlwidgets)
install_psrc_fonts()
```


# Variables we might want to summarize
```{r Variable, echo=TRUE}

gen_vars<-c('sample_county', 
            'vehicle_count',  
            "hhincome_broad",
            'hhincome_detailed', 
            "age", 
            "age_category", 
            'final_home_is_rgc', 
            'race_category', 
            'race_eth_broad', 
            'dest_purpose_cat', 
            'origin_purpose_cat', 
            'trip_path_distance', 
            'person_id')

# remember to filter out drivers for hov trips
# not a problem = the weights are 0 anyways
trip_vars = c("hhid",
              "survey_year",
              # "personid",
              # "pernum",
              "hhincome_broad",
              "age", 
              "age_category",
              'final_home_is_rgc',
              "dayofweek",
              # "tripid",
              "depart_time_hhmm",
              "travelers_total",
              # "o_purpose",
              # "o_purp_cat",
              # "d_purpose",
              # "d_purp_cat",
              "mode_1",
              # "mode_type",
              "driver",
              "pool_start",
              "change_vehicles",
              "toll",
              "toll_pay",
              "taxi_pay",
              "mode_acc",
              "mode_egr",
              "speed_mph")


hh_vars=c("hhid",
          "sample_county",
          "survey_year",
          "final_home_is_rgc",
          "hhsize",
          "vehicle_count",
          "hhincome_broad",
          "hhincome_detailed", 
          "numadults",
          "numchildren",
          "numworkers",
          "lifecycle",
          "num_trips",  
          "res_factors_30min",
          "res_factors_afford",
          "res_factors_closefam",
          "res_factors_hhchange",
          "res_factors_hwy",
          "res_factors_school",
          "res_factors_space",
          "res_factors_transit",
          "res_factors_walk",
          "res_factors_cultural",  
          "res_dur",
          "res_type",
          "res_months",
          "broadband",
          "offpark",
          "offpark_cost",
          "streetpark")
```

Get the data from Elmer.
```{r trip + household data, include=FALSE}
# trip_data_17_19<- get_hhts("2017_2019", "t", vars=trip_vars)
# trip_data_21<- get_hhts("2021", "t", vars=trip_vars)

hh_data_17_19<- get_hhts("2017_2019", "h", vars=hh_vars)
hh_data_21<- get_hhts("2021", "h", vars=hh_vars)
unique(c(hh_data_17_19$vehicle_count, hh_data_21$vehicle_count))
```


# Household analysis

  * Group variables into meaningful categories with statistically large enough groups.First for trips, group the data.
```{r Group variables, include=FALSE}
hh_group_17_19 <- hh_data_17_19 %>% hh_group_data()
hh_group_21 <- hh_data_21 %>% hh_group_data()
# hh_group <- hh_group_17_19 %>%
#   rename(hh_weight = hh_weight_2017_2019_v2021) %>%
#   add_row(
#     hh_group_21 %>%
#       rename(hh_weight = hh_weight_2021_ABS)
#     )
# 
# unique(hh_group_21$survey)
# 
# names(hh_group_17_19)
```

## Analysis for basic demographic distribution
1. Number of vehicles  
```{r}
plot  <- hhts_count(hh_group_21, group_vars=c("final_home_is_rgc","vehicle_count")) %>%
  filter(vehicle_count!="Total") %>%
  add_row(hhts_count(hh_group_17_19, group_vars=c("final_home_is_rgc","vehicle_count")) %>%
            filter(vehicle_count!="Total"))


create_facet_bar_chart (t=plot, w.x="vehicle_count",w.y="share", 
                        f="survey", g= "final_home_is_rgc",
                        w.scales="fixed",
                        w.title="Number of vehicles",
                        # source="Source: Household travel survey",
                        w.moe="share_moe", w.color="psrc_light")
```
2. Income  
```{r}
plot  <- hhts_count(hh_group_21, group_vars=c("final_home_is_rgc","hhincome_binary")) %>%
  filter(hhincome_binary!="Total",
         hhincome_binary!="Prefer not to answer") %>%
  add_row(hhts_count(hh_group_17_19, group_vars=c("final_home_is_rgc","hhincome_binary")) %>%
            filter(hhincome_binary!="Total",
            hhincome_binary!="Prefer not to answer"))


create_facet_bar_chart (t=plot, w.x="hhincome_binary",w.y="share", 
                        f="survey", g= "final_home_is_rgc",
                        w.scales="fixed",
                        w.title="Household income",
                        # source="Source: Household travel survey",
                        w.moe="share_moe", w.color="psrc_light")

```

3. County  
```{r}
plot  <- hhts_count(hh_group_21, group_vars=c("final_home_is_rgc","sample_county")) %>%
  filter(sample_county!="Total") %>%
  add_row(hhts_count(hh_group_17_19, group_vars=c("final_home_is_rgc","sample_county")) %>%
            filter(sample_county!="Total"))


create_facet_bar_chart (t=plot, w.x="sample_county",w.y="share", 
                        f="survey", g= "final_home_is_rgc",
                        w.scales="fixed",
                        w.title="County",
                        # source="Source: Household travel survey",
                        w.moe="share_moe", w.color="psrc_light")

```



## Deeper analysis on vehicle ownership
1. Number of vehicles in RGCs of each county
  * only households in RGCs are included in the chart
  * King county has a different trend compared to other counties  
```{r}
plot  <- hhts_count(hh_group_21, group_vars=c("final_home_is_rgc","sample_county","vehicle_binary")) %>%
  filter(vehicle_binary!="Total") %>%
  add_row(hhts_count(hh_group_17_19, group_vars=c("final_home_is_rgc","sample_county","vehicle_binary")) %>%
  filter(vehicle_binary!="Total")) %>%
  filter(final_home_is_rgc == "RGC")


create_facet_bar_chart (t=plot, w.x="vehicle_binary",w.y="share", 
                        f="sample_county", g= "survey",
                        w.title="Number of vehicles in RGCs of each county",
                        w.scales="fixed",
                        # source="Source: Household travel survey",
                        # w.moe="share_moe",
                        w.color="psrc_light")

```


```{r, include=FALSE}
# plot_chart <- function(.data, vars) {
#   .data %>% 
#     group_by(final_home_is_rgc,survey) %>% 
#     mutate(num_hh = n()) %>% 
#     group_by(final_home_is_rgc, survey, num_hh, {{vars}}) %>% 
#     summarise(counts = n()) %>%
#     ungroup() %>%
#     mutate(per = counts*100/num_hh)
# }
# 
# plot_chart_w <- function(.data, vars) {
#   .data %>% 
#     group_by(final_home_is_rgc,survey) %>% 
#     mutate(num_hh = sum(hh_weight)) %>% 
#     group_by(final_home_is_rgc, survey, num_hh, {{vars}}) %>% 
#     summarise(counts = sum(hh_weight)) %>%
#     ungroup() %>%
#     mutate(per = counts*100/num_hh)
# }
# 
# plot_vehicle_count_w <- hh_group %>% plot_chart_w(vehicle_count)
# plot_vehicle_count <- hh_group %>% plot_chart(vehicle_count)
# plot_vehicle_count$vehicle_count <- factor(plot_vehicle_count$vehicle_count, 
#                              levels=c("No vehicle","1","2","3","4 or more"))
# plot_vehicle_count_w$vehicle_count <- factor(plot_vehicle_count_w$vehicle_count, 
#                              levels=c("No vehicle","1","2","3","4 or more"))
# 
# ggplot(plot_vehicle_count_w, 
#        aes(x= vehicle_count, y= per)) +
#   geom_col(aes(fill=survey),position=position_dodge()) +
#   facet_wrap(~final_home_is_rgc) +
#   xlab("Number of vehicles in each household") + 
#   ylab("Percentage of households (%)")+
#   theme_bw()
# 
# 
# # res_dur==
# ggplot(plot_vehicle_count_w, 
#        aes(x= vehicle_count, y= per)) +
#   geom_col(aes(fill=survey),position=position_dodge()) +
#   facet_wrap(~final_home_is_rgc) +
#   xlab("Number of vehicles in each household") + 
#   ylab("Percentage of households (%)")+
#   theme_bw()
# 
# plot_hhsize <- hh_data %>% plot_chart(hhsize)
# 
# ggplot(plot_hhsize, 
#        aes(x= hhsize, y= per)) +
#   geom_col(aes(fill=survey),position=position_dodge()) +
#   facet_wrap(~final_home_is_rgc) +
#   xlab("Household Sizes") + 
#   ylab("Percentage of households (%)")+
#   theme_bw()
# 
# plot_res_type <- test %>% plot_chart(res_type)
# plot_res_type$res_type <- factor(plot_res_type$res_type, 
#                              levels=c("Single-family house", "Townhouse", "Apartment/Condo", "Others"))
# 
# ggplot(plot_res_type, 
#        aes(x= res_type, y= per)) +
#   geom_col(position=position_dodge()) +
#   facet_wrap(~final_home_is_rgc) +
#   xlab("Types of residence") + 
#   ylab("Percentage of households (%)")+
#   theme(axis.text.x = element_text(angle = 45, vjust = 0.9, hjust = 0.8)) 

```


