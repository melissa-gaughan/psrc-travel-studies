---
title: "Regional Growth Center Analysis using 2017, 2019, and 2021 travel surveys"
author: "Joanne Lin"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
---


```{r rmarkdown setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE,
                      fig.align = "center"
                      # out.width = '50%'
                      ) # formatting
setwd("C:/Joanne_PSRC/data_science/travel-studies/2021/analysis_in_progress/rgcs_vehicle_ownership")

# connect to script with functions
source("rgcs_functions.R")


# psrc packages
library(psrc.travelsurvey)
library(psrcplot)
library(psrctrends)


library(tidyverse)
library(stringr)
library(rlang)
library(scales)
# library(tidycensus)
# library(htmlwidgets)

install_psrc_fonts()
```


# Variables we might want to summarize
```{r Variable, echo=TRUE}

gen_vars<-c('sample_county', 
            'vehicle_count',  
            "hhincome_broad",
            'hhincome_detailed', 
            "age", 
            "age_category", 
            'final_home_is_rgc', 
            'race_category', 
            'race_eth_broad', 
            'dest_purpose_cat', 
            'origin_purpose_cat', 
            'trip_path_distance', 
            'person_id')

trip_vars = c("hhid",
              "survey_year",
              # "personid",
              # "pernum",
              "hhincome_broad",
              "age", 
              "age_category",
              'final_home_is_rgc',
              "dayofweek",
              # "tripid",
              "depart_time_hhmm",
              "travelers_total",
              # "o_purpose",
              # "o_purp_cat",
              # "d_purpose",
              # "d_purp_cat",
              "mode_1",
              # "mode_type",
              "driver",
              "pool_start",
              "change_vehicles",
              "toll",
              "toll_pay",
              "taxi_pay",
              "mode_acc",
              "mode_egr",
              "speed_mph")


hh_vars=c("hhid",
          "sample_county",
          "survey_year",
          "final_home_is_rgc",
          "hhsize",
          "vehicle_count",
          "hhincome_broad",
          "hhincome_detailed", 
          "numadults",
          "numchildren",
          "numworkers",
          "lifecycle",
          "num_trips",  
          "res_factors_30min",
          "res_factors_afford",
          "res_factors_closefam",
          "res_factors_hhchange",
          "res_factors_hwy",
          "res_factors_school",
          "res_factors_space",
          "res_factors_transit",
          "res_factors_walk",
          "res_factors_cultural",  
          "res_dur",
          "res_type",
          "res_months",
          "broadband",
          "offpark",
          "offpark_cost",
          "streetpark")
```

Get the data from Elmer.
```{r trip + household data, include=FALSE}
# trip_data_17_19<- get_hhts("2017_2019", "t", vars=trip_vars)
# trip_data_21<- get_hhts("2021", "t", vars=trip_vars)

hh_data_17_19<- get_hhts("2017_2019", "h", vars=hh_vars)
hh_data_21<- get_hhts("2021", "h", vars=hh_vars)
unique(c(hh_data_17_19$vehicle_count, hh_data_21$vehicle_count))
```


# Household analysis

  * Group variables into meaningful categories with statistically large enough groups.First for trips, group the data.
```{r Group variables, include=FALSE}
hh_group_17_19 <- hh_data_17_19 %>% hh_group_data()
hh_group_21 <- hh_data_21 %>% hh_group_data()
# hh_group <- hh_group_17_19 %>%
#   rename(hh_weight = hh_weight_2017_2019_v2021) %>%
#   add_row(
#     hh_group_21 %>%
#       rename(hh_weight = hh_weight_2021_ABS)
#     )
# 
# table(hh_group$hhincome_broad,hh_group$survey)
# 
# names(hh_group_17_19)
```

## Analysis for basic demographic distribution
1. Number of vehicles  
```{r}
plot  <- hhts_count(hh_group_21, group_vars=c("final_home_is_rgc","vehicle_count")) %>%
  filter(vehicle_count!="Total") %>%
  add_row(hhts_count(hh_group_17_19, group_vars=c("final_home_is_rgc","vehicle_count")) %>%
            filter(vehicle_count!="Total"))


create_facet_bar_chart (t=plot, w.x="vehicle_count",w.y="share", 
                        f="survey", g= "final_home_is_rgc",
                        w.scales="fixed",
                        w.title="Number of vehicles",
                        # source="Source: Household travel survey",
                        w.moe="share_moe", w.color="psrc_light")
```
2. Income 
  * income distribution in each county
```{r income distribution}
plot  <- hhts_count(hh_group_21, group_vars=c("sample_county","hhincome_broad")) %>%
  add_row(hhts_count(hh_group_17_19, group_vars=c("sample_county","hhincome_broad"))) %>%
  filter(hhincome_broad!="Total",
         hhincome_broad!="Prefer not to answer") %>%
  wrap_axis(hhincome_broad)
plot$cat <- factor(plot$cat, levels=c("Under\n$25,000", "$25,000-\n$49,999",
                                      "$50,000-\n$74,999","$75,000-\n$99,999",
                                      "$100,000 or\nmore"))
TT <- "Household income in each county"
ggplot(plot, aes(x=cat, y=share, fill=survey)) +
  geom_col(position = "dodge")+  
  facet_wrap(~sample_county) +
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("psrc_light")+
  theme(axis.text.x = element_text(angle = 45,vjust=0.75))+
  ggtitle(TT)+
  psrc_style()

```
  * income distribution in RGCs of each county
```{r 2021 income distribution (binary)}
plot  <- hhts_count(hh_group_21, group_vars=c("final_home_is_rgc","sample_county","hhincome_binary")) %>%
  filter(hhincome_binary!="Total",
         hhincome_binary!="Prefer not to answer") %>%
  wrap_axis(hhincome_binary)
plot$cat <- factor(plot$cat, levels=c("Under\n$50,000", "$50,000 and\nover"))

TT <- "Household income in RGCs of each county"
ggplot(plot, aes(x=cat, y=share, fill=final_home_is_rgc)) +
  geom_col(position = "dodge")+  
  facet_wrap(~sample_county) +
  scale_y_continuous(labels=percent) +
  scale_fill_discrete_psrc ("pognbgy_10")+
  ggtitle(TT)+
  psrc_style()

```

  * income distribution in RGCs
```{r}
plot  <- hhts_count(hh_group_21, group_vars=c("final_home_is_rgc","hhincome_binary")) %>%
  filter(hhincome_binary!="Total",
         hhincome_binary!="Prefer not to answer") %>%
  add_row(hhts_count(hh_group_17_19, group_vars=c("final_home_is_rgc","hhincome_binary")) %>%
            filter(hhincome_binary!="Total",
            hhincome_binary!="Prefer not to answer"))


create_facet_bar_chart (t=plot, w.x="hhincome_binary",w.y="share", 
                        f="survey", g= "final_home_is_rgc",
                        w.scales="fixed",
                        w.title="Household income in RGCs",
                        # source="Source: Household travel survey",
                        w.moe="share_moe", w.color="psrc_light")

```

3. Population distribution 
```{r}
plot  <- hhts_count(hh_group_21, group_vars=c("final_home_is_rgc")) %>%
  filter(final_home_is_rgc!="Total") %>%
  add_row(hhts_count(hh_group_17_19, group_vars=c("final_home_is_rgc")) %>%
            filter(final_home_is_rgc!="Total"))
plot2  <- hhts_count(hh_group_21, group_vars=c("sample_county")) %>%
  filter(sample_county!="Total") %>%
  add_row(hhts_count(hh_group_17_19, group_vars=c("sample_county")) %>%
            filter(sample_county!="Total"))

create_column_chart (t=plot, x="final_home_is_rgc",y="share", 
                        f="survey",
                        title="Population in RGCs",
                        # source="Source: Household travel survey",
                        moe="share_moe", color="psrc_light")
create_column_chart (t=plot2, x="sample_county",y="share", 
                        f="survey", 
                        title="Population in each county",
                        # source="Source: Household travel survey",
                        moe="share_moe", color="psrc_light")

```

# Residence types
```{r 2021 Residence typess}
plot  <- hhts_count(hh_group_21, group_vars=c("final_home_is_rgc","res_type")) %>%
  filter(res_type!="Total") %>%
  add_row(hhts_count(hh_group_17_19, group_vars=c("final_home_is_rgc","res_type")) %>%
            filter(res_type!="Total")) %>%
  wrap_axis(res_type)
plot$cat <- factor(plot$cat, levels=c("Single-\nfamily\nhouse","Townhouse","Apartment/\nCondo","Others"))


create_facet_bar_chart (t=plot, w.x="cat",w.y="share", 
                        f="survey", g= "final_home_is_rgc",
                        w.scales="fixed",
                        w.title="Residence types in RGCs",
                        # source="Source: Household travel survey",
                        w.moe="share_moe", w.color="psrc_light")

```



## Deeper analysis on vehicle ownership
1. Number of vehicles in RGCs of each county
  * only households in RGCs are included in the chart
  * King county has a different trend compared to other counties  
```{r}
plot  <- hhts_count(hh_group_21, group_vars=c("final_home_is_rgc","sample_county","vehicle_binary")) %>%
  filter(vehicle_binary!="Total") %>%
  add_row(hhts_count(hh_group_17_19, group_vars=c("final_home_is_rgc","sample_county","vehicle_binary")) %>%
  filter(vehicle_binary!="Total")) %>%
  filter(final_home_is_rgc == "RGC")


create_facet_bar_chart (t=plot, w.x="vehicle_binary",w.y="share", 
                        f="sample_county", g= "survey",
                        w.title="Number of vehicles in RGCs of each county",
                        w.scales="fixed",
                        # source="Source: Household travel survey",
                        # w.moe="share_moe",
                        w.color="psrc_light")

```
