---
title: "Understanding the impact of data cleaning on model fit and accuracy"
author: "Parastoo Jabbari"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
    toc: TRUE
    toc_depth: 6
    toc_float: TRUE

  pdf_document: default
  word_document: default
---


```{r global-options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE) # formatting
```

This report compares models that are built using 2021 household travel survey data delivered by RSG on August 2 and the same data after cleaning by PSRC team.

```{r Libraries, include=FALSE}
#Load functions script
#source("travel_survey_analysis_functions.R")
library(ggplot2)
library(spatstat)
library(pander)
library(reshape2)
library(table1)
library(knitr)
library(kableExtra)
library(odbc)
library(DBI)
library(data.table)
library(tidyverse)
library(mlogit)
library(dfidx)
library(stargazer)
library(rmarkdown)
library('htmlTable')
```

```{r, message=FALSE}

#Connect to database
db.connect <- function() {
  elmer_connection <- dbConnect(odbc(),
                                driver = "SQL Server",
                                server = "AWS-PROD-SQL\\Sockeye",
                                database = "Elmer",
                                trusted_connection = "yes"
  )
}
con = db.connect()

# a function to read tables and queries from Elmer
read.dt <- function(astring, type =c('table_name', 'sqlquery')) {
  elmer_connection <- db.connect()
  if (type == 'table_name') {
    dtelm <- dbReadTable(elmer_connection, SQL(astring))
  } else {
    dtelm <- dbGetQuery(elmer_connection, SQL(astring))
  }
  dbDisconnect(elmer_connection)
  dtelm
}



sql.query = paste("SELECT [recid]
      ,[hhid]
      ,[personid]
      ,[pernum]
      ,[tripid]
      ,[tripnum]
      ,[traveldate]
      ,[daynum]
      ,[dayofweek]
      ,[data_source]
      ,[hhgroup]
      ,[depart_time_mam]
      ,[depart_time_timestamp]
      ,[arrival_time_mam]
      ,[arrival_time_timestamp]
      ,[origin_lat]
      ,[origin_lng]
      ,[dest_lat]
      ,[dest_lng]
      ,[trip_path_distance]
      ,[google_duration]
      ,[reported_duration]
      ,[travelers_total]
      ,[origin_purpose]
      ,[origin_purpose_cat]
      ,[dest_purpose]
      ,[dest_purpose_cat]
      ,[mode_1]
      ,[transit_systems]
      ,[transit_lines]
      ,[psrc_inserted]
      ,[driver]
      ,[mode_type]
      ,[origin_name]
      ,[dest_name] 
  FROM [hhts_cleaning].[HHSurvey].[Trip]")
trips = read.dt(sql.query, 'sqlquery')

sql.query2 = paste("SELECT [age], [personid], [gender], [employment] ,[race_afam]
      ,[student]
      ,[worker]
      ,[education]
      ,[license]
      ,[race_aiak]
      ,[race_asian]
      ,[race_hapi]
      ,[race_hisp]
      ,[race_white]
      ,[race_other]
      ,[race_noanswer]
      ,[industry]
       FROM [hhts_cleaning].[HHSurvey].[Person]")
persons = read.dt(sql.query2, 'sqlquery')

sql.query3 = paste("SELECT [hhincome_detailed]
      ,[hhid]
      ,[vehicle_count]
      ,[rent_own]
      ,[numchildren]
      ,[numworkers]
      ,[hhsize]
      ,[final_home_tract]
      ,[reported_lat]
      ,[reported_lng] FROM [hhts_cleaning].[HHSurvey].[Household]")
hhs = read.dt(sql.query3, 'sqlquery')



#Merge age, race, and income data to trips dataset
df<-merge(trips,persons, by = "personid", all.x = T, all.y = F)
df_cleaned<-merge(df,hhs, by = "hhid", all.x = T, all.y = F)

remove(trips,persons,hhs)
```

## 1. Commute Mode Choice Model


```{r, message=FALSE}

# a function to read tables and queries from Elmer
read.dt <- function(astring, type =c('table_name', 'sqlquery')) {
  elmer_connection <- db.connect()
  if (type == 'table_name') {
    dtelm <- dbReadTable(elmer_connection, SQL(astring))
  } else {
    dtelm <- dbGetQuery(elmer_connection, SQL(astring))
  }
  dbDisconnect(elmer_connection)
  dtelm
}



sql.query = paste("SELECT [hhid]
      ,[personid]
      ,[pernum]
      ,[tripid]
      ,[tripnum]
      ,[traveldate]
      ,[daynum]
      ,[dayofweek]
      ,[data_source]
      ,[hhgroup]
      ,[depart_time_mam]
      ,[depart_time_timestamp]
      ,[arrival_time_mam]
      ,[arrival_time_timestamp]
      ,[origin_lat]
      ,[origin_lng]
      ,[dest_lat]
      ,[dest_lng]
      ,[trip_path_distance]
      ,[google_duration]
      ,[reported_duration]
      ,[travelers_total]
      ,[origin_purpose]
      ,[origin_purpose_cat]
      ,[dest_purpose]
      ,[dest_purpose_cat]
      ,[mode_1]
      ,[driver]
      ,[mode_type]
      ,[origin_name]
      ,[dest_name] 
  FROM [hhts_cleaning].[dbo].[hts_trip]")
trips = read.dt(sql.query, 'sqlquery')

sql.query2 = paste("SELECT [age], [personid], [gender], [employment] ,[race_afam]
      ,[student]
      ,[worker]
      ,[education]
      ,[license]
      ,[race_aiak]
      ,[race_asian]
      ,[race_hapi]
      ,[race_hisp]
      ,[race_white]
      ,[race_other]
      ,[race_noanswer]
      ,[industry]
       FROM [hhts_cleaning].[dbo].[hts_person]")
persons = read.dt(sql.query2, 'sqlquery')

sql.query3 = paste("SELECT [hhincome_detailed]
      ,[hhid]
      ,[vehicle_count]
      ,[rent_own]
      ,[numchildren]
      ,[numworkers]
      ,[hhsize]
      ,[final_home_tract]
      ,[reported_lat]
      ,[reported_lng] FROM [hhts_cleaning].[dbo].[hts_hh]")
hhs = read.dt(sql.query3, 'sqlquery')



#Merge age, race, and income data to trips dataset
df<-merge(trips,persons, by = "personid", all.x = T, all.y = F)
df_raw<-merge(df,hhs, by = "hhid", all.x = T, all.y = F)

# Remove datasets that are no longer needed
remove(trips,persons,hhs)
```

```{r, message=FALSE}
## Changing labels
df_cleaned$mode_1<-ifelse(df_cleaned$mode_1 == 1,"Walk",(ifelse(df_cleaned$mode_1 == 2, "Bike",ifelse(df_cleaned$mode_1 %in%  c(3:16,33,34), "Car",ifelse(df_cleaned$mode_1 %in% c(21,22,26,32,36,37), "Other","Transit")))))


df_raw$mode_1<-ifelse(df_raw$mode_1 == 1,"Walk",(ifelse(df_raw$mode_1 == 2, "Bike",ifelse(df_raw$mode_1 %in%  c(3:16,33,34), "Car",ifelse(df_raw$mode_1  %in% c(21,22,26,32,36,37), "Other","Transit")))))


df_cleaned$age <- dplyr::recode(df_cleaned$age, '1' = "Under 5 years old", '2' = "5-11 years", '3' = "12-15 years", '4' = "16-17 years", '5' = "18-24 years", '6' = "25-34 years", '7' = "35-44 years", '8' = "45-54 years", '9' = "55-64 years", '10' = "65-74 years", '11' = "75-84 years", '12' = "85 years or older")

df_raw$age <- dplyr::recode_factor(df_raw$age, '1' = "Under 5 years old", '2' = "5-11 years", '3' = "12-15 years", '4' = "16-17 years", '5' = "18-24 years", '6' = "25-34 years", '7' = "35-44 years", '8' = "45-54 years", '9' = "55-64 years", '10' = "65-74 years", '11' = "75-84 years", '12' = "85 years or older")

#df_cleaned$age <- ordered(df_cleaned$age, levels = c("Under 5 years old", "5-11 years", "12-15 years", "16-17 years", "18-24 years", "25-34 years", "35-44 years", "45-54 years", "55-64 years",  "65-74 years", "75-84 years", "85 years or older"))

#df_raw$age <- ordered(df_raw$age, levels = c("Under 5 years old", "5-11 years", "12-15 years", "16-17 years", "18-24 years", "25-34 years", "35-44 years", "45-54 years", "55-64 years",  "65-74 years", "75-84 years", "85 years or older"))

df_cleaned$age_group <- dplyr::recode(df_cleaned$age, "16-17 years" = "Under 25 years old", "18-24 years" = "Under 25 years old", "25-34 years" = "25-44 years", "35-44 years" = "25-44 years", "45-54 years" = "45-64 years", "55-64 years" = "45-64 years", "65-74 years" = "65 years or older", "75-84 years" = "65 years or older", "85 or years older" = "65 years or older")

df_raw$age_group <- dplyr::recode_factor(df_raw$age, "16-17 years" = "Under 25 years old", "18-24 years" = "Under 25 years old", "25-34 years" = "25-44 years", "35-44 years" = "25-44 years", "45-54 years" = "45-64 years", "55-64 years" = "45-64 years", "65-74 years" = "65 years or older", "75-84 years" = "65 years or older", "85 or years older" = "65 years or older")

df_cleaned$age_group <- ordered(df_cleaned$age_group, levels = c("Under 25 years old", "25-44 years", "45-64 years", "65 years or older"))

df_raw$age_group <- ordered(df_raw$age_group, levels = c("Under 25 years old", "25-44 years", "45-64 years", "65 years or older"))

df_cleaned$gender <- dplyr::recode(df_cleaned$gender, "1" = "Male", "2" = "Female", "3" = "Another", "4" = "Not listed here", "5" = "Non-Binary")

df_raw$gender <- dplyr::recode(df_raw$gender, "1" = "Male", "2" = "Female", "3" = "Another", "4" = "Not listed here", "5" = "Non-Binary")


df_cleaned$hhincome_detailed <- dplyr::recode(df_cleaned$hhincome_detailed,	"1" = "Under $75,000",
	"2" =	"Under $75,000", "3" = "Under $75,000", "4" = "Under $75,000", "5" = "Under $75,000", "6" = "Over $75,000",
	"7" = "Over $75,000", "8" = "Over $75,000", "9" = "Over $75,000", "10" = "Over $75,000","11" = "Prefer not to answer")

df_raw$hhincome_detailed <- dplyr::recode(df_raw$hhincome_detailed,	"1" = "Under $75,000",
	"2" =	"Under $75,000", "3" = "Under $75,000", "4" = "Under $75,000", "5" = "Under $75,000", "6" = "Over $75,000",
	"7" = "Over $75,000", "8" = "Over $75,000", "9" = "Over $75,000", "10" = "Over $75,000","11" = "Prefer not to answer")

df_cleaned$hhincome_detailed <- ordered(df_cleaned$hhincome_detailed, levels = c("Under $75,000", "Over $75,000", "Prefer not to answer"))

df_raw$hhincome_detailed <- ordered(df_raw$hhincome_detailed, levels = c("Under $75,000", "Over $75,000", "Prefer not to answer"))

```

I extracted commute trips starting from home and ending at work/work related destination from cleaned and raw version of 2021 HHTS. For this analysis I only used one trip per person.

```{r, message=FALSE}

# Extracting commute trips for cleaned data
commute<-df_cleaned[(df_cleaned$dest_purpose == 10 | df_cleaned$dest_purpose == 11 | df_cleaned$dest_purpose == 14) & df_cleaned$origin_purpose == 1 & is.na(df_cleaned$dest_purpose_cat) == F & is.na(df_cleaned$origin_purpose_cat) == F,]

personids<-unique(commute$personid)

commute_sh <- commute[1,]
commute_sh[,] <- NA

for (i in personids){
  links <- commute[commute$personid == i,]
  
    if(any(links$dest_purpose_cat == 2)){
      n = min(links$tripnum[which(links$dest_purpose_cat == 2)])}
    else {
      n = min(links$tripnum)
    }
  commute_sh <- rbind(commute_sh,commute[which(commute$personid == i & commute$tripnum == n),])
}

commute_sh<-commute_sh[-1,]

commute_cleaned <- commute_sh[,!(names(commute_sh) %in% c("origin_name","dest_name","transit_systems","transit_lines","psrc_inserted","traveldate","depart_time_timestamp","arrival_time_timestamp"))]
#Save data to local folder
#write.csv(commute_cleaned,"home to work trips cleaned.csv",row.names = FALSE)
```


```{r, message=FALSE}
# Extracting non commute trips for cleaned data
ncommute<-df_cleaned[(df_cleaned$dest_purpose != 10 & df_cleaned$dest_purpose != 11 & df_cleaned$dest_purpose != 14) & is.na(df_cleaned$dest_purpose_cat) == F & is.na(df_cleaned$origin_purpose_cat) == F,]

ncommute_cleaned <- ncommute[,!(names(ncommute) %in% c("origin_name","dest_name","transit_systems","transit_lines","psrc_inserted","traveldate","depart_time_timestamp","arrival_time_timestamp"))]

#Save data to local folder
#write.csv(ncommute_cleaned,"Non-commute trips cleaned.csv",row.names = FALSE)
```

```{r, message=FALSE}
# Extracting commute trips for raw data

commute<-df_raw[(df_raw$dest_purpose == 10 | df_raw$dest_purpose == 11 | df_raw$dest_purpose == 14) & df_raw$origin_purpose == 1 & is.na(df_raw$dest_purpose_cat) == F & is.na(df_raw$origin_purpose_cat) == F,]


personids<-unique(commute$personid)

commute_sh <- commute[1,]
commute_sh[,] <- NA

for (i in personids){
  links <- commute[commute$personid == i,]
  
    if(any(links$dest_purpose_cat == 2)){
      n = min(links$tripnum[which(links$dest_purpose_cat == 2)])}
    else {
      n = min(links$tripnum)
    }
  commute_sh <- rbind(commute_sh,commute[which(commute$personid == i & commute$tripnum == n),])
}

commute_sh<-commute_sh[-1,]

commute_raw <- commute_sh[,!(names(commute_sh) %in% c("origin_name","dest_name","transit_systems","transit_lines","psrc_inserted","traveldate","depart_time_timestamp","arrival_time_timestamp"))]

#Save data to local folder
#write.csv(commute_raw,"home to work trips raw.csv",row.names = FALSE)
```


```{r, message=FALSE}

# Extracting non commute trips for raw data

ncommute<-df_raw[(df_raw$dest_purpose != 10 & df_raw$dest_purpose != 11 & df_raw$dest_purpose != 14) & is.na(df_raw$dest_purpose_cat) == F & is.na(df_raw$origin_purpose_cat) == F,]

ncommute_raw <- ncommute[,!(names(ncommute) %in% c("origin_name","dest_name","transit_systems","transit_lines","psrc_inserted","traveldate","depart_time_timestamp","arrival_time_timestamp"))]


#Save data to local folder
#write.csv(ncommute_raw,"Non-commute trips raw.csv",row.names = FALSE)
```


```{r, message=FALSE}

# Create dataframe for mlogit choice modeling 
choice_data_cleaned<-dfidx(commute_cleaned, shape = "wide", choice = c("mode_1"),idnames = c(NA, "alt"), idx = list(c("recid")))

choice_data_raw<-dfidx(commute_raw, shape = "wide", choice = c("mode_1"),idnames = c(NA, "alt"), idx = list(c("tripid")))

```

```{r, message=FALSE}
# Update destination purpose categories

ncommute_cleaned$dest_purpose_cats <- ifelse(ncommute_cleaned$dest_purpose == 1,	"Went home", ifelse(ncommute_cleaned$dest_purpose == 6, "Went to school/daycare", ifelse(ncommute_cleaned$dest_purpose == 9,	"Dropped off/picked up someone", ifelse(ncommute_cleaned$dest_purpose == 10, "Went to primary workplace", ifelse(ncommute_cleaned$dest_purpose == 11, "Went to work-related place", ifelse(ncommute_cleaned$dest_purpose == 14,	"Went to other work-related activity", ifelse(ncommute_cleaned$dest_purpose == 30,  "Went grocery shopping", ifelse(ncommute_cleaned$dest_purpose == 32, "Went to other shopping", ifelse(ncommute_cleaned$dest_purpose == 33,	"Conducted personal business", ifelse(ncommute_cleaned$dest_purpose == 34, "Went to medical appointment", ifelse(ncommute_cleaned$dest_purpose == 50, "Went to restaurant to eat/get take-out", ifelse(ncommute_cleaned$dest_purpose == 51,	"Went to exercise", ifelse(ncommute_cleaned$dest_purpose == 52, "Attended social event", ifelse(ncommute_cleaned$dest_purpose == 53, "Attended recreational event", ifelse(ncommute_cleaned$dest_purpose == 54, "Went to religious/community/volunteer activity", ifelse(ncommute_cleaned$dest_purpose == 55,	"Vacation/Traveling (rMove only)", ifelse(ncommute_cleaned$dest_purpose == 56, "Went to a family activity", ifelse(ncommute_cleaned$dest_purpose == 60, "Transferred to another mode of transportation", ifelse(ncommute_cleaned$dest_purpose == 61, "Other appointment/errands (rMove only)", ifelse(ncommute_cleaned$dest_purpose == 62, "Other social/leisure (rMove only)", ifelse(ncommute_cleaned$dest_purpose == 97,	"Other purpose", "NA")))))))))))))))))))))

ncommute_raw$dest_purpose_cats <- ifelse(ncommute_raw$dest_purpose == 1,	"Went home", ifelse(ncommute_raw$dest_purpose == 6, "Went to school/daycare", ifelse(ncommute_raw$dest_purpose == 9,	"Dropped off/picked up someone", ifelse(ncommute_raw$dest_purpose == 10, "Went to primary workplace", ifelse(ncommute_raw$dest_purpose == 11, "Went to work-related place", ifelse(ncommute_raw$dest_purpose == 14,	"Went to other work-related activity", ifelse(ncommute_raw$dest_purpose == 30,  "Went grocery shopping", ifelse(ncommute_raw$dest_purpose == 32, "Went to other shopping", ifelse(ncommute_raw$dest_purpose == 33,	"Conducted personal business", ifelse(ncommute_raw$dest_purpose == 34, "Went to medical appointment", ifelse(ncommute_raw$dest_purpose == 50, "Went to restaurant to eat/get take-out", ifelse(ncommute_raw$dest_purpose == 51,	"Went to exercise", ifelse(ncommute_raw$dest_purpose == 52, "Attended social event", ifelse(ncommute_raw$dest_purpose == 53, "Attended recreational event", ifelse(ncommute_raw$dest_purpose == 54, "Went to religious/community/volunteer activity", ifelse(ncommute_raw$dest_purpose == 55,	"Vacation/Traveling (rMove only)", ifelse(ncommute_raw$dest_purpose == 56, "Went to a family activity", ifelse(ncommute_raw$dest_purpose == 60, "Transferred to another mode of transportation", ifelse(ncommute_raw$dest_purpose == 61, "Other appointment/errands (rMove only)", ifelse(ncommute_raw$dest_purpose == 62, "Other social/leisure (rMove only)", ifelse(ncommute_raw$dest_purpose == 97,	"Other purpose", "NA")))))))))))))))))))))


ncommute_cleaned$dest_purpose_cat1 <- ifelse(ncommute_cleaned$dest_purpose_cat == 1 , "Home", ifelse(ncommute_cleaned$dest_purpose_cat == 2, "Work", ifelse(ncommute_cleaned$dest_purpose_cat == 3, "Work-related",  ifelse(ncommute_cleaned$dest_purpose_cat == 4, "School", ifelse(ncommute_cleaned$dest_purpose_cat == 5, "Escort",  ifelse(ncommute_cleaned$dest_purpose_cat == 6, "Shop", ifelse(ncommute_cleaned$dest_purpose_cat == 7, "Meal",  ifelse(ncommute_cleaned$dest_purpose_cat == 8, "Social/Recreation", ifelse(ncommute_cleaned$dest_purpose_cat == 9, "Errand/Other",  ifelse(ncommute_cleaned$dest_purpose_cat == 10, "Change mode","NA"))))))))))   

ncommute_raw$dest_purpose_cat1 <- ifelse(ncommute_raw$dest_purpose_cat == 1 , "Home", ifelse(ncommute_raw$dest_purpose_cat == 2, "Work", ifelse(ncommute_raw$dest_purpose_cat == 3, "Work-related", ifelse(ncommute_raw$dest_purpose_cat == 4, "School", ifelse(ncommute_raw$dest_purpose_cat == 5, "Escort",  ifelse(ncommute_raw$dest_purpose_cat == 6, "Shop", ifelse(ncommute_raw$dest_purpose_cat == 7, "Meal", ifelse(ncommute_raw$dest_purpose_cat == 8, "Social/Recreation", ifelse(ncommute_raw$dest_purpose_cat == 9, "Errand/Other",  ifelse(ncommute_raw$dest_purpose_cat == 10, "Change mode","NA"))))))))))       


ncommute_cleaned$dest_purpose_cat1 <- factor(ncommute_cleaned$dest_purpose_cat1, 
                                                     levels = c("Home", "School", "Escort", "Shop", "Meal",
                                                                "Social/Recreation", "Errand/Other","Change mode"))                                                                 

ncommute_raw$dest_purpose_cat1 <- factor(ncommute_raw$dest_purpose_cat1, 
                                                     levels = c("Home", "School", "Escort", "Shop", "Meal",
                                                                "Social/Recreation", "Errand/Other","Change mode"))     

choice_data_cleaned_ncommute<-dfidx(ncommute_cleaned, shape = "wide", choice = c("mode_1"),idnames = c(NA, "alt"), idx = list(c("recid")))

choice_data_raw_ncommute<-dfidx(ncommute_raw, shape = "wide", choice = c("mode_1"),idnames = c(NA, "alt"), idx = list(c("tripid")))


```
### 1.1 Vehicle count

Number of vehicles in the household is a significant variable for choosing car. Higher number of cars in the household it is more likely to choose car as a commute mode. This variable is significant in both models. _R^2^_ is slightly higher in the model with cleaned data.
```{r mylatextable_vehiclecount, results = "asis"}


commute_cleaned$vehicle_count_cat <- as.character(ifelse(commute_cleaned$vehicle_count >= 3, "3 or more", commute_cleaned$vehicle_count))
commute_raw$vehicle_count_cat <- as.character(ifelse(commute_raw$vehicle_count >= 3, "3 or more", commute_raw$vehicle_count))
   
  
mod_veh_cleaned <- commute_cleaned %>% count(mode_1, vehicle_count_cat, sort = TRUE)

mod_veh_raw <- commute_raw %>% count(mode_1, vehicle_count_cat, sort = TRUE)

mod_veh_sum <- merge(mod_veh_cleaned,mod_veh_raw, by = c("mode_1", "vehicle_count_cat"),all = T)

mod_veh_sum$n.x<- ifelse(is.na(mod_veh_sum$n.x),0,mod_veh_sum$n.x)

names(mod_veh_sum) <- c("Mode","Vehicle Count", "Cleand data","Raw data")

htmlTable(mod_veh_sum, caption = 'Number of Observations per Mode and Vehicle Count', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

m_cleaned <- mlogit(mode_1 ~  0| vehicle_count  | 0, choice_data_cleaned)

m_raw <- mlogit(mode_1 ~  0|vehicle_count | 0, choice_data_raw)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk"), digits = 2)

```
### 1.2 Trip distance
Trip distance is almost statistically significant for all modes except for transit relative bike. As distance increases, travelers are more likely to choose car or other modes and less likely to choose walking relative to biking. The effect of distance on choosing biking or transit is similar with no statistically significant difference. Two models are pretty close. We see that effect of distance on other modes is significant on 1 percent level in the model with raw data compared to 5 percent level in the model with cleaned data. _R^2^_ is slightly higher in the model with raw data.

```{r mylatextable_dist, results = "asis"}
dist_cleaned <- commute_cleaned %>% group_by(mode_1) %>%  summarise(
  N = n(), Mean = round(mean(trip_path_distance, na.rm = T),2), Median = round(median(trip_path_distance, na.rm = T),2), qs_0.25 = round(quantile(trip_path_distance, c(0.25), na.rm = T),2)[1], qs_0.75 = round(quantile(trip_path_distance, c(0.75), na.rm = T),2)[1],
    Max = max(trip_path_distance, na.rm = T),
    Min = min(trip_path_distance, na.rm = T)
  ) %>% mutate(
  Dataset = "Cleaned")

dist_raw <- commute_raw  %>% group_by(mode_1) %>% summarise(
  N = n(), Mean = round(mean(trip_path_distance, na.rm = T),2), Median = round(median(trip_path_distance, na.rm = T),2), qs_0.25 = round(quantile(trip_path_distance, c(0.25), na.rm = T),2)[1], qs_0.75 = round(quantile(trip_path_distance, c(0.75), na.rm = T),2)[1],
    Max = max(trip_path_distance, na.rm = T),
    Min = min(trip_path_distance, na.rm = T)
  ) %>% mutate(
  Dataset = "Raw")

dist_sum <- cbind(rbind(dist_cleaned,dist_raw))
dist_sum <- dist_sum[order(dist_sum [,"mode_1"] ),c(9,1:8)]


htmlTable(dist_sum, cgroup = 'Statistic', n.cgroup = 9, caption = 'Summary of Commute Distances', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

#stargazer(dist_sum, header=FALSE, type = "html", summary=FALSE, rownames = FALSE, digits = 2,  column.sep.width = "3pt", font.size = "small")

m_cleaned <- mlogit(mode_1 ~  0| trip_path_distance  | 0, choice_data_cleaned)

m_raw <- mlogit(mode_1 ~  0|trip_path_distance  | 0, choice_data_raw)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk"), digits = 2)


```
### 1.3 Age

None of the age groups are statistically significant in this model.
```{r mylatextable_ageonly, results = "asis"}
age1<-commute_cleaned %>% count(age) %>% group_by(age)
age2<-commute_raw %>% count(age) %>% group_by(age)
age_n <- merge(age1, age2, by="age", all=TRUE)

age_n$age <- ordered(age_n$age, levels = c("Under 5 years old", "5-11 years", "12-15 years", "16-17 years", "18-24 years", "25-34 years", "35-44 years", "45-54 years", "55-64 years",  "65-74 years", "75-84 years", "85 years or older"))
age_n<-age_n[order(age_n$age),]

age_n$n.x <- ifelse(is.na(age_n$n.x), 0, age_n$n.x )
names(age_n)<- c("Age", "n (cleaned data)", "n (raw data)")

htmlTable(age_n, caption = 'Number of Observations per Age group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')


age1<-commute_cleaned %>% count(mode_1, age)
age2<-commute_raw %>% count(mode_1, age)
age_n <- merge(age1, age2, by=c("mode_1","age"), all=TRUE)

age_n$age <- ordered(age_n$age, levels = c("Under 5 years old", "5-11 years", "12-15 years", "16-17 years", "18-24 years", "25-34 years", "35-44 years", "45-54 years", "55-64 years",  "65-74 years", "75-84 years", "85 years or older"))
age_n<-age_n[order(age_n$age),]

age_n$n.x <- ifelse(is.na(age_n$n.x), 0, age_n$n.x )

names(age_n)<- c("Mode","Age", "n (cleaned data)", "n (raw data)")


htmlTable(age_n, caption = 'Number of Observations per Mode and Age', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

m_cleaned <- mlogit(mode_1 ~  0| age | 0, choice_data_cleaned)


m_raw <- mlogit(mode_1 ~  0| age | 0, choice_data_raw)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk"), digits = 2)

```

### 1.4 Race

The only race category that is statistically significant is "other". People how identified their race as "other" are less likely to drive to work compared to other races and this is consistent in both models. In the raw data and cleaned data model, white travelers are less likely to use transit as their mode of commute.

```{r mylatextable_raceonly, results = "asis"}


race_cleaned<-rbind(c("African American or Black",length(commute_cleaned$race_afam[which(commute_cleaned$race_afam == 1)])),
            c("American Indian or Alaska Native",length(commute_cleaned$race_aiak[which(commute_cleaned$race_aiak == 1)])),
            c("Asian",length(commute_cleaned$race_asian[which(commute_cleaned$race_asian == 1)])),
            c("Native Hawaiian or Pacific Islander",length(commute_cleaned$race_hapi[which(commute_cleaned$race_hapi == 1)])),
            c("Hispanic",length(commute_cleaned$race_hisp[which(commute_cleaned$race_hisp == 1)])),
            c("White",length(commute_cleaned$race_white[which(commute_cleaned$race_white == 1)])),
            c("Other",length(commute_cleaned$race_other[which(commute_cleaned$race_other == 1)])),
            c("No answer",length(commute_cleaned$race_noanswer[which(commute_cleaned$race_noanswer == 1)])))

colnames(race_cleaned) <- c("Race","n")


race_raw<-rbind(c("African American or Black",length(commute_raw$race_afam[which(commute_raw$race_afam == 1)])),
            c("American Indian or Alaska Native",length(commute_raw$race_aiak[which(commute_raw$race_aiak == 1)])),
            c("Asian",length(commute_raw$race_asian[which(commute_raw$race_asian == 1)])),
            c("Native Hawaiian or Pacific Islander",length(commute_raw$race_hapi[which(commute_raw$race_hapi == 1)])),
            c("Hispanic",length(commute_raw$race_hisp[which(commute_raw$race_hisp == 1)])),
            c("White",length(commute_raw$race_white[which(commute_raw$race_white == 1)])),
            c("Other",length(commute_raw$race_other[which(commute_raw$race_other == 1)])),
            c("No answer",length(commute_raw$race_noanswer[which(commute_raw$race_noanswer == 1)])))

colnames(race_raw) <- c("Race", "n")

race_n <- merge(race_cleaned, race_raw, by="Race", all=TRUE)

names(race_n)<- c("Race", "n (cleaned data)", "n (raw data)")

htmlTable(race_n, caption = 'Number of Observations per Race group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')


race_cleaned <- commute_cleaned %>% count(mode_1, race_afam , race_aiak , race_asian , race_hapi , race_hisp , race_white , race_other,race_noanswer  )

race_cleaned$race<-paste0(ifelse(race_cleaned$race_afam == 1,"African American or Black,",''), ifelse(race_cleaned$race_aiak == 1,"American Indian or Alaska Native,",''),
                         ifelse(race_cleaned$race_asian == 1,"Asian,",''), ifelse(race_cleaned$race_hapi == 1,"Native Hawaiian or Pacific Islander,",''), 
                         ifelse(race_cleaned$race_hisp == 1,"Hispanic,",''), ifelse(race_cleaned$race_white == 1,"White,",''),ifelse(race_cleaned$race_other == 1,"Other,",''),
                         ifelse(race_cleaned$race_noanswer == 1 | (race_cleaned$race_afam !=1 & race_cleaned$race_aiak !=1 & race_cleaned$race_asian !=1 & race_cleaned$race_hapi !=1
                                                                   & race_cleaned$race_hisp !=1 & race_cleaned$race_white != 1 & race_cleaned$race_other != 1),"No answer,",''))

race_cleaned <- race_cleaned[,c(1,11,10)]

race_cleaned$n[race_cleaned$mode_1 == race_cleaned$mode_1[which(duplicated(race_cleaned[,c(1,2)]))] & race_cleaned$race == race_cleaned$race[which(duplicated(race_cleaned[,c(1,2)]))]]<-sum(race_cleaned$n[race_cleaned$mode_1 == race_cleaned$mode_1[which(duplicated(race_cleaned[,c(1,2)]))] & race_cleaned$race == race_cleaned$race[which(duplicated(race_cleaned[,c(1,2)]))]]  )

race_cleaned <-unique(race_cleaned)

race_raw <- commute_raw %>% count(mode_1, race_afam , race_aiak , race_asian , race_hapi , race_hisp , race_white , race_other,race_noanswer  )

race_raw$race<-paste0(ifelse(race_raw$race_afam == 1,"African American or Black,",''), ifelse(race_raw$race_aiak == 1,"American Indian or Alaska Native,",''),
                         ifelse(race_raw$race_asian == 1,"Asian,",''), ifelse(race_raw$race_hapi == 1,"Native Hawaiian or Pacific Islander,",''), 
                         ifelse(race_raw$race_hisp == 1,"Hispanic,",''), ifelse(race_raw$race_white == 1,"White,",''),ifelse(race_raw$race_other == 1,"Other,",''),
                         ifelse(race_raw$race_noanswer == 1 | (race_raw$race_afam !=1 & race_raw$race_aiak !=1 & race_raw$race_asian !=1 & race_raw$race_hapi !=1
                                                                   & race_raw$race_hisp !=1 & race_raw$race_white != 1 & race_raw$race_other != 1),"No answer,",''))

race_raw <- race_raw[,c(1,11,10)]

race_raw$n[race_raw$mode_1 == "Car" & race_raw$race == race_raw$race[which(duplicated(race_raw[,c(1,2)]))]]<-sum(race_raw$n[race_raw$mode_1 == "Car" & race_raw$race == race_raw$race[which(duplicated(race_raw[,c(1,2)]))]]  )


race_raw$n[race_raw$mode_1 == "Transit" & race_raw$race == race_raw$race[which(duplicated(race_raw[,c(1,2)]))]]<-sum(race_raw$n[race_raw$mode_1 == "Transit" & race_raw$race == race_raw$race[which(duplicated(race_raw[,c(1,2)]))]]  )

race_raw <-unique(race_raw)

race_n <- merge(race_cleaned, race_raw, by=c("mode_1","race"))

race_n$n.x <- ifelse(is.na(race_n$n.x), 0, race_n$n.x )
race_n$n.y <- ifelse(is.na(race_n$n.y), 0, race_n$n.y )

names(race_n)<- c("Mode","Race", "n (cleaned data)", "n (raw data)")

htmlTable(race_n, caption = 'Number of Observations per Mode and Race group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')


m_cleaned <- mlogit(mode_1 ~  0|  race_afam + race_aiak + race_asian + race_hapi + race_hisp + race_white + race_other | 0, choice_data_cleaned)

m_raw <- mlogit(mode_1 ~  0| race_afam + race_aiak + race_asian + race_hapi + race_hisp + race_white + race_other | 0, choice_data_raw)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk","African American or Black:Car", "African American or Black:Other", "African American or Black:Transit", "African American or Black:Walk", "American Indian or Alaska Native:Car", "American Indian or Alaska Native:Other", "American Indian or Alaska Native:Transit", "American Indian or Alaska Native:Walk", "Asian:Car", "Asian:Other", "Asian:Transit", "Asian:Walk", "Native Hawaiian or Pacific Islander:Car", "Native Hawaiian or Pacific Islander:Other", "Native Hawaiian or Pacific Islander:Transit", "Native Hawaiian or Pacific Islander:Walk", "Hispanic:Car",  "Hispanic:Other",  "Hispanic:Transit",  "Hispanic:Walk", "White:Car", "White:Other", "White:Transit", "White:Walk", "Other:Car", "Other:Other",  "Other:Transit",  "Other:Walk"), digits = 2)

```


### 1.5 Gender

Being male is statistically significant when choosing transit. Male are less likely to choose transit for commute relative to females. Observations for non-binary, another and unlisted were too few.

```{r mylatextable_genderonly, results = "asis"}
gen1<-commute_cleaned %>% count(gender) %>% group_by(gender)
gen2<-commute_raw %>% count(gender) %>% group_by(gender)
gen_n <- merge(gen1, gen2, by="gender", all=TRUE)

names(gen_n)<- c("Gender", "n (cleaned data)", "n (raw data)")
gen_n<-gen_n[order(gen_n$Gender),]

htmlTable(gen_n, caption = 'Number of Observations per Gender group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

gen1<-commute_cleaned %>% count(mode_1, gender)
gen2<-commute_raw %>% count(mode_1, gender)
gen_n <- merge(gen1, gen2, by=c("mode_1","gender"), all=TRUE)

gen_n$n.x <- ifelse(is.na(gen_n$n.x), 0, gen_n$n.x )

names(gen_n)<- c("Mode","Gender", "n (cleaned data)", "n (raw data)")

htmlTable(gen_n, caption = 'Number of Observations per Gender group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

choice_data_cleaned$male<-ifelse( choice_data_cleaned$gender == "Male", "Male","Non-Male")
choice_data_raw$male<-ifelse( choice_data_raw$gender == "Male", "Male","Non-Male")

choice_data_cleaned$male <- ordered(choice_data_cleaned$male, levels = c("Non-Male", "Male"))
choice_data_raw$male <- ordered(choice_data_raw$male, levels = c("Non-Male", "Male"))


m_cleaned <- mlogit(mode_1 ~  0| male | 0, choice_data_cleaned)

m_raw <- mlogit(mode_1 ~  0| male | 0, choice_data_raw)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk", "Male:Car", "Male:Other", "Male:Transit", "Male:Walk"), digits = 2)

```

### 1.6 Income

Tried several different category structures. None of them turned out as significant.


```{r mylatextable_incomeonly, results = "asis"}

inc1<-commute_cleaned %>% count(hhincome_detailed) %>% group_by(hhincome_detailed)
inc2<-commute_raw %>% count(hhincome_detailed) %>% group_by(hhincome_detailed)
inc_n <- merge(inc1, inc2, by="hhincome_detailed", all=TRUE)

names(inc_n)<- c("Income", "n (cleaned data)", "n (raw data)")
inc_n<-inc_n[order(inc_n$Income),]


#stargazer(inc_n,  type = "html", summary=FALSE, rownames = FALSE)

htmlTable(inc_n, caption = 'Income', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 13px 0px;')

m_cleaned <- mlogit(mode_1 ~  0| hhincome_detailed | 0, choice_data_cleaned)


m_raw <- mlogit(mode_1 ~  0| hhincome_detailed | 0, choice_data_raw)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk","Prefer not to answer:Car","Prefer not to answer:Other","Prefer not to answer:Transit","Prefer not to answer:Walk","Under $75,000:Car","Under $75,000:Other","Under $75,000:Transit","Under $75,000:Walk"), digits = 2)

```

### 1.7 Significant variables only

When I added dummy variables both for race white and other, none of them were significant. Therefore, I dropped other race and kept white dummy variable.
```{r, results = "asis"}

m_cleaned <- mlogit(mode_1 ~  0|male + trip_path_distance + vehicle_count + race_white | 0, choice_data_cleaned)

m_raw <- mlogit(mode_1 ~  0| male + trip_path_distance + vehicle_count + race_white | 0, choice_data_raw)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk", "Male:Car", "Male:Other", "Male:Transit", "Male:Walk", "Trip distance:Car", "Trip distance:Other", "Trip distance:Transit", "Trip distance:Walk", "Vehicle count:Car", "Vehicle count:Other", "Vehicle count:Transit", "Vehicle count:Walk", "White:Car", "White:Other", "White:Transit", "White:Walk"))

freq_cleaned<-as.data.frame(m_cleaned$freq/dim(commute_cleaned)[1])
freq_cleaned$Freq<-round(freq_cleaned$Freq,4)
predicted_freq_cleaned <- as.data.frame(round(apply(fitted(m_cleaned, outcome=FALSE), 2, mean),4))
predicted_freq_cleaned <- cbind(rownames(predicted_freq_cleaned),predicted_freq_cleaned)
colnames(predicted_freq_cleaned)<-colnames(freq_cleaned)
df_cleaned<-merge(freq_cleaned,predicted_freq_cleaned, by = "choice")
colnames(df_cleaned)<-c("Choice","Choice Frequency","Fitted Probability")
df_cleaned$change<-round((df_cleaned$`Fitted Probability`-df_cleaned$`Choice Frequency`)*100/df_cleaned$`Choice Frequency`,3)
colnames(df_cleaned)[4]<-"Change (%)"
htmlTable(df_cleaned, caption = 'Cleaned data model frequencies vs. probabilities', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding-left: 3.5em; padding-right: 3.5em;')


freq_raw<-as.data.frame(m_raw$freq/dim(commute_raw)[1])
freq_raw$Freq<-round(freq_raw$Freq,4)
predicted_freq_raw <- as.data.frame(round(apply(fitted(m_raw, outcome=FALSE), 2, mean),4))
predicted_freq_raw <- cbind(rownames(predicted_freq_raw),predicted_freq_raw)
colnames(predicted_freq_raw)<-colnames(freq_raw)
df_raw<-merge(freq_raw,predicted_freq_raw, by = "choice")
colnames(df_raw)<-c("Choice","Choice Frequency","Fitted Probability")
df_raw$change<-round((df_raw$`Fitted Probability`-df_raw$`Choice Frequency`)*100/df_raw$`Choice Frequency`,3)
colnames(df_raw)[4]<-"Change (%)"
htmlTable(df_raw, caption = 'Raw data model frequencies vs. probabilities', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding-left: 3.5em; padding-right: 3.5em;')


odd_ratios <- cbind(round(exp(coefficients(m_cleaned)),2),round(exp(coefficients(m_raw)),2))


colnames(odd_ratios) <- c("Cleand data","Raw data")
rownames(odd_ratios)[5:16] <- c("Male:Car","Male:Other","Male:Transit","Male:Walk", "Trip distance:Car", "Trip distance:Other", "Trip distance:Transit", "Trip distance:Walk", "Vehicle count:Car", "Vehicle count:Other", "Vehicle count:Transit", "Vehicle count:Walk")
rownames(odd_ratios)[17:20] <- c("White:Car","White:Other","White:Transit","White:Walk")

htmlTable(odd_ratios, caption = 'Odd Ratios', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')
```

## 2. Non-commute Mode Choice Model


### 2.1 Vehicle count

Number of vehicles in the household is a significant variable for choosing car, transit, and other mode relative to bike. Higher number of cars in the household increases the likelihood of choosing choose car and decreases the likelihood of choosing transit and other modes as a non-commute mode. This variable is significant in both models.
```{r mylatextable_vehiclecount_cn, results = "asis"}

ncommute_cleaned$vehicle_count_cat <- as.character(ifelse(ncommute_cleaned$vehicle_count >= 3, "3 or more", ncommute_cleaned$vehicle_count))
ncommute_raw$vehicle_count_cat <- as.character(ifelse(ncommute_raw$vehicle_count >= 3, "3 or more", ncommute_raw$vehicle_count))
   
  
mod_veh_cleaned <- ncommute_cleaned %>% count(mode_1, vehicle_count_cat, sort = TRUE)

mod_veh_raw <- ncommute_raw %>% count(mode_1, vehicle_count_cat, sort = TRUE)

mod_veh_sum <- merge(mod_veh_cleaned,mod_veh_raw, by = c("mode_1", "vehicle_count_cat"),all = T)

mod_veh_sum$n.x<- ifelse(is.na(mod_veh_sum$n.x),0,mod_veh_sum$n.x)

names(mod_veh_sum) <- c("Mode","Vehicle Count", "Cleand data","Raw data")

htmlTable(mod_veh_sum, caption = 'Trip Mode vs. Household Vehicle Count', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

m_cleaned <- mlogit(mode_1 ~  0| vehicle_count  | 0, choice_data_cleaned_ncommute)

m_raw <- mlogit(mode_1 ~  0|vehicle_count | 0, choice_data_raw_ncommute)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk"), digits = 2)

```


### 2.2 Trip distance
Trip distance is statistically significant for all modes relative to bike. As distance increases, travelers are more likely to choose car, transit or other modes and less likely to choose walking relative to biking. _R^2^_ is slightly higher in the model with raw data.

```{r mylatextable_dist_cn, results = "asis"}
dist_cleaned <- ncommute_cleaned %>% group_by(mode_1) %>%  summarise(
  N = n(), Mean = round(mean(trip_path_distance, na.rm = T),2), Median = round(median(trip_path_distance, na.rm = T),2), qs_0.25 = round(quantile(trip_path_distance, 0.25, na.rm = T),2)[1], qs_0.75 = round(quantile(trip_path_distance, c(0.75), na.rm = T),2)[1],
    Max = max(trip_path_distance, na.rm = T),
    Min = min(trip_path_distance, na.rm = T)
  ) %>% mutate(
  Dataset = "Cleaned")

dist_raw <- ncommute_raw  %>% group_by(mode_1) %>%  summarise(
  N = n(), Mean = round(mean(trip_path_distance, na.rm = T),2), Median = round(median(trip_path_distance, na.rm = T),2), qs_0.25 = round(quantile(trip_path_distance, 0.25, na.rm = T),2)[1], qs_0.75 = round(quantile(trip_path_distance, c(0.75), na.rm = T),2)[1],
    Max = max(trip_path_distance, na.rm = T),
    Min = min(trip_path_distance, na.rm = T)
  ) %>% mutate(
  Dataset = "Raw")


dist_sum <- cbind(rbind(dist_cleaned,dist_raw))
dist_sum <- dist_sum[order(dist_sum [,"mode_1"] ),c(9,1:8)]


htmlTable(dist_sum, cgroup = 'Statistic', n.cgroup = 9, caption = 'Summary of Non-commute Distances', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

#stargazer(dist_sum, header=FALSE, type = "html", summary=FALSE, rownames = FALSE, digits = 2,  column.sep.width = "3pt", font.size = "small")

m_cleaned <- mlogit(mode_1 ~  0| trip_path_distance  | 0, choice_data_cleaned_ncommute)

m_raw <- mlogit(mode_1 ~  0|trip_path_distance  | 0, choice_data_raw_ncommute)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk"), digits = 2)


```
### 2.3 Age

None of the age groups are statistically significant in this model.
```{r mylatextable_ageonly_cn, results = "asis"}
age1<-ncommute_cleaned %>% count(age) %>% group_by(age)
age2<-ncommute_raw %>% count(age) %>% group_by(age)
age_n <- merge(age1, age2, by="age", all=TRUE)

age_n$n.x <- ifelse(is.na(age_n$n.x), 0, age_n$n.x )

names(age_n)<- c("Age", "n (cleaned data)", "n (raw data)")

htmlTable(age_n, caption = 'Number of Observations per Age group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

age1<-ncommute_cleaned %>% count(mode_1, age)
age2<-ncommute_raw %>% count(mode_1, age)
age_n <- merge(age1, age2, by=c("mode_1","age"), all=TRUE)

age_n$n.x <- ifelse(is.na(age_n$n.x), 0, age_n$n.x )

names(age_n)<- c("Mode","Age", "n (cleaned data)", "n (raw data)")

htmlTable(age_n, caption = 'Number of Observations per Mode and Age group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')


m_cleaned <- mlogit(mode_1 ~  0| age | 0, choice_data_cleaned_ncommute)


m_raw <- mlogit(mode_1 ~  0| age | 0, choice_data_raw_ncommute)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk"), digits = 2)

```

### 2.4 Race

Both Hispanics and Whites are less likely to choose car, walk, transit, and other modes relative to bike compared to non-Hispanics, and non-whites respectively.
```{r mylatextable_raceonly_cn, results = "asis"}


race_cleaned<-rbind(c("African American or Black",length(ncommute_cleaned$race_afam[which(ncommute_cleaned$race_afam == 1)])),
            c("American Indian or Alaska Native",length(ncommute_cleaned$race_aiak[which(ncommute_cleaned$race_aiak == 1)])),
            c("Asian",length(ncommute_cleaned$race_asian[which(ncommute_cleaned$race_asian == 1)])),
            c("Native Hawaiian or Pacific Islander",length(ncommute_cleaned$race_hapi[which(ncommute_cleaned$race_hapi == 1)])),
            c("Hispanic",length(ncommute_cleaned$race_hisp[which(ncommute_cleaned$race_hisp == 1)])),
            c("White",length(ncommute_cleaned$race_white[which(ncommute_cleaned$race_white == 1)])),
            c("Other",length(ncommute_cleaned$race_other[which(ncommute_cleaned$race_other == 1)])),
            c("No answer",length(ncommute_cleaned$race_noanswer[which(ncommute_cleaned$race_noanswer == 1)])))

colnames(race_cleaned) <- c("Race","n")


race_raw<-rbind(c("African American or Black",length(ncommute_raw$race_afam[which(ncommute_raw$race_afam == 1)])),
            c("American Indian or Alaska Native",length(ncommute_raw$race_aiak[which(ncommute_raw$race_aiak == 1)])),
            c("Asian",length(ncommute_raw$race_asian[which(ncommute_raw$race_asian == 1)])),
            c("Native Hawaiian or Pacific Islander",length(ncommute_raw$race_hapi[which(ncommute_raw$race_hapi == 1)])),
            c("Hispanic",length(ncommute_raw$race_hisp[which(ncommute_raw$race_hisp == 1)])),
            c("White",length(ncommute_raw$race_white[which(ncommute_raw$race_white == 1)])),
            c("Other",length(ncommute_raw$race_other[which(ncommute_raw$race_other == 1)])),
            c("No answer",length(ncommute_raw$race_noanswer[which(ncommute_raw$race_noanswer == 1)])))

colnames(race_raw) <- c("Race", "n")

race_n <- merge(race_cleaned, race_raw, by="Race", all=TRUE)

names(race_n)<- c("Race", "n (cleaned data)", "n (raw data)")

htmlTable(race_n, caption = 'Number of Observations per Race group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')


race_cleaned <- ncommute_cleaned %>% count(mode_1, race_afam , race_aiak , race_asian , race_hapi , race_hisp , race_white , race_other,race_noanswer  )

race_cleaned$race<-paste0(ifelse(race_cleaned$race_afam == 1,"African American or Black,",''), ifelse(race_cleaned$race_aiak == 1,"American Indian or Alaska Native,",''),
                         ifelse(race_cleaned$race_asian == 1,"Asian,",''), ifelse(race_cleaned$race_hapi == 1,"Native Hawaiian or Pacific Islander,",''), 
                         ifelse(race_cleaned$race_hisp == 1,"Hispanic,",''), ifelse(race_cleaned$race_white == 1,"White,",''),ifelse(race_cleaned$race_other == 1,"Other,",''),
                         ifelse(race_cleaned$race_noanswer == 1 | (race_cleaned$race_afam !=1 & race_cleaned$race_aiak !=1 & race_cleaned$race_asian !=1 & race_cleaned$race_hapi !=1
                                                                   & race_cleaned$race_hisp !=1 & race_cleaned$race_white != 1 & race_cleaned$race_other != 1),"No answer,",''))

race_cleaned <- race_cleaned[,c(1,11,10)]

race_cleaned$n[race_cleaned$mode_1 ==  "Car" & race_cleaned$race == race_cleaned$race[which(duplicated(race_cleaned[,c(1,2)]))]]<-sum(race_cleaned$n[race_cleaned$mode_1 ==  "Car" & race_cleaned$race == race_cleaned$race[which(duplicated(race_cleaned[,c(1,2)]))]]  )

race_cleaned$n[race_cleaned$mode_1 ==  "Walk" & race_cleaned$race == race_cleaned$race[which(duplicated(race_cleaned[,c(1,2)]))]]<-sum(race_cleaned$n[race_cleaned$mode_1 ==  "Walk" & race_cleaned$race == race_cleaned$race[which(duplicated(race_cleaned[,c(1,2)]))]]  )

race_cleaned$n[race_cleaned$mode_1 ==  "Transit" & race_cleaned$race == race_cleaned$race[which(duplicated(race_cleaned[,c(1,2)]))]]<-sum(race_cleaned$n[race_cleaned$mode_1 ==  "Transit" & race_cleaned$race == race_cleaned$race[which(duplicated(race_cleaned[,c(1,2)]))]]  )

race_cleaned$n[race_cleaned$mode_1 ==  "Other" & race_cleaned$race == race_cleaned$race[which(duplicated(race_cleaned[,c(1,2)]))]]<-sum(race_cleaned$n[race_cleaned$mode_1 ==  "Other" & race_cleaned$race == race_cleaned$race[which(duplicated(race_cleaned[,c(1,2)]))]]  )

race_cleaned <-unique(race_cleaned)

race_raw <- ncommute_raw %>% count(mode_1, race_afam , race_aiak , race_asian , race_hapi , race_hisp , race_white , race_other,race_noanswer  )

race_raw$race<-paste0(ifelse(race_raw$race_afam == 1,"African American or Black,",''), ifelse(race_raw$race_aiak == 1,"American Indian or Alaska Native,",''),
                         ifelse(race_raw$race_asian == 1,"Asian,",''), ifelse(race_raw$race_hapi == 1,"Native Hawaiian or Pacific Islander,",''), 
                         ifelse(race_raw$race_hisp == 1,"Hispanic,",''), ifelse(race_raw$race_white == 1,"White,",''),ifelse(race_raw$race_other == 1,"Other,",''),
                         ifelse(race_raw$race_noanswer == 1 | (race_raw$race_afam !=1 & race_raw$race_aiak !=1 & race_raw$race_asian !=1 & race_raw$race_hapi !=1
                                                                   & race_raw$race_hisp !=1 & race_raw$race_white != 1 & race_raw$race_other != 1),"No answer,",''))

race_raw <- race_raw[,c(1,11,10)]

race_raw$n[race_raw$mode_1 == "Car" & race_raw$race == race_raw$race[which(duplicated(race_raw[,c(1,2)]))]]<-sum(race_raw$n[race_raw$mode_1 == "Car" & race_raw$race == race_raw$race[which(duplicated(race_raw[,c(1,2)]))]]  )


race_raw$n[race_raw$mode_1 == "Transit" & race_raw$race == race_raw$race[which(duplicated(race_raw[,c(1,2)]))]]<-sum(race_raw$n[race_raw$mode_1 == "Transit" & race_raw$race == race_raw$race[which(duplicated(race_raw[,c(1,2)]))]]  )

race_raw$n[race_raw$mode_1 == "Walk" & race_raw$race == race_raw$race[which(duplicated(race_raw[,c(1,2)]))]]<-sum(race_raw$n[race_raw$mode_1 == "Transit" & race_raw$race == race_raw$race[which(duplicated(race_raw[,c(1,2)]))]]  )

race_raw <-unique(race_raw)

race_n <- merge(race_cleaned, race_raw, by=c("mode_1","race"))

race_n$n.x <- ifelse(is.na(race_n$n.x), 0, race_n$n.x )
race_n$n.y <- ifelse(is.na(race_n$n.y), 0, race_n$n.y )

names(race_n)<- c("Mode","Race", "n (cleaned data)", "n (raw data)")

htmlTable(race_n, caption = 'Number of Observations per Mode and Race group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

m_cleaned <- mlogit(mode_1 ~  0|  race_afam + race_aiak + race_asian + race_hapi + race_hisp + race_white + race_other | 0, choice_data_cleaned_ncommute)


m_raw <- mlogit(mode_1 ~  0| race_afam + race_aiak + race_asian + race_hapi + race_hisp + race_white + race_other | 0, choice_data_raw_ncommute)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk","African American or Black:Car", "African American or Black:Other", "African American or Black:Transit", "African American or Black:Walk", "American Indian or Alaska Native:Car", "American Indian or Alaska Native:Other", "American Indian or Alaska Native:Transit", "American Indian or Alaska Native:Walk", "Asian:Car", "Asian:Other", "Asian:Transit", "Asian:Walk", "Native Hawaiian or Pacific Islander:Car", "Native Hawaiian or Pacific Islander:Other", "Native Hawaiian or Pacific Islander:Transit", "Native Hawaiian or Pacific Islander:Walk", "Hispanic:Car",  "Hispanic:Other",  "Hispanic:Transit",  "Hispanic:Walk", "White:Car", "White:Other", "White:Transit", "White:Walk", "Other:Car", "Other:Other",  "Other:Transit",  "Other:Walk"), digits = 2)

```


### 2.5 Gender

Being male is statistically significant when choosing car, transit, walk and other relative bikes compared to bikes. Male are more likely to choose bikes for non-commute trips relative to females. Observations for non-binary, another and unlisted were too few.

```{r mylatextable_genderonly_cn, results = "asis"}
gen1<-ncommute_cleaned %>% count(gender) %>% group_by(gender)
gen2<-ncommute_raw %>% count(gender) %>% group_by(gender)
gen_n <- merge(gen1, gen2, by="gender", all=TRUE)

names(gen_n)<- c("Gender", "n (cleaned data)", "n (raw data)")
gen_n<-gen_n[order(gen_n$Gender),]

htmlTable(gen_n, caption = 'Number of Observations per Gender group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

gen1<-ncommute_cleaned %>% count(mode_1, gender)
gen2<-ncommute_raw %>% count(mode_1, gender)
gen_n <- merge(gen1, gen2, by=c("mode_1","gender"), all=TRUE)

gen_n$n.x <- ifelse(is.na(gen_n$n.x), 0, gen_n$n.x )

names(gen_n)<- c("Mode","Gender", "n (cleaned data)", "n (raw data)")

htmlTable(gen_n, caption = 'Number of Observations per Mode and Gender group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

choice_data_cleaned_ncommute$male<-ifelse( choice_data_cleaned_ncommute$gender == "Male", "Male","Non-Male")
choice_data_raw_ncommute$male<-ifelse( choice_data_raw_ncommute$gender == "Male", "Male","Non-Male")

choice_data_cleaned_ncommute$male <- ordered(choice_data_cleaned_ncommute$male, levels = c("Non-Male", "Male"))
choice_data_raw_ncommute$male <- ordered(choice_data_raw_ncommute$male, levels = c("Non-Male", "Male"))


m_cleaned <- mlogit(mode_1 ~  0| male | 0, choice_data_cleaned_ncommute)

m_raw <- mlogit(mode_1 ~  0| male | 0, choice_data_raw_ncommute)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk", "Male:Car", "Male:Other", "Male:Transit", "Male:Walk"), digits = 2)

```

### 2.6 Income

Households with income under \$75,000 are more likely to choose transit and other modes relative to bike compared to households with income higher than \$75,000.


```{r mylatextable_incomeonly_cn, results = "asis"}

inc1<-ncommute_cleaned %>% count(hhincome_detailed) %>% group_by(hhincome_detailed)
inc2<-ncommute_raw %>% count(hhincome_detailed) %>% group_by(hhincome_detailed)
inc_n <- merge(inc1, inc2, by="hhincome_detailed", all=TRUE)

names(inc_n)<- c("Income", "n (cleaned data)", "n (raw data)")
inc_n<-inc_n[order(inc_n$Income),]


#stargazer(inc_n,  type = "html", summary=FALSE, rownames = FALSE)

htmlTable(inc_n, caption = 'Income', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 13px 0px;')


inc1<-ncommute_cleaned %>% count(mode_1, hhincome_detailed) 
inc2<-ncommute_raw %>% count(mode_1, hhincome_detailed)
inc_n <- merge(inc1, inc2, by=c("mode_1","hhincome_detailed"), all=TRUE)

inc_n$n.x <- ifelse(is.na(inc_n$n.x), 0, inc_n$n.x )

names(inc_n)<- c("Income", "n (cleaned data)", "n (raw data)")
inc_n<-inc_n[order(inc_n$Income),]

htmlTable(inc_n, caption = 'Number of Obervations per Mode and Income group', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 13px 0px;')



m_cleaned <- mlogit(mode_1 ~  0| hhincome_detailed | 0, choice_data_cleaned_ncommute)


m_raw <- mlogit(mode_1 ~  0| hhincome_detailed | 0, choice_data_raw_ncommute)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk","Prefer not to answer:Car","Prefer not to answer:Other","Prefer not to answer:Transit","Prefer not to answer:Walk","Under $75,000:Car","Under $75,000:Other","Under $75,000:Transit","Under $75,000:Walk"), digits = 2)

```


### 2.7 Trip Purpose

Reference purpose category is "Home".

```{r mylatextable_purposeonly_cn, results = "asis"}
mod_dest_cleaned <- ncommute_cleaned %>% count(mode_1, dest_purpose_cat1, sort = TRUE)

mod_dest_raw <- ncommute_raw %>% count(mode_1, dest_purpose_cat1, sort = TRUE)

mod_dest_sum <- merge(mod_dest_cleaned,mod_dest_raw, by = c("mode_1", "dest_purpose_cat1"),all = T)

mod_dest_sum$n.x<- ifelse(is.na(mod_dest_sum$n.x),0,mod_dest_sum$n.x)
mod_dest_sum$n.y<- ifelse(is.na(mod_dest_sum$n.y),0,mod_dest_sum$n.y)

names(mod_dest_sum) <- c("Mode","Purpose", "Cleand data","Raw data")

htmlTable(mod_dest_sum, caption = 'Trip Mode vs. Trip Purpose', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')

m_cleaned <- mlogit(mode_1 ~  0| dest_purpose_cat1 | 0, choice_data_cleaned_ncommute)


m_raw <- mlogit(mode_1 ~  0| dest_purpose_cat1 | 0, choice_data_raw_ncommute)

# If model specification changes, covariate labels need to be updated

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk", "School:Car","School:Other","School:Transit","School:Walk","Escort:Car","Escort:Other","Escort:Transit","Escort:Walk", "Shop:Car","Shop:Other","Shop:Transit","Shop:Walk","Meal:Car","Meal:Other","Meal:Transit","Meal:Walk", "Social/Recreation:Car","Social/Recreation:Other","Social/Recreation:Transit","Social/Recreation:Walk", "Errand/Other:Car","Errand/Other:Other","Errand/Other:Transit","Errand/Other:Walk","Change mode:Car","Change mode:Other","Change mode:Transit","Change mode:Walk"), digits = 2)

```


### 2.8 Significant variables only


```{r, results = "asis"}

m_cleaned <- mlogit(mode_1 ~  0|male + trip_path_distance + vehicle_count + race_white + race_hisp | 0, choice_data_cleaned_ncommute)

m_raw <- mlogit(mode_1 ~  0| male + trip_path_distance + vehicle_count + race_white + race_hisp | 0, choice_data_raw_ncommute)

stargazer(m_cleaned, m_raw, title="Results", align=TRUE, type = "html", column.labels = c("Cleaned data", "Raw data"), style = "qje", covariate.labels = c("ASC:Car", "ASC:Other", "ASC:Transit", "ASC:Walk", "Male:Car", "Male:Other", "Male:Transit", "Male:Walk", "Trip distance:Car", "Trip distance:Other", "Trip distance:Transit", "Trip distance:Walk", "Vehicle count:Car", "Vehicle count:Other", "Vehicle count:Transit", "Vehicle count:Walk", "White:Car", "White:Other", "White:Transit", "White:Walk", "Hispanic:Car", "Hispanic:Other", "Hispanic:Transit", "Hispanic:Walk"))


freq_cleaned<-as.data.frame(m_cleaned$freq/dim(ncommute_cleaned)[1])
freq_cleaned$Freq<-round(freq_cleaned$Freq,4)
predicted_freq_cleaned <- as.data.frame(round(apply(fitted(m_cleaned, outcome=FALSE), 2, mean),4))
predicted_freq_cleaned <- cbind(rownames(predicted_freq_cleaned),predicted_freq_cleaned)
colnames(predicted_freq_cleaned)<-colnames(freq_cleaned)
df_cleaned<-merge(freq_cleaned,predicted_freq_cleaned, by = "choice")
colnames(df_cleaned)<-c("Choice","Choice Frequency","Fitted Probability")
df_cleaned$change<-round((df_cleaned$`Fitted Probability`-df_cleaned$`Choice Frequency`)*100/df_cleaned$`Choice Frequency`,3)
colnames(df_cleaned)[4]<-"Change (%)"
htmlTable(df_cleaned, caption = 'Cleaned data model frequencies vs. probabilities', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding-left: 3.5em; padding-right: 3.5em;')


freq_raw<-as.data.frame(m_raw$freq/dim(ncommute_raw)[1])
freq_raw$Freq<-round(freq_raw$Freq,4)
predicted_freq_raw <- as.data.frame(round(apply(fitted(m_raw, outcome=FALSE), 2, mean),4))
predicted_freq_raw <- cbind(rownames(predicted_freq_raw),predicted_freq_raw)
colnames(predicted_freq_raw)<-colnames(freq_raw)
df_raw<-merge(freq_raw,predicted_freq_raw, by = "choice")
colnames(df_raw)<-c("Choice","Choice Frequency","Fitted Probability")
df_raw$change<-round((df_raw$`Fitted Probability`-df_raw$`Choice Frequency`)*100/df_raw$`Choice Frequency`,3)
colnames(df_raw)[4]<-"Change (%)"
htmlTable(df_raw, caption = 'Raw data model frequencies vs. probabilities', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding-left: 3.5em; padding-right: 3.5em;')


odd_ratios <- cbind(round(exp(coefficients(m_cleaned)),2),round(exp(coefficients(m_raw)),2))


colnames(odd_ratios) <- c("Cleand data","Raw data")
rownames(odd_ratios)[5:16] <- c("Male:Car","Male:Other","Male:Transit","Male:Walk", "Trip distance:Car", "Trip distance:Other", "Trip distance:Transit", "Trip distance:Walk", "Vehicle count:Car", "Vehicle count:Other", "Vehicle count:Transit", "Vehicle count:Walk")
rownames(odd_ratios)[17:24] <- c("White:Car","White:Other","White:Transit","White:Walk","Hispanic:Car","Hispanic:Other","Hispanic:Transit","Hispanic:Walk")

htmlTable(odd_ratios, caption = 'Odd Ratios', rownames = FALSE,
          ## padding to cells: top side bottom
          css.cell = 'padding: 0px 10px 0px;')
```
