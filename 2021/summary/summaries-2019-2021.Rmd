---
title: "Summaries 2019 v 2021"
author: "Christy"
date: "4/21/2022"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r global, warning=FALSE, message=FALSE, echo=FALSE}
library(psrc.travelsurvey)
library(tidyverse)
library(ggiraph)

# global variables
survey_a <- list(survey = '2017_2019', label = '2017/2019')
# survey_a <- list(survey = '2019', label = '2019')
survey_b <- list(survey = '2021', label = '2021')

gridline.color <- '#ededed'
background.color <- 'white'

plot.source <- paste0('Source: ', survey_a$label,', ', survey_b$label, ' ', 'Household Travel Survey')
```


## Gender by Telecommute Frequency

Not quite apples-to-apples comparison because the question for `telecommute_freq` was different across years.

- 2019: How frequently do you telecommute?
  - includes 'per month' answers
- 2021: How frequently did you telecommute in the past week?

Values for `Gender` are also different across years. 2021 introduced 'Non-Binary' and combined 'Not listed here / prefer not to answer'.

- 2019: Female, Male, Prefer not to answer, Another
- 2021: Female, Male, Not listed here / prefer not to answer, Non-Binary

Exclude 'per month' responses from 2019 survey because of the small sample size.

```{r gender process, include=FALSE, eval=FALSE}

vars_01 <- c('sample_source', 'employment', 'jobs_count', 'employment_pre_covid', 'workplace', 'age_category', 'gender', 'worker', 'telecommute_freq')

# vars_01 <- c('sample_source', 'workplace', 'age_category', 'gender', 'worker', 'telecommute_freq')

# generate summary
wrkr_2021 <- get_hhts(survey = 2021, 
                      level = 'p', 
                      vars = vars_01) %>%
  filter(age_category != 'Under 18 years') %>% 
  filter(worker != 'No jobs') %>% 
  filter(!(workplace %in% c(str_subset(workplace, "^At\\shome.*"), str_subset(workplace, "^Drives.*"))))

gen_tc_freq_2021 <- hhts_count(wrkr_2021, group_vars = c('gender', 'telecommute_freq'))

# explore where workplace | telecommute_freq are NA
group_cols <- colnames(wrkr_2021)[!(colnames(wrkr_2021) %in% str_subset(colnames(wrkr_2021), '.*weight.*'))]

df_na <- wrkr_2021 %>% 
  distinct(across(group_cols)) %>% 
  filter(is.na(telecommute_freq) | is.na(workplace))
```

```{r gender, eval=TRUE}

vars_02 <- c('workplace', 'age_category', 'gender', 'worker', 'telecommute_freq')

# 2019: How frequently do you telecommute?
wrkr_2019 <- get_hhts(survey = survey_a$survey, 
                      level = 'p', 
                      vars = vars_02) %>%
  filter(age_category != 'Under 18 years') %>%
  filter(worker != 'No jobs') %>%
  filter(!(workplace %in% c(str_subset(workplace, "^At\\shome.*"), str_subset(workplace, "^Drives.*")))) %>% 
  mutate(tc_freq_group = case_when(telecommute_freq %in% c('1 day a week', '2 days a week') ~ '1-2 days',
                                   telecommute_freq %in% c('3 days a week', '4 days a week') ~ '3-4 days',
                                   telecommute_freq %in% c('5 days a week', '6-7 days a week') ~ '5+ days',
                                   telecommute_freq %in% c('Never', 'Not applicable') ~ 'Never / None',
                                   !is.na(telecommute_freq) ~ telecommute_freq)) %>% 
  mutate(tc_freq_group_simple = case_when(tc_freq_group %in% str_subset(unique(.data$tc_freq_group), '.*days$')~ 'Telecommuted at least once per week', 
                                          !is.na(tc_freq_group) ~ tc_freq_group)) %>% 
  mutate(gender_group = case_when(gender %in% c('Prefer not to answer', 'Another') ~ 'Prefer not to answer / Another',
                                  !is.na(gender) ~ gender)) %>% 
  filter(!(telecommute_freq %in% str_subset(unique(telecommute_freq), '.*month(ly)*$')))

# summarise 2019 and add telecommute frequency lookup
gen_tc_freq_2019 <- hhts_count(wrkr_2019, 
                               spec_wgt = 'hh_weight_2017_2019_v2021_adult',
                               group_vars = c('gender_group', 'tc_freq_group')) %>%
  mutate(period = survey_a$label)

gen_tc_freq_2019_simple <- hhts_count(wrkr_2019, 
                                      spec_wgt = 'hh_weight_2017_2019_v2021_adult',
                                      group_vars = c('gender_group', 'tc_freq_group_simple')) %>%
  mutate(period = survey_a$label) %>% 
  rename(tc_freq_group = tc_freq_group_simple)

# 2021: How frequently did you telecommute in the past week?
wrkr_2021 <- get_hhts(survey = survey_b$survey, 
                      level = 'p', 
                      vars = vars_02) %>%
  filter(age_category != 'Under 18 years') %>% 
  filter(worker != 'No jobs') %>% 
  filter(!(workplace %in% c(str_subset(workplace, "^At\\shome.*"), str_subset(workplace, "^Drives.*")))) %>% 
  drop_na(any_of(c('workplace', 'telecommute_freq'))) %>%
  mutate(tc_freq_group_simple = case_when(telecommute_freq %in% str_subset(unique(.data$telecommute_freq), '.*days$')~ 'Telecommuted at least once per week', 
                                          !is.na(telecommute_freq) ~ telecommute_freq)) %>% 
  mutate(gender_group = case_when(gender %in% c('Not listed here / prefer not to answer', 'Non-Binary') ~ 'Prefer not to answer / Another',
                                  !is.na(gender) ~ gender))

# summarise 2021
gen_tc_freq_2021 <- hhts_count(wrkr_2021, group_vars = c('gender_group', 'telecommute_freq')) %>% 
  mutate(period = survey_b$label) %>% 
  rename(tc_freq_group = telecommute_freq)

gen_tc_freq_2021_simple <- hhts_count(wrkr_2021, 
                                      spec_wgt = 'person_weight_2021_ABS_Panel_adult',
                                      group_vars = c('gender_group', 'tc_freq_group_simple')) %>% 
  mutate(period = survey_b$label) %>% 
  rename(tc_freq_group = tc_freq_group_simple)

# merge dfs
gen_tc_freq <- bind_rows(gen_tc_freq_2019, gen_tc_freq_2021) %>% 
  mutate(period = as.factor(period))

gen_tc_freq_simple <- bind_rows(gen_tc_freq_2019_simple, gen_tc_freq_2021_simple) %>% 
  mutate(period = as.factor(period))

## plot ----

plot.title <- 'Gender and Telecommute Frequency'
plot.subtitle <- 'Times per week'

plot.caption <- paste0(plot.source,"\n*Includes 'Non-Binary' responses but unable to report separately because of small sample size")
plot.facet.labels <- c('Female' = 'Female', 'Male' = 'Male', 'Prefer not to answer / Another' = 'Prefer not to answer / Another*')                       

df <- gen_tc_freq %>% 
  filter(tc_freq_group != 'Total') %>% 
  mutate(upper = share + share_moe,
         lower = share - share_moe)

df_simple <- gen_tc_freq_simple %>% 
  filter(tc_freq_group != 'Total') %>% 
  mutate(upper = share + share_moe,
         lower = share - share_moe,
         tc_freq_group = factor(tc_freq_group, levels = c('Telecommuted at least once per week', 'Never / None')))

```

```{r gender plot function}

gender_tcf <- function(table, hjust = .5, vjust = 1.2, angle = 45) {
  g <- ggplot(table,  
              aes(x = tc_freq_group, 
                  y = share, 
                  fill = period,
                  tooltip = paste0(tc_freq_group, ' ', period, ': ', round(share*100, 0), '%'))) +
    geom_col_interactive(position = position_dodge(width=.9)) +
    geom_linerange(aes(ymin = lower,
                       ymax = upper),
                   position = position_dodge(width=.9)) +
    scale_fill_brewer(palette = "Paired") +
    scale_y_continuous(labels = scales::label_percent()) +
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20)) +
    theme(axis.text.x = element_text(hjust = hjust,
                                     vjust = vjust,
                                     angle = angle,
                                     size = 6),
          axis.ticks.x = element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = 'bottom',
          legend.title = element_blank(),
          panel.background = element_rect(fill = background.color),
          panel.grid.major.y = element_line(color = gridline.color),
          panel.grid.minor.y = element_line(color = gridline.color),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          plot.caption = element_text(size=5)
          ) +
    labs(x = NULL,
         y = NULL,
         title = plot.title,
         subtitle = plot.subtitle,
         caption = plot.caption) +
    facet_wrap(vars(gender_group), labeller = labeller(gender_group = plot.facet.labels))
  
  girafe(ggobj = g)
}
```

```{r gender plot all}
gender_tcf(df, hjust = .5, vjust = 0, angle = 0)
```

```{r gender plot simple}
gender_tcf(df_simple, hjust = .5, vjust = 0, angle = 0)
```

- Telecommuting increased between 2019 and 2021 across all major gender groups, but more females are telecommuting at least once a week.

## Race Categories by Mode

```{r race, eval=TRUE}

# hh_race_category # combined_adult_weight
# mode_1 # Primary mode, combined_adult_trip_weight
# mode_simple

r_vars <- c('race_eth_broad', 'mode_simple')

# summarise 2019
r_m1_2019 <- get_hhts(survey = survey_a$survey,
                      level = 't',
                      vars = r_vars) %>% 
   mutate(race_eth_broad_group = case_when(!(race_eth_broad %in% c('White only, non-Hispanic/Latinx', 'No Answer', 'Under 18 years, not asked race')) ~ 'Persons of Color',
                                          !is.na(race_eth_broad) ~ race_eth_broad))

r_m1_sum_2019 <- hhts_count(r_m1_2019, 
                            group_vars = r_vars) %>% 
  mutate(period = survey_a$label)

r_m1_sum_2019_simple <- hhts_count(r_m1_2019, 
                            group_vars = c('race_eth_broad_group', 'mode_simple')) %>% 
  mutate(period = survey_a$label) %>% 
  rename(race_eth_broad = race_eth_broad_group)

r_m1_sum_2019_nodrive <- r_m1_2019 %>% 
  filter(is.na(mode_simple)|mode_simple != 'Drive') %>% 
  hhts_count(group_vars = r_vars) %>% 
  mutate(period = survey_a$label)

# summarise 2021
r_m1_2021 <- get_hhts(survey = survey_b$survey,
                      level = 't',
                      vars = r_vars) %>% 
   mutate(race_eth_broad_group = case_when(!(race_eth_broad %in% c('White only, non-Hispanic/Latinx', 'No Answer', 'Under 18 years, not asked race')) ~ 'Persons of Color',
                                          !is.na(race_eth_broad) ~ race_eth_broad))

r_m1_sum_2021 <- hhts_count(r_m1_2021, 
                           group_vars = r_vars) %>% 
  mutate(period = survey_b$label)

r_m1_sum_2021_simple <- hhts_count(r_m1_2021, 
                           group_vars = c('race_eth_broad_group', 'mode_simple')) %>% 
  mutate(period = survey_b$label) %>% 
  rename(race_eth_broad = race_eth_broad_group)

r_m1_sum_2021_nodrive <- r_m1_2021 %>% 
  filter(is.na(mode_simple)|mode_simple != 'Drive') %>% 
  hhts_count(r_m1_2021, 
             group_vars = r_vars) %>% 
  mutate(period = survey_b$label)

## plot ----

plot.title.rm <- 'Race/Ethnicity by Primary Mode of Transportation'

rm_df <- bind_rows(r_m1_sum_2019, r_m1_sum_2021) %>% 
  filter(is.na(mode_simple)|mode_simple != 'Total') %>% 
  mutate(upper = share + share_moe,
         lower = share - share_moe)

rm_df_simple <- bind_rows(r_m1_sum_2019_simple, r_m1_sum_2021_simple) %>% 
  filter(is.na(mode_simple)|mode_simple != 'Total') %>% 
  mutate(upper = share + share_moe,
         lower = share - share_moe,
         race_eth_broad = factor(race_eth_broad, levels = c('Persons of Color', 'White only, non-Hispanic/Latinx', 'No Answer')))

rm_df_nodrive <- bind_rows(r_m1_sum_2019_nodrive, r_m1_sum_2021_nodrive) %>% 
  filter(is.na(mode_simple)|mode_simple != 'Total') %>% 
  mutate(upper = share + share_moe,
         lower = share - share_moe)
```

```{r race plot function}
race_mode <- function(table, hjust = .5, vjust = 1.2, angle = 45, subtitle = NULL) {
  r <- ggplot(table,
              aes(x = mode_simple,
                  y = share,
                  fill = period,
                  tooltip = paste0(mode_simple, ' ', period, ': ', round(share*100, 0), '%')
              )) +
    geom_col_interactive(position = position_dodge(width=.9)) +
    geom_linerange(aes(ymin = lower,
                       ymax = upper),
                   position = position_dodge(width=.9)) +
    scale_fill_brewer(palette = "Paired") +
    scale_y_continuous(labels = scales::label_percent()) +
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20)) +
    theme(axis.text.x = element_text(hjust = hjust,
                                     vjust = vjust,
                                     angle = angle,
                                     size = 6),
          axis.ticks.x = element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = 'bottom',
          legend.title = element_blank(),
          panel.background = element_rect(fill = background.color),
          panel.grid.major.y = element_line(color = gridline.color),
          panel.grid.minor.y = element_line(color = gridline.color),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          plot.caption = element_text(size=5),
          strip.text = element_text(size = 7)
          ) +
    labs(x = NULL,
         y = NULL,
         subtitle = subtitle,
         title = plot.title.rm,
         caption = plot.source
         ) +
  facet_wrap(vars(race_eth_broad), labeller = labeller(race_eth_broad = label_wrap_gen(20)))
   
  girafe(ggobj = r)
}
```

```{r race plot all}
race_mode(rm_df, hjust = .5, vjust = .5, angle = 45)
```

```{r race plot simple}
race_mode(rm_df_simple)
```

```{r race plot no drive trips}
race_mode(rm_df_nodrive, hjust = .5, vjust = .5, angle = 45, subtitle = 'Excluding Driving Trips')
```

- Driving is the predominant primary mode of transportation across race and ethnicity.
- POC saw slightly more walking trips
- Black/African-American (non-Hispanic/Latinx) & Hispanic or Latinx had more driving trips while other groups saw decreases in driving between the two time periods.
- Transit trips for Asian (non-Hispanic/Latinx) dropped slightly while Black or African American (non-Hispanic/Latinx) saw a larger drop in transit trips.


## Detailed Household Income by Trip Path Distance 

```{r income process, eval=FALSE}
t_vars <- c('mode_1', 'trip_path_distance')
inc_dist_2019 <- get_hhts(dyear = 2019,
         level = 't',
         vars = t_vars)

t <- inc_dist_2019 %>% 
  filter(trip_path_distance > 200)

t2 <- inc_dist_2019 %>% 
  filter(mode_1 == "Airplane or helicopter")

```

```{r income, eval=TRUE}
# hhincome_detailed # abs_hh_weight
# trip_path_distance # Bing-estimated trip distance (miles), combined_adult_trip_weight

stat <- 'median'
tpd <- 100

i_vars <- c('mode_1', 'hhincome_detailed', 'trip_path_distance')
inc_levels <- c("Under $10,000" ,"$10,000-$24,999","$25,000-$34,999","$35,000-$49,999",
                "$50,000-$74,999", "$75,000-$99,999", "$100,000-$149,999", "$150,000-$199,999",
                "$200,000-$249,999", "$250,000 or more", "Prefer not to answer", "Total")

inc_dist_2019 <- get_hhts(survey = survey_a$survey,
         level = 't',
         vars = i_vars) %>% 
  filter(mode_1 != 'Airplane or helicopter') %>% 
  filter(trip_path_distance < tpd)

inc_dist_sum_2019 <- hhts_median(inc_dist_2019,
                                stat_var = 'trip_path_distance', # numeric variable (distance)
                                spec_wgt = 'trip_weight_2017_2019_v2021_adult',
                                group_vars = c('hhincome_detailed')) # category (income, race, gender)

id_19 <- inc_dist_sum_2019 %>% 
  rename(m = ends_with(stat), moe = ends_with('moe')) %>% 
  mutate(hhincome_detailed = factor(hhincome_detailed, levels = inc_levels),
         lower = m - moe,
         upper = m + moe,
         year = survey_a$label)

inc_dist_2021 <- get_hhts(survey = survey_b$survey,
         level = 't',
         vars = i_vars) %>% 
  filter(mode_1 != 'Airplane or helicopter') %>% 
  filter(trip_path_distance < tpd)

inc_dist_sum_2021 <- hhts_median(inc_dist_2021,
                                stat_var = 'trip_path_distance',
                                spec_wgt = 'trip_weight_2021_ABS_Panel_adult',
                                group_vars = c('hhincome_detailed'))

id_21 <- inc_dist_sum_2021 %>% 
  rename(m = ends_with(stat), moe = ends_with('moe')) %>% 
  mutate(hhincome_detailed = factor(hhincome_detailed, levels = inc_levels),
         lower = m - moe,
         upper = m + moe,
         year = survey_b$label)

## plot ----

plot.title.itpd <- paste('Detailed Household Income by', str_to_title(stat), 'Trip Path Distance')
plot.subtitle.itpd <- paste('Trips less than', tpd, 'miles')

id_1921 <- bind_rows(id_19, id_21) %>% 
  mutate(year = as.factor(year))



i <- ggplot(id_1921, aes(x = hhincome_detailed, 
                         y = m, 
                         fill = year,
                         tooltip = paste0(year, ": ", round(m, 1), ' miles'))) +
  geom_col_interactive(position = position_dodge(width=.9)) +
  geom_linerange(aes(ymin = lower,
                    ymax = upper),
                 position = position_dodge(width=.9)) +
  scale_fill_brewer(palette = "Paired") +
  scale_y_continuous(labels = scales::label_comma()) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   size = 6),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_blank(),
        legend.position = 'bottom',
        panel.background = element_rect(fill = background.color),
        panel.grid.major.y = element_line(color = gridline.color),
        panel.grid.minor.y = element_line(color = gridline.color),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.caption = element_text(size=5)) +
  labs(x = NULL,
       y = 'Miles',
       fill = NULL,
       title = plot.title.itpd,
       caption = plot.source,
       subtitle = plot.subtitle.itpd)

girafe(ggobj = i)

```

- Lower Household earnings ($34k and less) had trips with higher distances in 2021.
- Households with earnings between $35k and $150k or $200k+ saw a decrease in median trip distance.
