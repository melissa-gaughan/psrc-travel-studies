---
title: "Gender by Telecommute Frequency"
author: "Christy"
date: '2022-05-31'
output: html_document
---

## Gender by Telecommute Frequency

Not quite apples-to-apples comparison because the question for `telecommute_freq` was different across years.

- 2019: How frequently do you telecommute?
  - includes 'per month' answers
- 2021: How frequently did you telecommute in the past week?

Values for `Gender` are also different across years. 2021 introduced 'Non-Binary' and combined 'Not listed here / prefer not to answer'.

- 2019: Female, Male, Prefer not to answer, Another
- 2021: Female, Male, Not listed here / prefer not to answer, Non-Binary

Exclude 'per month' responses from 2019 survey because of the small sample size.

```{r get hhts function}

gender_tcf_get_hhts <- function(survey, level, vars) {
  if(survey == '2021') {
    wrkr <- get_hhts(survey = survey, 
                     level = level, 
                     vars = vars) %>%
      filter(age_category != 'Under 18 years') %>% 
      filter(worker != 'No jobs') %>% 
      filter(!(workplace %in% c(str_subset(workplace, "^At\\shome.*"), str_subset(workplace, "^Drives.*")))) %>% 
      drop_na(any_of(c('workplace', 'telecommute_freq'))) %>%
      mutate(tc_freq_group_simple = case_when(telecommute_freq %in% str_subset(unique(.data$telecommute_freq), '.*days$')~ 'Telecommuted at least once per week', 
                                              !is.na(telecommute_freq) ~ telecommute_freq)) %>% 
      mutate(gender_group = case_when(gender %in% c('Not listed here / prefer not to answer', 'Non-Binary') ~ 'Prefer not to answer / Another',
                                      !is.na(gender) ~ gender))
  } else {
    wrkr <- get_hhts(survey = survey, 
                     level = level, 
                     vars = vars) %>%
      filter(age_category != 'Under 18 years') %>%
      filter(worker != 'No jobs') %>%
      filter(!(workplace %in% c(str_subset(workplace, "^At\\shome.*"), str_subset(workplace, "^Drives.*")))) %>% 
      mutate(tc_freq_group = case_when(telecommute_freq %in% c('1 day a week', '2 days a week') ~ '1-2 days',
                                       telecommute_freq %in% c('3 days a week', '4 days a week') ~ '3-4 days',
                                       telecommute_freq %in% c('5 days a week', '6-7 days a week') ~ '5+ days',
                                       telecommute_freq %in% c('Never', 'Not applicable') ~ 'Never / None',
                                       !is.na(telecommute_freq) ~ telecommute_freq)) %>% 
      mutate(tc_freq_group_simple = case_when(tc_freq_group %in% str_subset(unique(.data$tc_freq_group), '.*days$')~ 'Telecommuted at least once per week', 
                                              !is.na(tc_freq_group) ~ tc_freq_group)) %>% 
      mutate(gender_group = case_when(gender %in% c('Prefer not to answer', 'Another') ~ 'Prefer not to answer / Another',
                                      !is.na(gender) ~ gender)) %>% 
      filter(!(telecommute_freq %in% str_subset(unique(telecommute_freq), '.*month(ly)*$')))
    
   
  }
}

```

```{r gender, eval=TRUE}

vars_02 <- c('workplace', 'age_category', 'gender', 'worker', 'telecommute_freq')

# 2017/2019: How frequently do you telecommute? ----
wrkr_1719 <- gender_tcf_get_hhts(survey_a$survey, 'p', vars_02)

# summarise 2017/2019 and add telecommute frequency lookup
gen_tc_freq_1719 <- hhts_count(wrkr_1719, 
                               spec_wgt = 'hh_weight_2017_2019_v2021_adult',
                               group_vars = c('gender_group', 'tc_freq_group')) %>%
  mutate(period = survey_a$label)

gen_tc_freq_1719_simple <- hhts_count(wrkr_1719, 
                                      spec_wgt = 'hh_weight_2017_2019_v2021_adult',
                                      group_vars = c('gender_group', 'tc_freq_group_simple')) %>%
  mutate(period = survey_a$label) %>% 
  rename(tc_freq_group = tc_freq_group_simple)

# 2021: How frequently did you telecommute in the past week? ----
wrkr_2021 <- gender_tcf_get_hhts(survey_b$survey, 'p', vars_02)

# summarise 2021
gen_tc_freq_2021 <- hhts_count(wrkr_2021, group_vars = c('gender_group', 'telecommute_freq')) %>% 
  mutate(period = survey_b$label) %>% 
  rename(tc_freq_group = telecommute_freq)

gen_tc_freq_2021_simple <- hhts_count(wrkr_2021, 
                                      spec_wgt = 'person_weight_2021_ABS_Panel_adult',
                                      group_vars = c('gender_group', 'tc_freq_group_simple')) %>% 
  mutate(period = survey_b$label) %>% 
  rename(tc_freq_group = tc_freq_group_simple)

# 2017 single-year ----
wrkr_2017 <- gender_tcf_get_hhts(survey_c$survey, 'p', vars_02)


# 2019 single-year ----
wrkr_2019 <- gender_tcf_get_hhts(survey_d$survey, 'p', vars_02)




# merge dfs ----
gen_tc_freq <- bind_rows(gen_tc_freq_1719, gen_tc_freq_2021) %>% 
  mutate(period = as.factor(period))

gen_tc_freq_simple <- bind_rows(gen_tc_freq_1719_simple, gen_tc_freq_2021_simple) %>% 
  mutate(period = as.factor(period))

## plot ----

plot.title <- 'Gender and Telecommute Frequency'
plot.subtitle <- 'Times per week'
# plot.source <- paste0('Source: ', survey_a$label,', ', survey_b$label, ' ', 'Household Travel Survey')
plot.caption <- paste0("\n*Includes 'Non-Binary' responses but unable to report separately because of small sample size")
plot.facet.labels <- c('Female' = 'Female', 'Male' = 'Male', 'Prefer not to answer / Another' = 'Prefer not to answer / Another*')                       

df <- gen_tc_freq %>% 
  filter(tc_freq_group != 'Total') %>% 
  mutate(upper = share + share_moe,
         lower = share - share_moe)

df_simple <- gen_tc_freq_simple %>% 
  filter(tc_freq_group != 'Total') %>% 
  mutate(upper = share + share_moe,
         lower = share - share_moe,
         tc_freq_group = factor(tc_freq_group, levels = c('Telecommuted at least once per week', 'Never / None')))

```

```{r gender plot function}

gender_tcf <- function(table, hjust = .5, vjust = 1.2, angle = 45) {
  g <- ggplot(table,  
              aes(x = tc_freq_group, 
                  y = share, 
                  fill = period,
                  tooltip = paste0(tc_freq_group, ' ', period, ': ', round(share*100, 0), '%'))) +
    geom_col_interactive(position = position_dodge(width=.9)) +
    geom_linerange(aes(ymin = lower,
                       ymax = upper),
                   position = position_dodge(width=.9)) +
    scale_fill_brewer(palette = "Paired") +
    scale_y_continuous(labels = scales::label_percent()) +
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20)) +
    theme(axis.text.x = element_text(hjust = hjust,
                                     vjust = vjust,
                                     angle = angle,
                                     size = 6),
          axis.ticks.x = element_blank(),
          axis.ticks.y = element_blank(),
          legend.position = 'bottom',
          legend.title = element_blank(),
          panel.background = element_rect(fill = background.color),
          panel.grid.major.y = element_line(color = gridline.color),
          panel.grid.minor.y = element_line(color = gridline.color),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          plot.caption = element_text(size=5)
          ) +
    labs(x = NULL,
         y = NULL,
         title = plot.title,
         subtitle = plot.subtitle,
         caption = plot.caption) +
    facet_wrap(vars(gender_group), labeller = labeller(gender_group = plot.facet.labels))
  
  girafe(ggobj = g)
}
```

```{r gender plot all}
gender_tcf(df, hjust = .5, vjust = 0, angle = 0)
```

```{r gender plot simple}
gender_tcf(df_simple, hjust = .5, vjust = 0, angle = 0)
```

- Telecommuting increased between 2019 and 2021 across all major gender groups, but more females are telecommuting at least once a week.
